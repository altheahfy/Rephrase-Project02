# èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ¯ **Stripeæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…**

### **1. åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

#### **å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**
```bash
npm install stripe express-session passport passport-local bcryptjs jsonwebtoken
npm install pg sequelize
npm install dotenv cors helmet express-rate-limit
```

#### **ç’°å¢ƒå¤‰æ•°è¨­å®š**
```javascript
// .env ãƒ•ã‚¡ã‚¤ãƒ«
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
DATABASE_URL=postgres://user:password@localhost:5432/rephrase_db
JWT_SECRET=your_jwt_secret_here
SESSION_SECRET=your_session_secret_here
```

### **2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«**

#### **User Model**
```javascript
// models/User.js
const { DataTypes } = require('sequelize');

module.exports = (sequelize) => {
  const User = sequelize.define('User', {
    id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      autoIncrement: true
    },
    email: {
      type: DataTypes.STRING,
      unique: true,
      allowNull: false
    },
    passwordHash: {
      type: DataTypes.STRING,
      allowNull: false
    },
    subscriptionPlan: {
      type: DataTypes.ENUM('free', 'basic', 'premium'),
      defaultValue: 'free'
    },
    subscriptionStatus: {
      type: DataTypes.ENUM('active', 'canceled', 'past_due'),
      defaultValue: 'active'
    },
    stripeCustomerId: {
      type: DataTypes.STRING,
      allowNull: true
    },
    subscriptionEndDate: {
      type: DataTypes.DATE,
      allowNull: true
    }
  });

  return User;
};
```

#### **Usage Model**
```javascript
// models/Usage.js
module.exports = (sequelize) => {
  const Usage = sequelize.define('Usage', {
    id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      autoIncrement: true
    },
    userId: {
      type: DataTypes.INTEGER,
      allowNull: false
    },
    actionType: {
      type: DataTypes.STRING,
      allowNull: false
    },
    usageDate: {
      type: DataTypes.DATEONLY,
      allowNull: false
    },
    usageCount: {
      type: DataTypes.INTEGER,
      defaultValue: 1
    }
  });

  return Usage;
};
```

### **3. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **

#### **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²API**
```javascript
// routes/auth.js
const express = require('express');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const { User } = require('../models');

const router = express.Router();

// æ–°è¦ç™»éŒ²
router.post('/signup', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
    const passwordHash = await bcrypt.hash(password, 12);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const user = await User.create({
      email,
      passwordHash,
      subscriptionPlan: 'free'
    });

    // JWTãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const token = jwt.sign(
      { userId: user.id },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    res.status(201).json({
      message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ',
      token,
      user: {
        id: user.id,
        email: user.email,
        subscriptionPlan: user.subscriptionPlan
      }
    });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// ãƒ­ã‚°ã‚¤ãƒ³
router.post('/signin', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    const user = await User.findOne({ where: { email } });
    if (!user) {
      return res.status(401).json({ error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™' });
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
    const isValidPassword = await bcrypt.compare(password, user.passwordHash);
    if (!isValidPassword) {
      return res.status(401).json({ error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™' });
    }

    // JWTãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const token = jwt.sign(
      { userId: user.id },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    res.json({
      message: 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ',
      token,
      user: {
        id: user.id,
        email: user.email,
        subscriptionPlan: user.subscriptionPlan,
        subscriptionStatus: user.subscriptionStatus
      }
    });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### **4. Stripeæ±ºæ¸ˆå®Ÿè£…**

#### **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ**
```javascript
// routes/subscription.js
const express = require('express');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);
const { User } = require('../models');
const { authenticateToken } = require('../middleware/auth');

const router = express.Router();

// ãƒ—ãƒ©ãƒ³å®šç¾©
const PLANS = {
  basic: {
    priceId: 'price_basic_monthly', // Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä½œæˆ
    amount: 980,
    name: 'ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒ—ãƒ©ãƒ³'
  },
  premium: {
    priceId: 'price_premium_monthly',
    amount: 1980,
    name: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³'
  }
};

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
router.post('/create-subscription', authenticateToken, async (req, res) => {
  try {
    const { planType, paymentMethodId } = req.body;
    const userId = req.user.userId;

    const user = await User.findByPk(userId);
    if (!user) {
      return res.status(404).json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    }

    let customerId = user.stripeCustomerId;

    // Stripeã‚«ã‚¹ã‚¿ãƒãƒ¼ä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰
    if (!customerId) {
      const customer = await stripe.customers.create({
        email: user.email,
        payment_method: paymentMethodId,
        invoice_settings: {
          default_payment_method: paymentMethodId,
        },
      });
      
      customerId = customer.id;
      await user.update({ stripeCustomerId: customerId });
    }

    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
    const subscription = await stripe.subscriptions.create({
      customer: customerId,
      items: [{ price: PLANS[planType].priceId }],
      payment_behavior: 'default_incomplete',
      expand: ['latest_invoice.payment_intent'],
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³æ›´æ–°
    await user.update({
      subscriptionPlan: planType,
      subscriptionStatus: 'active'
    });

    res.json({
      subscriptionId: subscription.id,
      clientSecret: subscription.latest_invoice.payment_intent.client_secret,
      message: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¾ã—ãŸ'
    });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è§£ç´„
router.post('/cancel-subscription', authenticateToken, async (req, res) => {
  try {
    const userId = req.user.userId;
    const user = await User.findByPk(userId);

    if (!user.stripeCustomerId) {
      return res.status(400).json({ error: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const subscriptions = await stripe.subscriptions.list({
      customer: user.stripeCustomerId,
      status: 'active',
    });

    if (subscriptions.data.length > 0) {
      // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è§£ç´„
      await stripe.subscriptions.del(subscriptions.data[0].id);
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
      await user.update({
        subscriptionPlan: 'free',
        subscriptionStatus: 'canceled'
      });
    }

    res.json({ message: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è§£ç´„ã—ã¾ã—ãŸ' });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

module.exports = router;
```

### **5. åˆ©ç”¨åˆ¶é™ã‚·ã‚¹ãƒ†ãƒ **

#### **åˆ©ç”¨å›æ•°ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**
```javascript
// middleware/usageLimit.js
const { User, Usage } = require('../models');
const { Op } = require('sequelize');

const USAGE_LIMITS = {
  free: 10,      // 1æ—¥10å›
  basic: 100,    // 1æ—¥100å›
  premium: -1    // ç„¡åˆ¶é™
};

const checkUsageLimit = async (req, res, next) => {
  try {
    const userId = req.user.userId;
    const today = new Date().toISOString().split('T')[0];

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    const user = await User.findByPk(userId);
    if (!user) {
      return res.status(404).json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    }

    const userPlan = user.subscriptionPlan;
    const dailyLimit = USAGE_LIMITS[userPlan];

    // ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (dailyLimit === -1) {
      return next();
    }

    // ä»Šæ—¥ã®åˆ©ç”¨å›æ•°ã‚’ç¢ºèª
    const todayUsage = await Usage.findOne({
      where: {
        userId,
        usageDate: today,
        actionType: 'example_practice'
      }
    });

    const currentUsage = todayUsage ? todayUsage.usageCount : 0;

    if (currentUsage >= dailyLimit) {
      return res.status(429).json({
        error: '1æ—¥ã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸ',
        currentUsage,
        dailyLimit,
        message: 'ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦åˆ¶é™ã‚’è§£é™¤ã—ã¦ãã ã•ã„'
      });
    }

    // åˆ©ç”¨å›æ•°ã‚’è¨˜éŒ²
    if (todayUsage) {
      await todayUsage.increment('usageCount');
    } else {
      await Usage.create({
        userId,
        actionType: 'example_practice',
        usageDate: today,
        usageCount: 1
      });
    }

    req.currentUsage = currentUsage + 1;
    req.dailyLimit = dailyLimit;
    next();
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

module.exports = { checkUsageLimit };
```

### **6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ**

#### **æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ **
```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div id="subscription-form">
        <h2>ãƒ—ãƒ©ãƒ³é¸æŠ</h2>
        <div class="plan-selection">
            <button onclick="selectPlan('basic')">ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ (980å††/æœˆ)</button>
            <button onclick="selectPlan('premium')">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  (1,980å††/æœˆ)</button>
        </div>
        
        <div id="payment-element">
            <!-- Stripeã®æ±ºæ¸ˆè¦ç´ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <button id="submit-payment" style="display:none;">
            ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        </button>
    </div>

    <script>
        const stripe = Stripe('pk_test_your_publishable_key');
        let elements;
        let selectedPlan;

        async function selectPlan(planType) {
            selectedPlan = planType;
            
            // æ±ºæ¸ˆè¦ç´ ã‚’åˆæœŸåŒ–
            elements = stripe.elements();
            const paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');
            
            document.getElementById('submit-payment').style.display = 'block';
        }

        document.getElementById('submit-payment').addEventListener('click', async () => {
            const {error, paymentMethod} = await stripe.createPaymentMethod({
                elements,
                params: {
                    type: 'card',
                }
            });

            if (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            // ã‚µãƒ¼ãƒãƒ¼ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆã‚’è¦æ±‚
            const response = await fetch('/api/subscription/create-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    planType: selectedPlan,
                    paymentMethodId: paymentMethod.id
                })
            });

            const result = await response.json();
            
            if (result.clientSecret) {
                // æ±ºæ¸ˆç¢ºèª
                const {error: confirmError} = await stripe.confirmPayment({
                    clientSecret: result.clientSecret,
                    elements,
                    confirmParams: {
                        return_url: window.location.origin + '/subscription-success'
                    }
                });

                if (confirmError) {
                    console.error('æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', confirmError);
                } else {
                    window.location.href = '/subscription-success';
                }
            }
        });
    </script>
</body>
</html>
```

---

## ğŸ¯ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**

### **1. ä»Šã™ãå®Ÿè¡Œ**
1. ã•ãã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆVPSå¥‘ç´„
2. Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
3. åŸºæœ¬çš„ãªNode.jsç’°å¢ƒæ§‹ç¯‰

### **2. ä»Šé€±ä¸­**
1. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»å®Ÿè£…
3. åŸºæœ¬çš„ãªèª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ä½œæˆ

### **3. æ¥é€±**
1. Stripeæ±ºæ¸ˆçµ±åˆ
2. åˆ©ç”¨åˆ¶é™ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
3. æœ¬æ ¼ãƒ†ã‚¹ãƒˆé–‹å§‹

**ğŸš€ å•†ç”¨åŒ–ã¸ã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ã‚‡ã†ï¼**
