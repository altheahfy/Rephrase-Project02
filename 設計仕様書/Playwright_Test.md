RephraseUI「私の代行テスト」設計指示書

（Playwright / E2E）

0. 目的（最重要）

本テスト群の目的は UIの一般的な動作確認ではない。
これまで人間（私）が修正後に必ず行っていた確認行為を、抽象化して自動化することである。

全組み合わせテストは不要

「例文」ではなく 構造・型・状態不変条件 を保証対象とする

DB → UI 表示系の 完全性・不変性 を確認する

本テストは
👉 「私の代行テスト」
👉 「UIの安全装置」
として機能することを求める。

1. テスト全体の思想
基本原則

ランダマイズの全組み合わせは追わない

DBが持つ構文的バリエーション（型）を1回以上UIに出現させる

ユーザーが設定した状態（非表示など）がUI操作で破壊されないことを保証する

2. 実装すべき4つのテスト（必須）
Test-1
DBに存在する全てのサブスロットが画面上に一度以上表示されるか
目的

DBに存在するサブスロット構造が、UI表示ロジック上で欠落していないことを保証する

**✅ 実装完了（2025-12-29）**

要件

DBを事前にスキャンし、存在する 全サブスロット種別（例：sub-s, sub-o1, sub-v, sub-c1 等） の集合を取得

Playwright上でランダマイズを複数回実行

DOMに実際に出現したサブスロット種別を収集

DB集合 ⊆ UI出現集合 が成立しなければ fail

**実装上の重要ポイント**

- **親スロット＋サブスロット種別の組み合わせ**で識別（例：`s-sub-s`, `o1-sub-v`）
- 単なる`sub-s`などの種別だけでは不十分（同じ種別が複数の親スロットに存在）
- コンテンツ検出は`.slot-phrase`または`.slot-text`の実際のテキストを確認
- タイムアウト5分、最大50回ランダマイズ

**テスト結果**
- DB内組み合わせ: **47種類**
- UI出現: **47/47種類（100%）**
- 必要ランダマイズ回数: **16回**（約2.3分）

注意

「例文」ではなく 構造型の存在確認

組み合わせ爆発は不要

出現しない構造があれば、それはUI欠陥とみなす

Test-2
イレギュラーな order が定義されている場合、UI表示順が order に従っているか
目的

DB側で定義された語順（order）が、UIで無視・正規化されていないことを保証する

要件

DBに標準順（m1sauxm2vc1o1o2c2m3）と異なる order が存在する例文を対象にする

UI上に表示されたスロット / サブスロットDOMを順序付き配列として取得

DBの order 配列と 完全一致 を検証

注意

「順序がそれっぽい」では不可

DOM上の実際の並び順を必ず検証する

data-attribute 等で slot type が取得できる設計を前提としてよい

Test-3
・DB調査。使用される可能性のあるサブスロットを把握
・ランダマイズを実施してそのサブスロットが表示されるのを待つ
・表示されたら制御パネルでそこの英語と日本語補助テキストを非表示
・トグルで開閉（Test４なら親スロットにある個別ランダマイズボタンをクリックしてランダマイズ実施）
・英語と日本語補助テキストが表示されてしまわないか確認
・これを可能性のある全サブスロットに対して実施

判定は isVisible() ではなく、
class / data-attribute / aria-hidden など 安定した状態指標 を使用

Test-4
・DB調査。使用される可能性のあるサブスロットを把握
・ランダマイズを実施してそのサブスロットが表示されるのを待つ
・表示されたら制御パネルでそこの英語と日本語補助テキストを非表示
・トグルで開閉（Test４なら親スロットにある個別ランダマイズボタンをクリックしてランダマイズ実施）
・英語と日本語補助テキストが表示されてしまわないか確認
・これを可能性のある全サブスロットに対して実施

注意

表示要素の差し替え・再生成による hiddenリセット事故 を検出することが目的

3. 実装上の注意（重要）

Playwrightは 「人間の操作の再現装置」

網羅性は テスト設計側の責任

テストは「賢く」「重くてよい」

実行時間より 検出力 を優先する

4. 優先順位

Test-3 / Test-4（hidden状態保持）【最優先・致命的バグ防止】

Test-2（order保証）

Test-1（DB構造カバレッジ）✅ 完了

5. 実装状況サマリ

| テスト | 目的 | 状態 | 備考 |
|--------|------|------|------|
| Test-1 | DB全サブスロットのUI出現確認 | ✅ 完了 | 47/47種類検出、16回ランダマイズ |
| Test-2 | イレギュラーorder順序保証 | ✅ 完了 | order定義通りの表示順を検証 |
| Test-3 | サブスロット開閉後のhidden状態保持 | 🔧 実装中 | - |
| Test-4 | 個別ランダマイズ後のhidden状態保持 | 🔧 実装中 | - |

6. ゴール定義

UI修正後に 人間が行っていた確認を、テストが肩代わりできる状態

「壊れていないか？」ではなく
「私ならOKを出すか？」を機械で判断できること

補足（Claudeへのメッセージ）

このテスト群は
一般的なUIテストではなく、設計思想の固定装置である。
過剰な最適化や軽量化は不要。
壊れたら必ず落ちることを最優先で実装してほしい。