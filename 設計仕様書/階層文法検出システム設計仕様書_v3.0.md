# Rephrase階層文法検出システム設計仕様書 v3.0
**作成日**: 2025年8月14日  
**更新内容**: V5正しいアプローチ設計・段階処理システム教訓統合  
**対象**: Rephrase複雑文対応システム（二重入れ子まで）

---

## 🎯 1. システム概要

### 1.1 目的
- **Rephrase設計範囲内**（二重入れ子まで）の複雑文を高精度で文法解析
- **既存高精度システム（83.3%）を活用**した段階的改善アプローチ
- **性能劣化を防ぎ**、確実な精度向上を実現

### 1.2 設計思想
**V5正しいアプローチ**: 既存システムの2段階適用による単純・確実な改善

```
Step 1: 既存システムで主節パターン検出（節をプレースホルダー化）
Step 2: 検出された節に既存システム再適用
```

### 1.3 対象文構造
- **分詞構文**: "Having finished the project, the student submitted it."
- **名詞節**: "I think that he is smart."
- **関係詞節**: "The book that she bought was expensive."
- **時間節**: "When the rain stopped, we went outside."

---

## 🏗️ 2. システム設計

### 2.1 アーキテクチャ概要
```
[入力文] → [Step1: 主節解析] → [Step2: 節内解析] → [結果統合]
           ↓                    ↓
      既存システム(83.3%)    既存システム(83.3%)
```

### 2.2 コンポーネント構成

#### 2.2.1 HierarchicalGrammarDetectorV5
```python
class HierarchicalGrammarDetectorV5:
    def __init__(self):
        self.base_detector = HierarchicalGrammarDetectorV4()  # 既存83.3%システム
        self.clause_patterns = {
            'that_clause': r'\bthat\s+[^,]+',
            'wh_clause': r'\b(what|who|which|where|when|how|why)\s+[^,]+',
            'participle_phrase': r'\b(having|being|walking|running|finished)\s+[^,]+',
            'temporal_clause': r'\b(when|while|before|after|since|until)\s+[^,]+'
        }
```

#### 2.2.2 処理フロー詳細

**Step 1: 主節パターン検出**
1. **節検出**: 正規表現による軽量な節識別
2. **プレースホルダー置換**: 
   - `that he is smart` → `[O1節]`
   - `having finished` → `[分詞句]`
   - `when rain stopped` → `[時間節]`
3. **既存システム適用**: `I think [O1節]` → SVO構造検出

**Step 2: 節内パターン検出**
1. **節前処理**: 接続詞除去・補完
   - `that he is smart` → `he is smart`
   - `having finished` → `I have finished`
2. **既存システム再適用**: 各節を独立文として解析

### 2.3 処理例
```
入力: "I think that he is smart."

Step1: 
  - 節検出: "that he is smart"
  - 主節解析: "I think [O1節]" → SVO構造
  
Step2:
  - 節前処理: "that he is smart" → "he is smart"  
  - 節解析: "he is smart" → SVC構造
  
結果: Main=SVO, Sub1=SVC (that節)
```

---

## 📊 3. 性能仕様

### 3.1 目標精度
- **既存システム維持**: 83.3%以上（単純文）
- **階層文改善目標**: 66.7% → 80%以上
- **処理時間**: 0.5秒以内

### 3.2 品質保証
- **性能劣化防止**: 既存システムをベースラインとして保持
- **段階的改善**: Step1→Step2で確実な向上
- **回帰テスト**: 各改修後に全パターンテスト実行

### 3.3 エラーハンドリング
```python
try:
    result = self.base_detector.detect_hierarchical_grammar(processed_clause)
    pattern = result.main_clause.grammatical_pattern
except Exception:
    pattern = self._get_fallback_pattern(clause_type)  # タイプ別フォールバック
```

---

## 🔧 4. 実装指針

### 4.1 開発原則
1. **既存システム活用**: 83.3%精度を絶対に劣化させない
2. **単純な設計**: 複雑な段階処理システムは採用しない
3. **確実な改善**: Step-by-stepで検証可能な向上

### 4.2 避けるべき設計
- ❌ **Stanza/spaCy統合**: オーバーエンジニアリング
- ❌ **複雑な境界検出**: 軽量な正規表現で十分
- ❌ **多段階処理**: 2段階で十分、それ以上は複雑化のみ

### 4.3 品質管理
- **ベンチマークテスト**: 従来システムとの比較必須
- **段階別検証**: Step1, Step2を独立してテスト
- **回帰防止**: 各改修でベースライン確認

---

## 📋 5. テスト設計

### 5.1 テストケース分類
```python
test_cases = {
    'simple': [  # ベースライン確認
        "The cat sat on the mat.",
        "Students study English very hard."
    ],
    'hierarchical': [  # 改善対象
        "I think that he is smart.",
        "Having finished the project, the student submitted it.",
        "The book that she bought was expensive."
    ]
}
```

### 5.2 成功指標
- **Simple文**: 100%維持
- **階層文**: 従来66.7% → 80%以上
- **処理時間**: 平均0.3秒以内

---

## 🚀 6. 実装計画

### Phase 1: V5基本実装
1. **HierarchicalGrammarDetectorV5**クラス作成
2. **節検出パターン**定義・テスト
3. **2段階処理ロジック**実装

### Phase 2: 精度改善
1. **前処理ロジック**最適化
2. **フォールバックパターン**調整
3. **エッジケース**対応

### Phase 3: 本格統合
1. **既存システム置き換え**
2. **性能ベンチマーク**確認
3. **本番展開**

---

## 📚 7. 教訓・知見

### 7.1 段階処理システムの教訓
- **複雑化による性能劣化**: Stanza/spaCy統合で40%に悪化
- **オーバーエンジニアリング**: 4段階処理は不要
- **診断の複雑さ**: デバッグが困難

### 7.2 正しいアプローチの発見
- **既存システム活用**: 83.3%をベースライン保持
- **単純な2段階**: Step1(主節) → Step2(節内)
- **軽量な節検出**: 正規表現で十分

### 7.3 設計指針
- **性能第一**: 精度向上が最優先
- **段階的改善**: 急激な変更は避ける
- **実証主義**: 理論より実測結果を重視

---

**文書管理**: 本仕様書はV5アプローチ実装完了まで継続更新
