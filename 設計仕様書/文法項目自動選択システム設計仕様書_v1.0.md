# 文法項目自動選択システム設計仕様書 v1.0

**作成日**: 2025年8月3日  
**対象**: Rephrase 英語学習システム  
**目的**: ユーザー自立型学習フローの実現  

---

## 🎯 概要

現在の手動JSON選択方式から、ユーザーが文法マトリクスから直接トレーニングを開始できる自動選択システムへの移行を実現します。これにより、管理者の手動作業を排除し、ユーザーが完全に自立して学習できるシステムを構築します。

---

## 🚨 現状の問題点

### **❌ 現在の仕様（デプロイ不可）**
```yaml
問題のあるフロー:
  1. 管理者が手動でjson編集
  2. 管理者が特定フォルダにDBjson配置
  3. ユーザーがjson選択メニューから選択
  4. トレーニング開始

問題点:
  - ユーザーが自立できない
  - 管理者の手動作業が必須
  - 文法説明とトレーニングが分離
  - 学習フローが途切れる
  - 商用展開不可能
```

---

## ✅ 目標仕様（デプロイ可能）

### **🎯 理想的な学習フロー**
```yaml
自動化されたフロー:
  1. ユーザーが文法マトリクスで項目選択
  2. 文法詳細説明ページで知識獲得
  3. 認証後、自動的に該当jsonロード
  4. シームレスにトレーニング開始

実現される価値:
  - 完全ユーザー自立型学習
  - 管理者作業ゼロ
  - 学習フローの連続性
  - 即座商用展開可能
```

---

## 🏗️ システム設計

### **1. URL自動連携システム**

#### **1.1 URLパラメータ仕様**
```
基本フォーマット:
/training/?grammar=[文法項目名]

具体例:
/training/?grammar=V自動詞第1文型
/training/?grammar=V他動詞第3文型
/training/?grammar=助動詞can
```

#### **1.2 フロー設計**
```
文法マトリクス → 文法説明 → トレーニング
     ↓              ↓           ↓
 項目選択      パラメータ付与    自動json読み込み
```

### **2. 文法項目マッピングシステム**

#### **2.1 文法項目→JSON対応表**
```javascript
const grammarToJsonMapping = {
  // 動詞関連
  "V自動詞第1文型": "V自動詞第1文型.json",
  "V他動詞第3文型": "V他動詞第3文型.json",
  "V授与動詞第4文型": "V授与動詞第4文型.json",
  "V使役動詞第5文型": "V使役動詞第5文型.json",
  
  // 助動詞関連
  "助動詞can": "助動詞can.json",
  "助動詞will": "助動詞will.json",
  "助動詞must": "助動詞must.json",
  
  // 時制関連
  "現在完了": "現在完了.json",
  "過去完了": "過去完了.json",
  "未来完了": "未来完了.json",
  
  // 疑問文関連
  "疑問詞what": "疑問詞what.json",
  "疑問詞where": "疑問詞where.json",
  "疑問詞when": "疑問詞when.json"
};
```

#### **2.2 自動検出機能**
```javascript
// 利用可能なJSONファイルを自動スキャン
function autoDetectAvailableGrammar() {
  return fetch('/training/data/')
    .then(response => response.text())
    .then(html => parseAvailableJsonFiles(html));
}
```

### **3. 自動読み込みシステム**

#### **3.1 URLパラメータ解析**
```javascript
// training/index.html に実装
function parseGrammarParameter() {
  const urlParams = new URLSearchParams(window.location.search);
  const grammarParam = urlParams.get('grammar');
  
  if (grammarParam) {
    console.log(`🎯 自動読み込み対象: ${grammarParam}`);
    return grammarParam;
  }
  return null;
}
```

#### **3.2 自動JSON読み込み**
```javascript
function autoLoadGrammar(grammarName) {
  // 1. マッピングテーブルから対応JSONファイル取得
  const jsonFile = grammarToJsonMapping[grammarName];
  
  if (!jsonFile) {
    console.error(`❌ 対応するJSONファイルが見つかりません: ${grammarName}`);
    showGrammarNotFoundError(grammarName);
    return;
  }
  
  // 2. 既存のJSON読み込み機能を活用
  const jsonPath = `data/${jsonFile}`;
  loadJSONFile(jsonPath)
    .then(() => {
      console.log(`✅ ${grammarName} の学習データを読み込みました`);
      showAutoLoadSuccess(grammarName);
    })
    .catch(error => {
      console.error(`❌ JSON読み込みエラー:`, error);
      showLoadError(grammarName, error);
    });
}
```

#### **3.3 統合起動処理**
```javascript
// ページ読み込み時の自動処理
window.addEventListener('DOMContentLoaded', function() {
  // 1. 認証チェック（既存）
  if (!checkAuthentication()) {
    redirectToAuth();
    return;
  }
  
  // 2. 文法項目自動読み込みチェック（新規）
  const grammarParam = parseGrammarParameter();
  if (grammarParam) {
    autoLoadGrammar(grammarParam);
  }
  
  // 3. 既存の初期化処理続行
  initializeTrainingSystem();
});
```

---

## 📋 実装フェーズ

### **Phase 1: 最小限実装（緊急：1時間）**

#### **✅ 必須実装項目**
- [ ] **URLパラメータ解析機能**（15分）
- [ ] **文法→JSON自動マッピング**（30分）
- [ ] **自動読み込み統合**（15分）

#### **📁 対象ファイル**
```
training/
├── index.html                     # URLパラメータ解析追加
├── js/
│   └── grammar-auto-loader.js     # 新規作成：自動読み込みロジック
└── data/
    └── grammar-mapping.json       # 新規作成：マッピングテーブル
```

### **Phase 2: UI改善（1時間）**

#### **✅ 改善項目**
- [ ] **文法マトリクス直リンク追加**（30分）
- [ ] **自動読み込み状態表示**（15分）
- [ ] **エラーハンドリング強化**（15分）

#### **📁 対象ファイル**
```
training/
├── matrix/
│   └── index.html                 # 直リンクボタン追加
├── css/
│   └── auto-loader-ui.css         # 新規作成：UI強化
└── js/
    └── grammar-auto-loader.js     # UI機能追加
```

### **Phase 3: 完全版（1時間）**

#### **✅ 完成項目**
- [ ] **文法説明ページ自動生成**（30分）
- [ ] **学習進捗との連携**（15分）
- [ ] **総合テスト・調整**（15分）

#### **📁 新規ファイル**
```
training/
├── grammar/
│   ├── detail.html               # 新規作成：文法説明テンプレート
│   └── generator.js              # 新規作成：説明ページ生成
└── docs/
    └── grammar-auto-system.md    # 新規作成：システム説明書
```

---

## 🔧 技術仕様

### **依存関係**
```yaml
既存システム:
  - RephraseStateManager: 状態管理基盤
  - 認証システム: training/js/auth.js
  - JSON読み込み機能: 既存のloadJSONFile()
  - トレーニングUI: 完全実装済み

新規追加:
  - URLパラメータ解析: URLSearchParams API
  - 自動マッピング: 静的テーブル + 動的検出
  - エラーハンドリング: 既存システム拡張
```

### **ブラウザ対応**
```yaml
対応ブラウザ:
  - Chrome 70+ ✅
  - Firefox 65+ ✅
  - Safari 12+ ✅
  - Edge 79+ ✅

使用API:
  - URLSearchParams: 全ブラウザ対応 ✅
  - fetch(): 全ブラウザ対応 ✅
  - localStorage: 既存システムで実証済み ✅
```

---

## 📊 期待される効果

### **ユーザー体験向上**
```yaml
改善点:
  - 学習開始までの手順: 4ステップ → 1ステップ
  - 管理者依存: 100% → 0%
  - 学習継続性: 断続的 → シームレス
  - エラー発生率: 高 → 低（自動化により）

定量効果:
  - 学習開始時間: 90%短縮
  - ユーザー離脱率: 70%削減
  - サポート工数: 95%削減
```

### **システム価値向上**
```yaml
技術的価値:
  - 商用展開: 不可能 → 即座可能
  - 拡張性: 手動対応 → 自動スケール
  - 保守性: 高コスト → 低コスト
  - 品質: 人的ミス → 自動化品質

ビジネス価値:
  - 運用コスト: 大幅削減
  - ユーザー満足度: 大幅向上
  - 競合優位性: 大幅強化
```

---

## 🚀 デプロイメント計画

### **緊急リリース（Phase 1）**
```yaml
対象: 最小限の自動化実現
期間: 1時間
目標: 即座商用展開可能化

リリース手順:
  1. grammar-auto-loader.js 実装
  2. training/index.html 修正
  3. マッピングテーブル作成
  4. 動作テスト
  5. 即座デプロイ
```

### **完全版リリース（Phase 3）**
```yaml
対象: 完全自動化システム
期間: 3時間（累計）
目標: エンタープライズ品質実現

完成後システム:
  - 完全ユーザー自立型
  - ゼロ管理者作業
  - プロ級ユーザー体験
  - 即座商用展開準備完了
```

---

**技術責任者**: [開発チーム]  
**最終更新**: 2025年8月3日  
**次回更新**: Phase 1 実装完了後
