# ç¾å®Ÿçš„ç§»è¡Œæˆ¦ç•¥ - Dual Track Approach
## ç†æƒ³ã¨ç¾å®Ÿã®æ®µéšçš„çµ±åˆè¨ˆç”»

**ä½œæˆæ—¥**: 2025å¹´9æœˆ3æ—¥  
**æˆ¦ç•¥**: ç¾å®Ÿçš„åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸæ®µéšçš„ç§»è¡Œ

---

## ğŸ”„ **Dual Track Strategy**

### **Track A: å®‰å®šç¨¼åƒä¿è¨¼ (ç¾å®Ÿè·¯ç·š)**
- `central_controller.py` ã‚’**å®‰å®šç‰ˆ**ã¨ã—ã¦ç¶­æŒ
- 88% (176/200) ã®æˆåŠŸç‡ã‚’æœ€ä½ä¿è¨¼ãƒ©ã‚¤ãƒ³
- ç·Šæ€¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

### **Track B: ç†æƒ³å®Ÿç¾é€²è¡Œ (é©æ–°è·¯ç·š)**  
- `true_central_controller.py` ã‚’æ®µéšçš„ã«æ©Ÿèƒ½å¼·åŒ–
- ç¾å®Ÿã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ä¸€ã¤ãšã¤åŸç†çš„ã«è§£æ±º
- æˆåŠŸç‡ãŒTrack Aã‚’ä¸Šå›ã£ãŸæ™‚ç‚¹ã§ä¸»ç³»çµ±ã«æ˜‡æ ¼

---

## ğŸ“Š **ç¾å®Ÿçš„èª²é¡Œã®å®Ÿæ…‹èª¿æŸ»**

### **Phase 0: å¤±æ•—ã‚±ãƒ¼ã‚¹è©³ç´°åˆ†æ**
ç¾åœ¨ã®88%æˆåŠŸç‡ = 24ã‚±ãƒ¼ã‚¹å¤±æ•—ã®çœŸå› ã‚’ç‰¹å®š

#### **Task 0.1: å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†é¡**
```python
# å¤±æ•—ä¾‹æ–‡ã®å‚¾å‘åˆ†æ
failure_patterns = {
    "spacy_limitation": [],      # spaCyè§£æé™ç•Œ
    "edge_case_grammar": [],     # ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ–‡æ³•
    "handler_gap": [],           # ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–“ã®éš™é–“
    "complex_nesting": []        # è¤‡é›‘ãªå…¥ã‚Œå­æ§‹é€ 
}
```

#### **Task 0.2: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç™ºç”Ÿç†ç”±ã®è§£æ˜**
- ãªãœ`ConditionalHandler`ã§ã¯è§£æ±ºã§ããªã‹ã£ãŸã®ã‹ï¼Ÿ
- spaCyè§£æã®é™ç•Œã¯ã©ã“ã‹ï¼Ÿ
- åŸç†çš„å‡¦ç†ã§å›é¿ä¸å¯èƒ½ãªæ§‹é€ ã¯ä½•ã‹ï¼Ÿ

---

## ğŸ›  **æ®µéšçš„çµ±åˆæˆ¦ç•¥**

### **Phase 1: ç¾å®Ÿå¯¾å¿œã®åŸç†åŒ–** (æ¨å®šå·¥æ•°: 4-6æ™‚é–“)

#### **Task 1.1: Case 151-155ã®åŸç†çš„å†å®Ÿè£…**
å„ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’åŸç†çš„å‡¦ç†ã«å¤‰æ›ï¼š

```python
# Before: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
if text.lower().startswith('imagine if'):
    return special_imagine_processing()

# After: åŸç†çš„å‡¦ç† + ç¾å®Ÿçš„è£œå¼·
class ConditionalHandler:
    def process(self, sentence):
        # 1. åŸç†çš„è§£æ
        result = self._analyze_conditional_structure(sentence)
        
        # 2. ç¾å®Ÿçš„è£œæ­£ (å¿…è¦ã«å¿œã˜ã¦)
        if not result['success']:
            result = self._handle_edge_cases(sentence)
        
        return result
    
    def _handle_edge_cases(self, sentence):
        """åŸç†çš„å‡¦ç†ã§è§£æ±ºå›°é›£ãªã‚±ãƒ¼ã‚¹ã®è£œå®Œ"""
        edge_patterns = self._load_edge_patterns()
        return self._pattern_match_fallback(sentence, edge_patterns)
```

#### **Task 1.2: æ®µéšçš„æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ **
```python
class DualTrackController:
    def process_sentence(self, sentence):
        # Track A: ç¾å®Ÿç‰ˆ
        result_a = central_controller.process(sentence)
        
        # Track B: ç†æƒ³ç‰ˆ
        result_b = true_central_controller.process(sentence)
        
        # æ¯”è¼ƒæ¤œè¨¼
        comparison = self._compare_results(result_a, result_b)
        
        # å“è³ªåˆ¤å®š
        if comparison['track_b_better']:
            return result_b
        else:
            return result_a
```

### **Phase 2: ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹åŸç†åŒ–** (æ¨å®šå·¥æ•°: 6-8æ™‚é–“)

#### **Task 2.1: spaCyè§£æé™ç•Œã®ç³»çµ±çš„å¯¾å‡¦**
```python
class AdvancedSpacyAnalyzer:
    def analyze_with_fallback(self, sentence):
        # 1. æ¨™æº–spaCyè§£æ
        doc = self.nlp(sentence)
        
        # 2. è§£æå“è³ªè©•ä¾¡
        quality = self._assess_parse_quality(doc)
        
        # 3. å“è³ªãŒä½ã„å ´åˆã®è£œå¼·è§£æ
        if quality < 0.8:
            doc = self._enhanced_parsing(sentence, doc)
        
        return doc
    
    def _enhanced_parsing(self, sentence, original_doc):
        """spaCyè§£æã®é™ç•Œã‚’è£œã†è¿½åŠ è§£æ"""
        # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°è£œå¼·
        # æ§‹æ–‡ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
        # æ–‡è„ˆä¾å­˜è§£æ
        pass
```

#### **Task 2.2: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–“å”èª¿ã®å¼·åŒ–**
```python
class HandlerCoordinator:
    def resolve_conflicts(self, handler_results):
        """è¤‡æ•°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®çµæœã‚’è³¢ãçµ±åˆ"""
        # 1. ä¿¡é ¼åº¦ãƒ™ãƒ¼ã‚¹çµ±åˆ
        # 2. æ–‡æ³•çš„å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        # 3. ç¾å®Ÿçš„è£œæ­£
        pass
```

### **Phase 3: å“è³ªé€†è»¢é”æˆ** (æ¨å®šå·¥æ•°: 4-6æ™‚é–“)

#### **Task 3.1: Track Bã®æˆåŠŸç‡å‘ä¸Š**
- 88% â†’ 92%ä»¥ä¸Šã‚’ç›®æ¨™
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹1ã¤ãšã¤ã®åŸç†çš„è§£æ±º

#### **Task 3.2: ä¸»ç³»çµ±åˆ‡ã‚Šæ›¿ãˆ**
- Track BãŒå®‰å®šã—ã¦Track Aã‚’ä¸Šå›ã£ãŸæ™‚ç‚¹ã§ä¸»ç³»çµ±åŒ–
- Track Aã‚’legacy_controllerã¨ã—ã¦ä¿æŒ

---

## ğŸ§ª **ç¾å®Ÿçš„æ¤œè¨¼æ–¹æ³•**

### **1. æ®µéšçš„ãƒ†ã‚¹ãƒˆ**
```python
def gradual_migration_test():
    test_cases = load_200_cases()
    
    for i in range(0, 200, 10):  # 10ã‚±ãƒ¼ã‚¹å˜ä½
        subset = test_cases[i:i+10]
        
        # Track A vs Track B æ¯”è¼ƒ
        results_a = [central_controller.process(case) for case in subset]
        results_b = [true_central_controller.process(case) for case in subset]
        
        # å“è³ªè©•ä¾¡
        quality_a = calculate_success_rate(results_a)
        quality_b = calculate_success_rate(results_b)
        
        print(f"Cases {i}-{i+9}: A={quality_a}%, B={quality_b}%")
```

### **2. å¤±æ•—ã‚±ãƒ¼ã‚¹æ·±æ˜ã‚Šåˆ†æ**
å„å¤±æ•—ã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦ï¼š
1. **ãªãœspaCyã§è§£æã§ããªã„ã®ã‹ï¼Ÿ**
2. **ã©ã®æ–‡æ³•åŸç†ãŒä¸è¶³ã—ã¦ã„ã‚‹ã®ã‹ï¼Ÿ**
3. **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»¥å¤–ã®è§£æ±ºç­–ã¯ï¼Ÿ**

### **3. ç¾å®Ÿçš„å“è³ªåŸºæº–**
- **Phase 1å®Œäº†**: 70%ä»¥ä¸Šã®æˆåŠŸç‡
- **Phase 2å®Œäº†**: 85%ä»¥ä¸Šã®æˆåŠŸç‡  
- **Phase 3å®Œäº†**: 92%ä»¥ä¸Šã®æˆåŠŸç‡ï¼ˆç¾çŠ¶è¶…è¶Šï¼‰

---

## ğŸ’¡ **ç¾å®Ÿã¨ã®å¦¥å”ç‚¹**

### **è¨±å®¹ã™ã‚‹ç¾å®Ÿçš„è£œæ­£**
1. **ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³DB**: åŸç†çš„å‡¦ç†å›°é›£ãªæ§‹é€ ã®ä¾‹å¤–å‡¦ç†
2. **æ–‡è„ˆä¾å­˜ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯**: spaCyé™ç•Œã®å®Ÿç”¨çš„å›é¿
3. **æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ç†æƒ³â†’ç¾å®Ÿã®ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«åŠ£åŒ–

### **çµ¶å¯¾ã«æ’é™¤ã™ã‚‹ã‚‚ã®**
1. **å€‹åˆ¥Caseç•ªå·ã¸ã®ä¾å­˜**: Case 151, 152ç­‰ã®å›ºå®šå¯¾å¿œ
2. **æ–‡å­—åˆ—ãƒãƒƒãƒãƒ³ã‚°ä¾å­˜**: "imagine if"ç­‰ã®è¡¨é¢çš„åˆ¤å®š
3. **å·¨å¤§æ¡ä»¶åˆ†å²**: ä¿å®ˆä¸å¯èƒ½ãªif/elifæ§‹é€ 

---

## ğŸ¯ **æˆåŠŸã®å®šç¾©**

### **æŠ€è¡“çš„æˆåŠŸ**
- Track BãŒå®‰å®šã—ã¦Track Aã®æˆåŠŸç‡ã‚’ä¸Šå›ã‚‹
- æ–°ã—ã„æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ ã§å¯¾å¿œå¯èƒ½
- ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãŒ126KB â†’ 20KBä»¥ä¸‹ã«å‰Šæ¸›

### **é‹ç”¨çš„æˆåŠŸ**  
- é–‹ç™ºè€…ãŒæ–‡æ³•çš„åŸç†ã§å•é¡Œã‚’ç†è§£ã§ãã‚‹
- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®ãƒ†ã‚¹ãƒˆå·¥æ•°ãŒå¤§å¹…å‰Šæ¸›
- ãƒã‚°ä¿®æ­£ãŒå±€æ‰€çš„å½±éŸ¿ã«é™å®šã•ã‚Œã‚‹

**æœ€çµ‚ç›®æ¨™**: ç†æƒ³çš„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç¾å®Ÿçš„å®Ÿç¾

---

## ğŸ“‹ **å³åº§ã®æ¬¡ã‚¹ãƒ†ãƒƒãƒ—**

1. **Phase 0å®Ÿè¡Œ**: å¤±æ•—24ã‚±ãƒ¼ã‚¹ã®è©³ç´°åˆ†æ
2. **Dual Trackç’°å¢ƒæ§‹ç¯‰**: ä¸¦è¡Œãƒ†ã‚¹ãƒˆåŸºç›¤ã®æ•´å‚™
3. **Track Bå¼·åŒ–é–‹å§‹**: ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹1ã¤ãšã¤ã®åŸç†çš„è§£æ±º

**æ¨å¥¨é–‹å§‹**: Phase 0ã®å¤±æ•—ã‚±ãƒ¼ã‚¹åˆ†æã‹ã‚‰ç€æ‰‹
