# アーキテクチャ移行設計仕様書 v1.0
## 理想的中央管理システムへの段階的移行計画

**作成日**: 2025年9月3日  
**対象**: Rephrase Project - 文法解析システム  
**目標**: ハードコーディング排除・真の中央管理システム実現

---

## 📋 **現状分析**

### **現在のシステム状況**
| 項目 | central_controller.py | true_central_controller.py |
|------|----------------------|---------------------------|
| ファイルサイズ | 126KB (2,559行) | 14KB (374行) |
| アーキテクチャ | ハードコーディング集約型 | 理想的ステージベース型 |
| 機能完成度 | 88% (176/200ケース) | 基本動作確認済み |
| 保守性 | ❌ 低い | ✅ 高い |
| 拡張性 | ❌ 困難 | ✅ 容易 |

### **ハードコーディング実態調査**
- **Case 150-155**: 個別対応コードが6箇所以上
- **特定構文処理**: Imagine, Provided, As long as等の固有対応
- **条件分岐地獄**: 巨大なif/elif/else構造

---

## 🎯 **移行戦略**

### **戦略方針：統合的アーキテクチャ移行**
**重要な洞察**: 中央管理体制整備 = ハードコーディング自動駆逐

#### **理論的根拠**
1. **構造的排除**: ステージベース処理がCase別分岐を物理的に排除
2. **原理的解決**: 文法ハンドラーによる汎用処理が特定対応を無効化
3. **自動統合**: spaCy解析による文字列マッチングからの脱却

#### **実際の効果**
```python
# 現在のハードコーディング (自動削除対象)
# Case 151対策: Imagine構文の早期検出
# Case 152対策: Provided構文の早期検出  
# Case 153対策: As long as構文の早期検出
# ↓
# 中央管理体制での自動解決
conditional_handler.process(sentence)  # 全て仮定法として統一処理
```

### **修正版移行方針**
1. **Phase 1-3: 中央管理体制完成** → **ハードコーディング自動消失**
2. **Phase 4-6: 品質向上と検証** → **原理的処理の精度向上**

---

## 📅 **段階的移行工程表**

### **Phase 1: 基盤整備** (推定工数: 2-3時間)
**目標**: true_central_controller.pyの機能完成

#### **Task 1.1: インターフェース統一**
- [ ] 全ハンドラーのprocess()メソッド実装確認
- [ ] 動名詞ハンドラーのprocess()メソッド追加 ✅ **完了**
- [ ] ハンドラー呼び出し統一化

#### **Task 1.2: 結果統合ロジック強化**
- [ ] _update_context_from_result()の改良
- [ ] スロット統合ルールの実装
- [ ] エラーハンドリング強化

#### **Task 1.3: 基本動作検証**
- [ ] 5文型処理確認
- [ ] 関係詞処理確認  
- [ ] 動名詞・不定詞処理確認

### **Phase 2: テストフレームワーク移行** (推定工数: 1-2時間)
**目標**: true_central_controllerでの200ケーステスト実行

#### **Task 2.1: fast_test.py修正**
- [ ] import文をtrue_central_controllerに変更
- [ ] 初期化パラメータ調整
- [ ] テスト実行・結果比較

#### **Task 2.2: 成功率ベンチマーク**
- [ ] 現在の88% (176/200)を基準値として設定
- [ ] Phase 1完了時点での成功率測定
- [ ] パフォーマンス回帰検証

### **Phase 3: 段階的機能移植** (推定工数: 4-6時間)
**目標**: central_controller.pyの重要機能をtrue_central_controllerに移植

#### **Task 3.1: Case 150-155対応機能の抽象化**
- [ ] 特定ケース処理の分析
- [ ] 汎用ルールへの変換
- [ ] 設定ファイル駆動化

#### **Task 3.2: 複合文法構造処理**
- [ ] 仮定法構文処理
- [ ] 省略関係詞処理
- [ ] 名詞節処理の強化

#### **Task 3.3: 段階実行確認**
- [ ] 10ケース毎の部分テスト
- [ ] 成功率の段階的向上確認
- [ ] 88%以上の維持目標

### **Phase 4: 品質向上と原理的処理強化** (推定工数: 3-4時間)
**目標**: 自動駆逐されたハードコーディングの代替として原理的処理を強化

#### **Task 4.1: 仮定法処理の精度向上**
```python
# 自動統合された構文の精度確認
imagine_cases = ["Imagine if...", "Suppose that...", "Provided that..."]
for case in imagine_cases:
    result = conditional_handler.process(case)
    assert result['success'] == True  # 原理的処理での解決確認
```

#### **Task 4.2: 原理的エラーパターンの特定**
- [ ] Case 151-155が真の中央管理で正しく処理されるか検証
- [ ] 特定構文依存から文法構造依存への移行確認
- [ ] 新たに発生する原理的エラーパターンの対策

### **Phase 5: 品質向上と最適化** (推定工数: 2-3時間)
**目標**: 88%→95%以上の成功率向上

#### **Task 5.1: エラー原因分析**
- [ ] 失敗24ケースの詳細調査
- [ ] パターン不足の特定
- [ ] ハンドラー間連携の改善

#### **Task 5.2: 精度向上**
- [ ] spaCy解析精度向上
- [ ] ハンドラー協調ロジック改良
- [ ] エッジケース対応

### **Phase 6: 完全移行と検証** (推定工数: 1-2時間)
**目標**: 本番環境での安全な切り替え

#### **Task 6.1: 本番切り替え**
- [ ] 全テストシステムのtrue_central_controller.py移行
- [ ] central_controller.py → legacy_central_controller.pyリネーム
- [ ] true_central_controller.py → central_controller.pyリネーム

#### **Task 6.2: 最終検証**
- [ ] 全機能テスト実行
- [ ] パフォーマンステスト
- [ ] リグレッションテスト

---

## 🔧 **技術的詳細**

### **ハンドラーインターフェース統一**
```python
# 標準インターフェース
class BaseHandler:
    def can_handle(self, sentence: str) -> bool:
        """処理可能判定"""
        pass
    
    def process(self, sentence: str) -> Dict[str, Any]:
        """統一処理メソッド"""
        pass
```

### **結果統合ルール**
```python
# 結果マージ優先順位
SLOT_PRIORITY = {
    'main_slots': ['S', 'V', 'O1', 'O2', 'C1', 'C2', 'Aux', 'M1', 'M2', 'M3'],
    'sub_slots': ['sub-s', 'sub-v', 'sub-o1', 'sub-o2'],
    'conflict_resolution': 'last_handler_wins'
}
```

### **設定ファイル構造**
```json
{
  "conditional_patterns": {
    "imagine": {
      "triggers": ["imagine", "suppose", "consider"],
      "pattern": "subjunctive_mood",
      "processing": "conditional_handler"
    }
  }
}
```

---

## 📊 **成功基準**

### **各フェーズの成功基準**
| Phase | 成功率目標 | 主要指標 |
|-------|-----------|----------|
| Phase 1 | 70%+ | 基本動作確認 |
| Phase 2 | 80%+ | テスト移行成功 |
| Phase 3 | 88%+ | 現状維持 |
| Phase 4 | 90%+ | ハードコード駆逐効果 |
| Phase 5 | 95%+ | 品質向上 |
| Phase 6 | 95%+ | 本番安定運用 |

### **品質指標**
- **機能完成度**: テストケース成功率
- **保守性**: コードの循環複雑度
- **拡張性**: 新ハンドラー追加工数
- **パフォーマンス**: 処理時間測定

---

## 🚨 **リスク管理**

### **主要リスク**
1. **機能回帰**: 移行中の成功率低下
2. **複雑性増加**: 過度な抽象化による可読性悪化  
3. **互換性問題**: ハンドラー間インターフェース不整合

### **リスク対策**
1. **段階的テスト**: 各Phaseでの詳細検証
2. **ロールバック計画**: 前Phaseへの迅速復旧
3. **品質ゲート**: 成功率閾値での進行制御

---

## 📋 **次のアクション**

### **即座に実行可能**
1. Task 1.1の完了確認（動名詞ハンドラー修正済み）
2. Task 1.2の結果統合ロジック改良
3. Task 2.1のfast_test.py修正

### **ご判断いただきたい事項**
1. **移行工程の承認**: 上記6フェーズでの進行可否
2. **優先度調整**: 特に重視したいPhaseの指定
3. **品質基準**: 成功率目標値の調整

**推奨開始**: Phase 1 Task 1.2から即座に着手可能
