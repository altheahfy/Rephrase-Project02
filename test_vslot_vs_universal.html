<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ vs æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ  æ¯”è¼ƒãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .system-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .vslot-section {
            border-color: #28a745;
        }
        .universal-section {
            border-color: #007bff;
        }
        .slot-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
        }
        .slot-image {
            width: 80px;
            height: 80px;
            border: 1px solid #ccc;
            border-radius: 4px;
            object-fit: cover;
        }
        .slot-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .slot-phrase {
            font-size: 14px;
            color: #666;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        #test-log {
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ vs æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ  æ¯”è¼ƒãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ¦‚è¦</h2>
        <div class="info-box">
            <p><strong>ç›®çš„:</strong> Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã¨æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œã‚’ç›´æ¥æ¯”è¼ƒ</p>
            <p><strong>å¯¾è±¡:</strong> åŒã˜ãƒ†ã‚­ã‚¹ãƒˆã€Œanalyzeã€ã«å¯¾ã™ã‚‹ç”»åƒè¡¨ç¤ºã®æ¯”è¼ƒ</p>
            <p><strong>æœŸå¾…å€¤:</strong> analyze.png ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨</p>
        </div>
    </div>

    <!-- Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ -->
    <div class="test-container">
        <div class="system-section vslot-section">
            <h2>ğŸŸ¢ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ </h2>
            <div id="slot-v-original" class="slot-container">
                <img src="slot_images/common/placeholder.png" alt="image for V" class="slot-image">
                <div>
                    <div class="slot-text">analyze</div>
                    <div class="slot-phrase">åˆ†æã™ã‚‹</div>
                </div>
            </div>
            <button onclick="testVSlotOriginal()">Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        </div>
    </div>

    <!-- æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ -->
    <div class="test-container">
        <div class="system-section universal-section">
            <h2>ğŸ”µ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ </h2>
            <div id="slot-v-universal" class="slot-container">
                <img src="slot_images/common/placeholder.png" alt="image for V" class="slot-image">
                <div>
                    <div class="slot-text">analyze</div>
                    <div class="slot-phrase">åˆ†æã™ã‚‹</div>
                </div>
            </div>
            <button onclick="testUniversalSingle()">æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ”§ ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h2>
        <div class="test-controls">
            <button onclick="runComparisonTest()">åŒæ™‚æ¯”è¼ƒãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="checkMetaTagData()">ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š æ¯”è¼ƒãƒ†ã‚¹ãƒˆçµæœãƒ­ã‚°</h2>
        <div id="test-log"></div>
    </div>

    <!-- Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/v_slot_image_system.js"></script>
    
    <!-- æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã¯å°‚ç”¨ã®åå‰ç©ºé–“ã§èª­ã¿è¾¼ã¿ -->
    <script>
        // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®é–¢æ•°åã‚’å¤‰æ›´ã—ã¦è¡çªã‚’é¿ã‘ã‚‹
        let universalImageMetaTags = [];
        
        // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ã‚¿ã‚¿ã‚°èª­ã¿è¾¼ã¿ï¼ˆç‹¬ç«‹ï¼‰
        async function loadUniversalImageMetaTags() {
            try {
                const response = await fetch('image_meta_tags.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                universalImageMetaTags = await response.json();
                log(`âœ… æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ (${universalImageMetaTags.length}ä»¶)`);
                return true;
            } catch (error) {
                log(`âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•— - ${error.message}`);
                return false;
            }
        }
        
        // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®ç”»åƒæ¤œç´¢ï¼ˆç‹¬ç«‹ï¼‰
        function findUniversalImageByMetaTag(text) {
            if (!text || !universalImageMetaTags.length) {
                return null;
            }
            
            const searchWords = extractWordsWithStemming(text);
            log(`ğŸ” æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢å˜èª: ${searchWords.join(', ')}`);
            
            let bestMatch = null;
            let bestPriority = 0;
            
            for (const imageData of universalImageMetaTags) {
                for (const metaTag of imageData.meta_tags) {
                    if (searchWords.includes(metaTag.toLowerCase())) {
                        const priority = imageData.priority || 1;
                        if (priority > bestPriority) {
                            bestMatch = imageData;
                            bestPriority = priority;
                        }
                        log(`ğŸ¯ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒãƒƒãƒãƒ³ã‚°: ${metaTag} â†’ ${imageData.image_file}`);
                    }
                }
            }
            
            return bestMatch;
        }
        
        // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ç”»åƒé©ç”¨
        function applyUniversalImageToSlot(slotId, phraseText) {
            log(`ğŸ–¼ï¸ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ç”»åƒé©ç”¨é–‹å§‹: ${slotId} â†’ ${phraseText}`);
            
            const slot = document.getElementById(slotId);
            if (!slot) {
                log(`âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ã‚¹ãƒ­ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${slotId})`);
                return;
            }
            
            const imgElement = slot.querySelector('.slot-image');
            if (!imgElement) {
                log(`âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ç”»åƒè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${slotId})`);
                return;
            }
            
            if (!phraseText || phraseText.trim() === '') {
                imgElement.src = 'slot_images/common/placeholder.png';
                log(`ğŸ“ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¨­å®š`);
                return;
            }
            
            const imageData = findUniversalImageByMetaTag(phraseText);
            log(`ğŸ” æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ æ¤œç´¢çµæœ: ${imageData ? imageData.image_file : 'ãªã—'}`);
            
            if (!imageData) {
                imgElement.src = 'slot_images/common/placeholder.png';
                log(`ğŸ” æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ãƒãƒƒãƒã™ã‚‹ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            
            const newImagePath = `slot_images/${imageData.folder}/${imageData.image_file}`;
            const cacheBuster = Date.now();
            const imageUrlWithCacheBuster = `${newImagePath}?t=${cacheBuster}`;
            
            imgElement.src = imageUrlWithCacheBuster;
            imgElement.alt = `image for ${slotId}: ${imageData.description || phraseText}`;
            
            log(`ğŸ”„ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ç”»åƒæ›´æ–°: ${newImagePath}`);
            log(`ğŸ¨ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ç”»åƒæ›´æ–°å®Œäº†: ${phraseText} â†’ ${newImagePath}`);
        }
    </script>

    <script>
        // ãƒ­ã‚°å‡ºåŠ›æ©Ÿèƒ½
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[COMPARISON TEST] ${message}`);
        }
        
        // Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        async function testVSlotOriginal() {
            log('=== Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!window.imageMetaTags || window.imageMetaTags.length === 0) {
                log('âš ï¸ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const success = await window.loadImageMetaTags();
                if (!success) {
                    log('âŒ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                    return;
                }
            }
            
            log(`âœ… Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèª (${window.imageMetaTags.length}ä»¶)`);
            
            // Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆ
            if (typeof window.applyImageToVSlot === 'function') {
                // ä¸€æ™‚çš„ã«slot-vã®IDã‚’å¤‰æ›´
                const originalVSlot = document.getElementById('slot-v');
                const testVSlot = document.getElementById('slot-v-original');
                if (testVSlot) {
                    testVSlot.id = 'slot-v';
                }
                
                window.applyImageToVSlot('analyze', true);
                log('âœ… Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: applyImageToVSlotå®Ÿè¡Œå®Œäº†');
                
                // IDã‚’å…ƒã«æˆ»ã™
                if (testVSlot) {
                    testVSlot.id = 'slot-v-original';
                }
                if (originalVSlot) {
                    originalVSlot.id = 'slot-v';
                }
            } else {
                log('âŒ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: applyImageToVSloté–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
        async function testUniversalSingle() {
            log('=== æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const success = await loadUniversalImageMetaTags();
            if (!success) {
                log('âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                return;
            }
            
            applyUniversalImageToSlot('slot-v-universal', 'analyze');
            log('âœ… æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : ç”»åƒé©ç”¨å®Ÿè¡Œå®Œäº†');
        }
        
        // åŒæ™‚æ¯”è¼ƒãƒ†ã‚¹ãƒˆ
        async function runComparisonTest() {
            log('=== åŒæ™‚æ¯”è¼ƒãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // ä¸¡æ–¹ã‚’ä¸¦è¡Œå®Ÿè¡Œ
            await Promise.all([
                testVSlotOriginal(),
                testUniversalSingle()
            ]);
            
            // çµæœã‚’5ç§’å¾Œã«ç¢ºèª
            setTimeout(() => {
                log('=== 5ç§’å¾Œçµæœç¢ºèª ===');
                
                const vOriginalImg = document.querySelector('#slot-v-original .slot-image');
                const vUniversalImg = document.querySelector('#slot-v-universal .slot-image');
                
                if (vOriginalImg) {
                    log(`ğŸŸ¢ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨æœ€çµ‚ç”»åƒ: ${vOriginalImg.src}`);
                }
                
                if (vUniversalImg) {
                    log(`ğŸ”µ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ æœ€çµ‚ç”»åƒ: ${vUniversalImg.src}`);
                }
                
                // ä¸¡æ–¹ãŒanalyze.pngã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const vOriginalAnalyze = vOriginalImg && vOriginalImg.src.includes('analyze.png');
                const vUniversalAnalyze = vUniversalImg && vUniversalImg.src.includes('analyze.png');
                
                if (vOriginalAnalyze && vUniversalAnalyze) {
                    log('ğŸ‰ ä¸¡ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚‚æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼', 'success');
                } else if (vOriginalAnalyze && !vUniversalAnalyze) {
                    log('âš ï¸ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã®ã¿å‹•ä½œã€æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™', 'error');
                } else if (!vOriginalAnalyze && vUniversalAnalyze) {
                    log('âš ï¸ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®ã¿å‹•ä½œã€Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã«å•é¡ŒãŒã‚ã‚Šã¾ã™', 'error');
                } else {
                    log('âŒ ä¸¡ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚‚å‹•ä½œã—ã¦ã„ã¾ã›ã‚“', 'error');
                }
            }, 5000);
        }
        
        // ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        async function checkMetaTagData() {
            log('=== ãƒ¡ã‚¿ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===');
            
            // Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª
            if (window.imageMetaTags && window.imageMetaTags.length > 0) {
                log(`âœ… Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ãƒ¡ã‚¿ã‚¿ã‚°: ${window.imageMetaTags.length}ä»¶`);
                
                // analyzeãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const analyzeData = window.imageMetaTags.find(item => 
                    item.image_file === 'analyze.png' || 
                    item.meta_tags.includes('analyze')
                );
                if (analyzeData) {
                    log(`ğŸ¯ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: analyzeæƒ…å ±ç™ºè¦‹ - ${analyzeData.image_file}`);
                } else {
                    log(`âŒ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨: analyzeæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            } else {
                log(`âŒ Vã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨ãƒ¡ã‚¿ã‚¿ã‚°: ãƒ‡ãƒ¼ã‚¿ãªã—`);
            }
            
            // æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª
            if (universalImageMetaTags.length > 0) {
                log(`âœ… æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ã‚¿ã‚¿ã‚°: ${universalImageMetaTags.length}ä»¶`);
                
                const analyzeData = universalImageMetaTags.find(item => 
                    item.image_file === 'analyze.png' || 
                    item.meta_tags.includes('analyze')
                );
                if (analyzeData) {
                    log(`ğŸ¯ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : analyzeæƒ…å ±ç™ºè¦‹ - ${analyzeData.image_file}`);
                } else {
                    log(`âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ : analyzeæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            } else {
                log(`âŒ æ±ç”¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ã‚¿ã‚¿ã‚°: ãƒ‡ãƒ¼ã‚¿ãªã—`);
            }
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ æ¯”è¼ƒãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
            
            // 3ç§’å¾Œã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            setTimeout(() => {
                checkMetaTagData();
            }, 3000);
        });
    </script>
</body>
</html>
