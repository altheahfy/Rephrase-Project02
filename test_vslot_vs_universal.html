<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vスロット専用 vs 汎用システム 比較テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .system-section {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .vslot-section {
            border-color: #28a745;
        }
        .universal-section {
            border-color: #007bff;
        }
        .slot-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
        }
        .slot-image {
            width: 80px;
            height: 80px;
            border: 1px solid #ccc;
            border-radius: 4px;
            object-fit: cover;
        }
        .slot-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .slot-phrase {
            font-size: 14px;
            color: #666;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        #test-log {
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>🔬 Vスロット専用 vs 汎用システム 比較テスト</h1>
    
    <div class="test-container">
        <h2>📋 テスト概要</h2>
        <div class="info-box">
            <p><strong>目的:</strong> Vスロット専用システムと汎用システムの動作を直接比較</p>
            <p><strong>対象:</strong> 同じテキスト「analyze」に対する画像表示の比較</p>
            <p><strong>期待値:</strong> analyze.png が正しく表示されること</p>
        </div>
    </div>

    <!-- Vスロット専用システムテスト -->
    <div class="test-container">
        <div class="system-section vslot-section">
            <h2>🟢 Vスロット専用システム</h2>
            <div id="slot-v-original" class="slot-container">
                <img src="slot_images/common/placeholder.png" alt="image for V" class="slot-image">
                <div>
                    <div class="slot-text">analyze</div>
                    <div class="slot-phrase">分析する</div>
                </div>
            </div>
            <button onclick="testVSlotOriginal()">Vスロット専用テスト実行</button>
        </div>
    </div>

    <!-- 汎用システムテスト -->
    <div class="test-container">
        <div class="system-section universal-section">
            <h2>🔵 汎用システム</h2>
            <div id="slot-v-universal" class="slot-container">
                <img src="slot_images/common/placeholder.png" alt="image for V" class="slot-image">
                <div>
                    <div class="slot-text">analyze</div>
                    <div class="slot-phrase">分析する</div>
                </div>
            </div>
            <button onclick="testUniversalSingle()">汎用システムテスト実行</button>
        </div>
    </div>

    <div class="test-container">
        <h2>🔧 テスト制御</h2>
        <div class="test-controls">
            <button onclick="runComparisonTest()">同時比較テスト実行</button>
            <button onclick="checkMetaTagData()">メタタグデータ確認</button>
            <button onclick="clearLog()">ログクリア</button>
        </div>
    </div>

    <div class="test-container">
        <h2>📊 比較テスト結果ログ</h2>
        <div id="test-log"></div>
    </div>

    <!-- Vスロット専用システムを読み込み -->
    <script src="js/v_slot_image_system.js"></script>
    
    <!-- 汎用システムは専用の名前空間で読み込み -->
    <script>
        // 汎用システムの関数名を変更して衝突を避ける
        let universalImageMetaTags = [];
        
        // 汎用システムのメタタグ読み込み（独立）
        async function loadUniversalImageMetaTags() {
            try {
                const response = await fetch('image_meta_tags.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                universalImageMetaTags = await response.json();
                log(`✅ 汎用システム: メタタグデータ読み込み成功 (${universalImageMetaTags.length}件)`);
                return true;
            } catch (error) {
                log(`❌ 汎用システム: メタタグデータ読み込み失敗 - ${error.message}`);
                return false;
            }
        }
        
        // 汎用システムの画像検索（独立）
        function findUniversalImageByMetaTag(text) {
            if (!text || !universalImageMetaTags.length) {
                return null;
            }
            
            const searchWords = extractWordsWithStemming(text);
            log(`🔍 汎用システム検索単語: ${searchWords.join(', ')}`);
            
            let bestMatch = null;
            let bestPriority = 0;
            
            for (const imageData of universalImageMetaTags) {
                for (const metaTag of imageData.meta_tags) {
                    if (searchWords.includes(metaTag.toLowerCase())) {
                        const priority = imageData.priority || 1;
                        if (priority > bestPriority) {
                            bestMatch = imageData;
                            bestPriority = priority;
                        }
                        log(`🎯 汎用システムマッチング: ${metaTag} → ${imageData.image_file}`);
                    }
                }
            }
            
            return bestMatch;
        }
        
        // 汎用システム用の画像適用
        function applyUniversalImageToSlot(slotId, phraseText) {
            log(`🖼️ 汎用システム画像適用開始: ${slotId} → ${phraseText}`);
            
            const slot = document.getElementById(slotId);
            if (!slot) {
                log(`❌ 汎用システム: スロットが見つかりません (${slotId})`);
                return;
            }
            
            const imgElement = slot.querySelector('.slot-image');
            if (!imgElement) {
                log(`❌ 汎用システム: 画像要素が見つかりません (${slotId})`);
                return;
            }
            
            if (!phraseText || phraseText.trim() === '') {
                imgElement.src = 'slot_images/common/placeholder.png';
                log(`📝 汎用システム: テキストが空のため、プレースホルダーを設定`);
                return;
            }
            
            const imageData = findUniversalImageByMetaTag(phraseText);
            log(`🔍 汎用システム検索結果: ${imageData ? imageData.image_file : 'なし'}`);
            
            if (!imageData) {
                imgElement.src = 'slot_images/common/placeholder.png';
                log(`🔍 汎用システム: マッチする画像が見つかりません`);
                return;
            }
            
            const newImagePath = `slot_images/${imageData.folder}/${imageData.image_file}`;
            const cacheBuster = Date.now();
            const imageUrlWithCacheBuster = `${newImagePath}?t=${cacheBuster}`;
            
            imgElement.src = imageUrlWithCacheBuster;
            imgElement.alt = `image for ${slotId}: ${imageData.description || phraseText}`;
            
            log(`🔄 汎用システム画像更新: ${newImagePath}`);
            log(`🎨 汎用システム画像更新完了: ${phraseText} → ${newImagePath}`);
        }
    </script>

    <script>
        // ログ出力機能
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[COMPARISON TEST] ${message}`);
        }
        
        // Vスロット専用システムテスト
        async function testVSlotOriginal() {
            log('=== Vスロット専用システムテスト開始 ===');
            
            // メタタグデータが読み込まれているか確認
            if (!window.imageMetaTags || window.imageMetaTags.length === 0) {
                log('⚠️ Vスロット専用: メタタグデータを読み込み中...');
                const success = await window.loadImageMetaTags();
                if (!success) {
                    log('❌ Vスロット専用: メタタグデータ読み込み失敗');
                    return;
                }
            }
            
            log(`✅ Vスロット専用: メタタグデータ確認 (${window.imageMetaTags.length}件)`);
            
            // Vスロット専用関数を使用してテスト
            if (typeof window.applyImageToVSlot === 'function') {
                // 一時的にslot-vのIDを変更
                const originalVSlot = document.getElementById('slot-v');
                const testVSlot = document.getElementById('slot-v-original');
                if (testVSlot) {
                    testVSlot.id = 'slot-v';
                }
                
                window.applyImageToVSlot('analyze', true);
                log('✅ Vスロット専用: applyImageToVSlot実行完了');
                
                // IDを元に戻す
                if (testVSlot) {
                    testVSlot.id = 'slot-v-original';
                }
                if (originalVSlot) {
                    originalVSlot.id = 'slot-v';
                }
            } else {
                log('❌ Vスロット専用: applyImageToVSlot関数が見つかりません');
            }
        }
        
        // 汎用システムテスト
        async function testUniversalSingle() {
            log('=== 汎用システムテスト開始 ===');
            
            // メタタグデータを読み込み
            const success = await loadUniversalImageMetaTags();
            if (!success) {
                log('❌ 汎用システム: メタタグデータ読み込み失敗');
                return;
            }
            
            applyUniversalImageToSlot('slot-v-universal', 'analyze');
            log('✅ 汎用システム: 画像適用実行完了');
        }
        
        // 同時比較テスト
        async function runComparisonTest() {
            log('=== 同時比較テスト開始 ===');
            
            // 両方を並行実行
            await Promise.all([
                testVSlotOriginal(),
                testUniversalSingle()
            ]);
            
            // 結果を5秒後に確認
            setTimeout(() => {
                log('=== 5秒後結果確認 ===');
                
                const vOriginalImg = document.querySelector('#slot-v-original .slot-image');
                const vUniversalImg = document.querySelector('#slot-v-universal .slot-image');
                
                if (vOriginalImg) {
                    log(`🟢 Vスロット専用最終画像: ${vOriginalImg.src}`);
                }
                
                if (vUniversalImg) {
                    log(`🔵 汎用システム最終画像: ${vUniversalImg.src}`);
                }
                
                // 両方がanalyze.pngを表示しているかチェック
                const vOriginalAnalyze = vOriginalImg && vOriginalImg.src.includes('analyze.png');
                const vUniversalAnalyze = vUniversalImg && vUniversalImg.src.includes('analyze.png');
                
                if (vOriginalAnalyze && vUniversalAnalyze) {
                    log('🎉 両システムとも正常に動作しています！', 'success');
                } else if (vOriginalAnalyze && !vUniversalAnalyze) {
                    log('⚠️ Vスロット専用のみ動作、汎用システムに問題があります', 'error');
                } else if (!vOriginalAnalyze && vUniversalAnalyze) {
                    log('⚠️ 汎用システムのみ動作、Vスロット専用に問題があります', 'error');
                } else {
                    log('❌ 両システムとも動作していません', 'error');
                }
            }, 5000);
        }
        
        // メタタグデータ確認
        async function checkMetaTagData() {
            log('=== メタタグデータ確認 ===');
            
            // Vスロット専用のデータ確認
            if (window.imageMetaTags && window.imageMetaTags.length > 0) {
                log(`✅ Vスロット専用メタタグ: ${window.imageMetaTags.length}件`);
                
                // analyzeが含まれているか確認
                const analyzeData = window.imageMetaTags.find(item => 
                    item.image_file === 'analyze.png' || 
                    item.meta_tags.includes('analyze')
                );
                if (analyzeData) {
                    log(`🎯 Vスロット専用: analyze情報発見 - ${analyzeData.image_file}`);
                } else {
                    log(`❌ Vスロット専用: analyze情報が見つかりません`);
                }
            } else {
                log(`❌ Vスロット専用メタタグ: データなし`);
            }
            
            // 汎用システムのデータ確認
            if (universalImageMetaTags.length > 0) {
                log(`✅ 汎用システムメタタグ: ${universalImageMetaTags.length}件`);
                
                const analyzeData = universalImageMetaTags.find(item => 
                    item.image_file === 'analyze.png' || 
                    item.meta_tags.includes('analyze')
                );
                if (analyzeData) {
                    log(`🎯 汎用システム: analyze情報発見 - ${analyzeData.image_file}`);
                } else {
                    log(`❌ 汎用システム: analyze情報が見つかりません`);
                }
            } else {
                log(`❌ 汎用システムメタタグ: データなし`);
            }
        }
        
        // ログクリア
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 比較テストページ初期化完了');
            
            // 3秒後に自動チェック実行
            setTimeout(() => {
                checkMetaTagData();
            }, 3000);
        });
    </script>
</body>
</html>
