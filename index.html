
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Rephrase Structured UI</title>
  <link href="style.css" rel="stylesheet"/>
  <script src="js/subslot_toggle.js"></script>
  <script src="js/log_o1_identifiers.js" type="module"></script>
</head>
<body>
  <section></section>
  <h1>🧪 Subslot Structured Test with Upper Slots</h1>
  <section>
    <button id="randomize-all">全体ランダマイズ</button>
    <input type="file" id="jsonFileInput" accept=".json">
    <button id="loadJsonButton">ロード</button>
    <button id="log-o1-button">O1識別番号確認</button>
    <!-- 元のスロット構造は省略（既存内容をそのまま利用） -->
  </section>
  <script src="./js/renderer_core.js" type="module"></script>
  <script src="js/structure_builder.js" type="module"></script>
</body>
</html>

<script type="module">
import { randomizeAll } from './js/randomizer_all.js';
import { buildStructure } from './js/structure_builder.js';
import { logO1Identifiers } from './js/log_o1_identifiers.js';

let loadedJsonData = null;

document.getElementById("loadJsonButton").addEventListener("click", () => {
  const fileInput = document.getElementById("jsonFileInput");
  if (fileInput.files.length === 0) {
    alert("ファイルを選択してください");
    return;
  }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      loadedJsonData = JSON.parse(e.target.result);
      window.loadedJsonData = loadedJsonData;
      console.log("🟢 window.loadedJsonData セット完了:", window.loadedJsonData);
      const data = randomizeAll(loadedJsonData);
      console.log("ランダマイズ結果詳細:", JSON.stringify(data, null, 2));
      validateSlots(data);
      buildStructure(data);
    } catch (err) {
      console.error("❌ JSON パースエラーまたは処理例外", err);
      alert("無効な JSON ファイルです");
    }
  };
  reader.readAsText(file);
});

document.getElementById("randomize-all").addEventListener("click", () => {
  if (!loadedJsonData || !Array.isArray(loadedJsonData)) {
    alert("先に正しいJSONデータをロードしてください");
    console.error("❌ 全体ランダマイズ：ロード済データが不正または未ロード");
    return;
  }
  const data = randomizeAll(loadedJsonData);
  console.log("ランダマイズ結果詳細（全体ボタン）:", JSON.stringify(data, null, 2));
  validateSlots(data);
  buildStructure(data);
});

document.getElementById("log-o1-button").addEventListener("click", () => {
  if (!loadedJsonData) {
    alert("先に JSON データをロードしてください");
    return;
  }
  logO1Identifiers(loadedJsonData);
});

function validateSlots(data) {
  const requiredSlots = ["M1", "S", "V"];
  const presentSlots = data.map(d => d.Slot);
  requiredSlots.forEach(slot => {
    if (!presentSlots.includes(slot)) {
      console.warn(`⚠ 必須スロット ${slot} がランダマイズ結果に含まれていません`);
    }
  });
}
</script>
