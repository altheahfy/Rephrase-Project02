# Rephrase例文DB作成完全手順書 v1.0

作成日: 2025年8月5日  
作成者: Claude（Anthropic）  
用途: エクセル入力からJSON化まで、例文DB作成の全工程を標準化  

---

## 🎯 **概要**

Rephraseシステム用の例文データベース作成の全工程を、**記憶に頼らず確実に実行**するための手順書です。
属性固定型例文増殖から最終的なJSON化まで、6つの段階で構成されています。

---

## 📋 **全体フロー概要**

```
【段階1】 例文増殖（AI支援）
└── 属性固定型増殖仕様書v2.0に基づく例文セット生成

【段階2】 エクセル入力・整備
└── Python支援 or AI支援による入力 → 人手による整合性チェック

【段階3】 未作成アセット検出（自動）
└── イラスト・日本語補助テキストの不足項目を自動特定

【段階4】 JSON化（自動）
└── Pythonスクリプトによる自動変換

【段階5】 イラスト作成（AI支援）
└── Claude Sonnet 4 + Canva AIによる画像生成

【段階6】 メタデータ整備（AI支援）
└── イラストメタタグ・補助テキストJSONの更新
```

---

## 🌱 **【段階1】例文増殖（AI支援フェーズ）**

### 🎯 **目的**
著作権対策パラフレーズ + 属性固定型増殖による例文セット生成

### 📋 **準備物**
- 元になる例文（著作権のある教材から抽出）
- [`example_expansion_spec_v2.0.md`](example_expansion_spec_v2.0.md)（属性固定型増殖仕様書）

### ⚡ **実行手順**

#### 1️⃣ **著作権対策パラフレーズ**
```
【ChatGPTへの指示例】
以下の例文を、著作権対策のため、構造を維持したまま語彙レベルでパラフレーズしてください：

元文: "He has fully recovered from his illness."
→ 語彙のみ変更: "He has completely recovered from his injury."
```

#### 2️⃣ **属性固定型増殖実行**
```
【ChatGPTへの指示例】
添付の example_expansion_spec_v2.0.md に基づき、以下の例文の属性固定型増殖を実行してください。

対象文: "He has completely recovered from his injury."
指定属性: male/singular固定
段階: 段階0から段階4まで順次実行

※同一セッション内でのfemale/neutral等の混在は絶対禁止
```

#### 3️⃣ **複数属性展開（推奨）**
商用展開での多様性確保のため、4つの属性で独立実行：
- セッション1: male/singular → 4例文
- セッション2: female/singular → 4例文  
- セッション3: neutral/singular → 4例文
- セッション4: neutral/plural → 4例文

### ✅ **成果物**
各属性につき4例文、合計16例文の属性別データベース

---

## 📊 **【段階2】エクセル入力・整備フェーズ**

### 🎯 **目的**
例文データのExcel形式への構造化入力と整合性確認

### 📋 **準備物**
- [`例文入力元（フォーマット）.xlsx`](例文セットDB作成システム/例文入力元（フォーマット）.xlsx)
- 段階1で生成された例文セット

### ⚡ **実行手順**

#### 2-A: **Python支援入力方式**（効率重視）

**手順**:
1. `例文入力元.xlsx`に基本情報のみ手動入力：
   - 構文ID（例：`V自動詞第1文型`）
   - 例文ID（例：`001`, `002`...）
   - V_group_key（例：`recover`）
   - 原文（段階1の増殖結果）

2. **generate.py実行**（下処理自動化）：
   ```bash
   cd 例文セットDB作成システム
   python generate.py
   ```

3. **自動生成ファイル確認**：
   - `例文入力_自動展開_改良_gkh_trigger_final_clean_fixed.xlsx`が生成
   - Slot, SlotPhrase, SubslotID, SubslotElementが自動補完

#### 2-B: **AI支援入力方式**（過去実績では高速）

**手順**:
1. **ChatGPTに全入力を依頼**：
```
【指示例】
以下の例文セットを、添付のExcelフォーマットに従って完全入力してください：

例文セット: [段階1の結果を貼り付け]
構文ID: V自動詞第1文型
V_group_key: recover

※絶対順序の維持が最重要（後述の整合性ルール参照）
```

### 🚨 **重要：絶対順序ルール（最大の注意点）**

**❗ 絶対原則**: スロットの順序は相対順序ではなく、**そのV_group_keyの全例文の絶対順序**にする

**具体例**:
```
例文A: "Basically, I love him."
例文B: "I love him."

❌ 間違った順序（相対順序）:
例文A: Basically_1, I_2, love_3, him_4
例文B: I_1, love_2, him_3

✅ 正しい順序（絶対順序）:
例文A: Basically_1, I_2, love_3, him_4  
例文B: (欠番), I_2, love_3, him_4
```

### 🧠 **絶対順序の設計理念と詳細原理**

#### 🎯 **Rephraseランダマイズアルゴリズムの2段階選択**
```
段階1: V_group_key選択
└─ "wh", "gave", "recover"等から1つを選択

段階2: 選択されたV_group内でのスロット別要素選択  
└─ 各スロット（M1, S, Aux, V, O1等）から独立して要素を選択
```

#### 🔍 **同一V_group内での絶対順序が必要な理由**

**例：whグループ（疑問詞・Yes/No疑問文混合）**
```
疑問詞疑問文: "Where did you tell Mary what?"
Yes/No疑問文: "Did you tell Mary a story?"

共通構造:
- M3-1: where (QuestionType: wh-word)
- M3-8: (空白セル)  
- S-3: you
- Aux-4: did
- V-5: tell  
- O1-6: Mary
- O2-2: what (QuestionType: wh-word)
- O2-7: a story

ランダマイズ制御の仕組み:
✅ wh-word識別子により、M3-1(where)とO2-2(what)は同時選出されない
✅ M3-1とM3-8は同じM3スロットなので排他的選択
✅ 空白セルも候補に含まれるため、疑問詞なしの自然な文も生成可能
✅ 絶対順序により、where(1番目)→you(3番目)→did(4番目)の正確な配置が保証
```

#### 🆔 **異なるV_group間では絶対順序統一が不要な理由**

**例：whグループ vs gaveグループ**
```
whグループ: M3-1, S-3, Aux-4, V-5, O1-6, O2-2...
gaveグループ: S-1, V-2, O1-3, O2-4... ← 1から始めてOK

理由: V_group_key選択の段階1で既に分離済み
- "wh"が選ばれた時点で、gaveグループは完全に除外
- "gave"が選ばれた時点で、whグループは完全に除外
→ 両者の順序を統一する必要は一切なし
```

#### ⚡ **空白セル候補の重要性**
```
目的: 文法的多様性の確保
例: M3に空白が選ばれる → 疑問詞なしの平叙文
    O2に空白が選ばれる → 目的語1つの簡潔な文

データ設計: 各スロットに意図的に空白セルを含める
ランダマイズ結果: 自然な文の長さとスタイルの変化
```

**理由**: この絶対順序により、ランダマイズ時の正しい表示順序が保証され、欠番部分も選択肢として機能します。

#### 2-C: **人手による整合性チェック（必須）**

**チェック項目**:
- [ ] **絶対順序確認**: 同一V_group_key内で順序が統一されている
- [ ] **V_group分離確認**: 異なるV_group間の順序統一は不要（1から開始OK）
- [ ] **wh-word識別子**: 疑問詞要素にQuestionType: wh-word属性が付与されている  
- [ ] **空白セル配置**: 各スロットに適切な空白候補が含まれている
- [ ] **属性整合性**: 代名詞（he/his, she/her等）が主語と一致している
- [ ] **同一人称制約**: I+me, You+you, We+us等の意味的不自然さがない
- [ ] **スロット完整性**: 必要なSlot, SlotPhrase, SubslotID, SubslotElementが全て入力済み
- [ ] **V_group_key統一**: 同一動詞グループで一貫している

**📋 絶対順序チェックの実践例**:
```
V_group_key: "wh"の場合
例文1: "Where did you tell Mary?"
例文2: "Did you tell Mary a story?"

✅ 正しいチェック:
- M3-1: where (例文1のみ)
- M3-8: (空白) (例文2で選択される)
- S-3: you (両例文で共通)
- Aux-4: did (両例文で共通)  
- V-5: tell (両例文で共通)
- O1-6: Mary (両例文で共通)
- O2-2: what (疑問詞パターン)
- O2-7: a story (平叙文パターン)

❌ よくある間違い:
- 例文2を S-1, Aux-2, V-3... と相対順序で設定
```

### ✅ **成果物**
整合性チェック済みの`例文入力元.xlsx`

---

## 🔍 **【段階3】未作成アセット検出フェーズ（自動）**

### 🎯 **目的**
イラスト・日本語補助テキストの未作成項目を自動特定

### ⚡ **実行手順**

**auto_check_missing_assets.py実行**:
```bash
cd 例文セットDB作成システム
python auto_check_missing_assets.py
```

**処理内容**:
- SlotPhrase・SubslotElementの英単語を解析
- `image_meta_tags.json`+`slot_images/common/`での画像存在確認
- `slottext.json`での日本語補助テキスト存在確認
- 結果を`例文入力元_チェック結果.xlsx`のV列（22列目）に出力

**出力例**:
```
📷 vocabulary, 📝 from his painful past, 📷 trauma
```

### 📊 **結果の解読**
- `📷 word`: イラスト作成が必要な単語
- `📝 phrase`: slottext.json追加が必要なフレーズ
- **赤色ハイライト**: 未作成アセットがある行

### ✅ **成果物**
未作成アセットリスト付きの`例文入力元_チェック結果.xlsx`

---

## 🔄 **【段階4】JSON化フェーズ（自動）**

### 🎯 **目的**
Excelデータの自動JSON変換とslottext補完

### ⚡ **実行手順**

**batch.py実行**:
```bash
cd 例文セットDB作成システム
python batch.py 例文入力元.xlsx
```

**処理内容**:
- Excel → JSON形式変換
- `slottext.json`ルールに基づく日本語補助テキスト自動付与
- 動詞の活用形・時制の自動認識
- 前置詞・接続詞等の定型表現マッチング

### 📁 **生成ファイル**
- `slot_order_data.json`: Rephraseシステム用のメインデータベース

### 🚨 **補助テキスト問題の対処**
slottextがうまく付与されない場合：
1. 該当フレーズをChatGPTに相談
2. `slottext.json`に新ルール追加
3. batch.py再実行

### ✅ **成果物**
Rephraseシステム対応の`slot_order_data.json`

---

## 🎨 **【段階5】イラスト作成フェーズ（AI支援）**

### 🎯 **目的**
段階3で特定された📷マーク項目のイラスト生成

### 📋 **準備物**
- 段階3の未作成アセットリスト
- `canva_illustration_prompts.md`（イラスト生成指針）

### ⚡ **実行手順**

#### 5-A: **Claude Sonnet 4によるプロンプト生成**
```
【指示例】
以下の英単語について、canva_illustration_prompts.mdの指針に基づいて、
Canva AI用のイラスト生成プロンプトを作成してください：

対象単語: vocabulary, trauma, recovery
目的: Rephrase英語学習システム用のスロットイラスト
要件: 学習者の理解を助ける明確で親しみやすいビジュアル
```

#### 5-B: **Canva AIでのイラスト生成**
- Claude生成プロンプトをCanva AIに入力
- 英語学習に適した画像スタイルで生成
- ファイル名は単語名.pngで統一

#### 5-C: **ファイル配置**
生成画像を以下に配置：
```
training/slot_images/common/[単語名].png
```

### ✅ **成果物**
新規イラストファイル群

---

## 📝 **【段階6】メタデータ整備フェーズ（AI支援）**

### 🎯 **目的**
イラストメタタグ・補助テキストJSONの更新

### ⚡ **実行手順**

#### 6-A: **イラストメタタグJSON更新**
```
【Claude Sonnet 4への指示例】
以下の新規イラストについて、image_meta_tags.jsonに追加すべき
メタタグエントリを生成してください：

新規画像: vocabulary.png, trauma.png, recovery.png
既存JSON: [image_meta_tags.jsonの内容を貼り付け]

要件: 学習者の理解促進に資する適切なタグ付け
```

#### 6-B: **slottext.json拡張（必要に応じて）**
段階3で📝マークが付いた表現について：
```
【指示例】
以下の表現について、slottext.jsonに追加すべきルールを生成してください：

未対応表現: "from his painful past", "during the recovery process"
既存ルール例: [slottext.jsonの一部を貼り付け]

要件: 学習者の理解を助ける適切な日本語説明
```

### 📁 **更新対象ファイル**
- `training/image_meta_tags.json`
- `例文セットDB作成システム/slottext.json`

### ✅ **成果物**
更新されたメタデータファイル群

---

## 🔧 **トラブルシューティング**

### ❌ **よくある問題と対処法**

#### 問題1: 絶対順序の間違い
**症状**: ランダマイズ時の表示順序が乱れる  
**具体例**: 疑問詞が文中間に出現、空白セルが正しく機能しない
**対処**: 段階2-Cの整合性チェックを徹底実行
**予防**: V_group_key選択→同一グループ内絶対順序統一の2段階思考を徹底

#### 問題2: V_group間順序統一の誤解
**症状**: 異なるV_groupで無駄な順序統一作業を実施  
**誤解**: 全V_groupで順序を揃える必要があると思い込む
**対処**: V_group_key選択の段階1で分離済みであることを理解
**正解**: 各V_groupは独立して1から順序設定してOK

#### 問題2: slottext未対応エラー
**症状**: batch.py実行時に補助テキストが空白  
**対処**: ChatGPTに相談してslottext.json拡張

#### 問題3: 属性不整合
**症状**: "He has recovered her strength"等の代名詞ミス  
**対処**: 属性固定型増殖の段階0確認、例文セット再生成

#### 問題4: ファイルパスエラー  
**症状**: Python実行時のファイル未発見エラー  
**対処**: 例文セットDB作成システムフォルダ内でのPowerShell実行確認

---

## 🎯 **品質保証チェックリスト**

### 📋 **最終確認項目**
- [ ] **例文品質**: 文法的正確性・意味的自然性
- [ ] **属性整合**: 同一属性内での代名詞統一
- [ ] **絶対順序**: V_group_key内での順序統一
- [ ] **JSON整合**: slot_order_data.jsonの構造確認
- [ ] **アセット完備**: 必要なイラスト・slottextの準備完了
- [ ] **メタデータ**: image_meta_tags.jsonの更新確認

---

## 📁 **作業ファイル一覧**

### 📊 **入力ファイル**
- `例文入力元（フォーマット）.xlsx` - 入力テンプレート
- `example_expansion_spec_v2.0.md` - 属性固定型増殖仕様

### 🔧 **処理スクリプト**
- `generate.py` - Excel下処理自動化
- `auto_check_missing_assets.py` - 未作成アセット検出
- `batch.py` - JSON化・slottext付与

### 📁 **設定ファイル**
- `slottext.json` - 日本語補助テキストルール
- `image_meta_tags.json` - イラストメタデータ

### 📤 **出力ファイル**
- `例文入力元_チェック結果.xlsx` - アセットチェック結果
- `slot_order_data.json` - Rephraseシステム用DB

---

## 🚀 **次バージョン改善予定**

### v2.0で追加予定
- 属性固定型増殖の自動化スクリプト
- イラスト生成プロンプトの自動化
- slottext.json学習機能
- 品質保証の自動化

---

## 💡 **運用のコツ**

### 🎯 **効率化のポイント**
1. **段階1**: 属性別セッションを明確に分離し、混在を防ぐ
2. **段階2**: AI支援入力方式が過去実績では最効率
3. **段階3**: 自動チェック結果を活用し、人手判断に集中
4. **段階5-6**: Claude Sonnet 4との連携で一括処理

### 🔄 **継続改善**
- 各段階での所要時間記録
- エラーパターンの蓄積と対策マニュアル化
- slottext.jsonルールの継続拡充
- イラスト生成プロンプトの品質向上

---

## 📞 **サポート情報**

**作成者**: Claude（Anthropic）  
**更新日**: 2025年8月5日  
**次回更新予定**: 商用展開フィードバック後（2025年9月頃）

この手順書により、**記憶に頼らず確実で効率的な例文DB作成**が実現できます。
