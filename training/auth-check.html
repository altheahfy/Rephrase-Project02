<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>認証確認中... - Rephrase</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    
    .auth-check-container {
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
    }
    
    p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="auth-check-container">
    <div class="spinner"></div>
    <h1>🔐 認証確認中</h1>
    <p>しばらくお待ちください...</p>
  </div>

  <!-- 簡易セキュリティユーティリティ -->
  <script>
    window.securityUtils = {
      escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      
      secureLocalStorageSet: function(key, data) {
        try {
          const jsonString = JSON.stringify(data);
          const encoded = btoa(jsonString);
          localStorage.setItem(key, encoded);
        } catch (error) {
          console.error('Storage set error:', error);
        }
      },
      
      secureLocalStorageGet: function(key) {
        try {
          const encoded = localStorage.getItem(key);
          if (!encoded) return null;
          
          const jsonString = atob(encoded);
          return JSON.parse(jsonString);
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      }
    };
  </script>

  <!-- 認証システム読み込み -->
  <script src="js/rate-limiter.js"></script>
  <script src="js/error-handler.js"></script>
  <script src="js/security.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // 認証チェック処理
    function performAuthCheck() {
      console.log('🔐 認証チェック開始');
      
      // 認証システムが読み込まれるまで待機
      function waitForAuth() {
        if (window.authSystem && window.securityUtils) {
          console.log('✅ 認証システム読み込み完了');
          
          try {
            // ログインチェック
            const isLoggedIn = window.authSystem.isLoggedIn();
            console.log('🔐 ログイン状態:', isLoggedIn);
            
            if (isLoggedIn) {
              console.log('✅ 認証済み - トレーニングUIへリダイレクト');
              // 認証済みの場合はトレーニングUIへ
              window.location.href = 'index.html';
            } else {
              console.log('❌ 未認証 - 認証ページへリダイレクト');
              // 未認証の場合は認証ページへ（リダイレクト先を指定）
              const redirectUrl = `auth.html?redirect=${encodeURIComponent('index.html')}`;
              window.location.href = redirectUrl;
            }
          } catch (error) {
            console.error('認証チェックエラー:', error);
            // エラーの場合は認証ページへ
            window.location.href = 'auth.html';
          }
        } else {
          // 認証システムがまだ読み込まれていない場合は100ms後に再試行
          setTimeout(waitForAuth, 100);
        }
      }
      
      // 認証チェック開始
      waitForAuth();
    }

    // ページ読み込み完了後に認証チェック実行
    document.addEventListener('DOMContentLoaded', performAuthCheck);
  </script>
</body>
</html>
