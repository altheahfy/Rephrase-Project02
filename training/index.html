<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <!-- ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self'; media-src 'self'; object-src 'none'; frame-src 'none';">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=()">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  
  <title>
   Rephrase ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°UI v2025.7.27-rollback
  </title>
  <link href="style.css" rel="stylesheet"/>
  <link href="css/voice_progress.css" rel="stylesheet"/>
  <!-- ğŸ“± ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–CSS -->
  <link href="mobile-split-view-simple.css" rel="stylesheet"/>
  <!-- ğŸ“± éŸ³å£°ãƒ‘ãƒãƒ« ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–CSS -->
  <link href="css/voice-panel-mobile.css" rel="stylesheet"/>
  <!-- ï¿½ éŸ³å£°é€²æ—è¡¨ç¤ºCSS -->
  <link href="css/voice_progress.css" rel="stylesheet"/>
  
  <!-- ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæœ€å„ªå…ˆå®Ÿè¡Œï¼‰ -->
  <script>
    // User-Agentãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒã‚¤ãƒ«æ¤œå‡ºï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
    (function() {
      console.log('ãƒ¢ãƒã‚¤ãƒ«æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹');
      console.log('User-Agent:', navigator.userAgent);
      console.log('ç”»é¢ã‚µã‚¤ã‚º:', window.innerWidth + 'x' + window.innerHeight);
      
      // ç”»é¢ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒã‚¤ãƒ«æ¤œå‡ºï¼ˆDevToolså¯¾å¿œï¼‰
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouchDevice = 'ontouchstart' in window;
      const isSmallScreen = window.innerWidth <= 768; // 768pxä»¥ä¸‹ã¯ãƒ¢ãƒã‚¤ãƒ«æ‰±ã„
      
      console.log('isMobile:', isMobile);
      console.log('isTouchDevice:', isTouchDevice);
      console.log('isSmallScreen:', isSmallScreen);
      
      // ã‚ˆã‚Šç·©ã„æ¡ä»¶ã§ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®šï¼ˆç”»é¢ã‚µã‚¤ã‚ºå„ªå…ˆï¼‰
      if (isMobile || isTouchDevice || isSmallScreen) {
        console.log('ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ');
        document.documentElement.classList.add('mobile-device');
        
        // åˆæœŸå‘ãè¨­å®š
        function setOrientation() {
          document.documentElement.classList.remove('portrait-mode', 'landscape-mode');
          if (window.innerHeight > window.innerWidth) {
            document.documentElement.classList.add('portrait-mode');
            console.log('ç¸¦ç”»é¢ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
          } else {
            document.documentElement.classList.add('landscape-mode');
            console.log('æ¨ªç”»é¢ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
          }
          console.log('ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹:', document.documentElement.className);
        }
        
        // DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setOrientation);
        } else {
          setOrientation();
        }
        
        // å‘ãå¤‰æ›´ã®ç›£è¦–
        window.addEventListener('orientationchange', function() {
          setTimeout(setOrientation, 100);
        });
        
        // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚å‘ãã‚’å†ç¢ºèª
        window.addEventListener('resize', function() {
          setTimeout(setOrientation, 100);
        });
      } else {
        console.log('PCãƒ‡ãƒã‚¤ã‚¹ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ');
      }
    })();
  </script>
  
  <!-- âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–CSS -->
  <style>
    /* ç”»åƒé…å»¶èª­ã¿è¾¼ã¿ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .slot-image {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .slot-image.loaded {
      opacity: 1;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
    .image-loading {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
  
  <!-- ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ€å„ªå…ˆã§èª­ã¿è¾¼ã¿ï¼‰ -->
  <script type="module">
    import { initSecurity } from './js/security.js';
    // DOMContentLoadedå‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆæœŸåŒ–
    initSecurity();
  </script>
  
  <!-- ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  -->
  <script>
    // ç°¡æ˜“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆindex.htmlç”¨ï¼‰
    window.securityUtils = {
        escapeHtml: function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        secureLocalStorageSet: function(key, data) {
            try {
                const jsonString = JSON.stringify(data);
                const encoded = btoa(jsonString);
                localStorage.setItem(key, encoded);
            } catch (error) {
                console.error('Storage set error:', error);
            }
        },
        
        secureLocalStorageGet: function(key) {
            try {
                const encoded = localStorage.getItem(key);
                if (!encoded) return null;
                
                const jsonString = atob(encoded);
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('Storage get error:', error);
                return null;
            }
        }
    };
  </script>
  <script src="js/rate-limiter.js"></script>
  <script src="js/error-handler.js"></script>
  <script src="js/auth.js"></script>

  <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ã®ç¢ºå®Ÿãªå®šç¾© -->
  <script>
    // å³åº§ã«é–¢æ•°ã‚’å®šç¾©ï¼ˆDOMContentLoadedã‚’å¾…ãŸãªã„ï¼‰
    console.log('ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ã‚’å³åº§ã«å®šç¾©ä¸­...');
    
    window.showUserError = function(errorCode, details) {
      console.log('ğŸ”§ showUserError called:', errorCode, details);
      if (window.errorHandler) {
        window.errorHandler.showUserFriendlyError(errorCode, details);
      } else {
        console.error('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        alert(`ã‚¨ãƒ©ãƒ¼: ${errorCode} - ${details}`);
      }
    };

    window.forceShowErrorModal = function(message) {
      console.log('ğŸ”§ forceShowErrorModal called:', message);
      if (window.errorHandler) {
        window.errorHandler.showUserFriendlyError('system.unknown', message || 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼');
      } else {
        console.error('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        alert(`ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${message}`);
      }
    };

    window.testErrorHandler = function() {
      console.log('ğŸ§ª ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹');
      console.log('ç¾åœ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:', document.readyState);
      console.log('errorHandler:', typeof window.errorHandler);
      console.log('showUserError:', typeof window.showUserError);
      console.log('forceShowErrorModal:', typeof window.forceShowErrorModal);
      
      // åŸºæœ¬ãƒ†ã‚¹ãƒˆ
      console.log('ğŸ“ åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
      window.showUserError('auth.invalid_credentials', 'ãƒ†ã‚¹ãƒˆç”¨èªè¨¼ã‚¨ãƒ©ãƒ¼');
    };

    window.checkErrorHandlerStatus = function() {
      console.log('ğŸ” ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:');
      console.log('  - window.errorHandler:', !!window.errorHandler);
      console.log('  - errorHandler type:', typeof window.errorHandler);
      if (window.errorHandler) {
        console.log('  - getErrorLog:', typeof window.errorHandler.getErrorLog);
        console.log('  - showUserFriendlyError:', typeof window.errorHandler.showUserFriendlyError);
        console.log('  - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ä»¶æ•°:', window.errorHandler.getErrorLog(1).length);
      }
    };

    console.log('âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ã‚’å³åº§ã«å®šç¾©ã—ã¾ã—ãŸ');
    console.log('ğŸ§ª åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:');
    console.log('  - window.testErrorHandler()');
    console.log('  - window.checkErrorHandlerStatus()');
    console.log('  - window.showUserError("auth.invalid_credentials")');
    console.log('  - window.forceShowErrorModal("ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")');

    // ğŸ” ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ã®éš ã—ã‚¢ã‚¯ã‚»ã‚¹
    window.showAdminPanel = function() {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) {
        adminPanel.style.display = 'flex';
        console.log('ğŸ” ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        console.log('ğŸ›¡ï¸ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: rate-limit-dashboard.html');
        console.log('âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: error-dashboard.html');
      }
    };

    window.hideAdminPanel = function() {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) {
        adminPanel.style.display = 'none';
        console.log('ğŸ” ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
      }
    };

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆCtrl+Shift+Aï¼‰ã§ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'A') {
        event.preventDefault();
        const adminPanel = document.getElementById('adminPanel');
        if (adminPanel) {
          if (adminPanel.style.display === 'none' || !adminPanel.style.display) {
            window.showAdminPanel();
          } else {
            window.hideAdminPanel();
          }
        }
      }
    });

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®ç®¡ç†è€…ãƒ‘ãƒãƒ«è¡¨ç¤º
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('admin') === 'true') {
      setTimeout(() => window.showAdminPanel(), 1000);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“± DOMèª­ã¿è¾¼ã¿å®Œäº† - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æœ€çµ‚ãƒã‚§ãƒƒã‚¯');
      window.checkErrorHandlerStatus();
    });
  </script>
  
  <!-- âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–JavaScript -->
  <script>
    // ç”»åƒé…å»¶èª­ã¿è¾¼ã¿æ©Ÿèƒ½
    window.RephraseImageOptimizer = {
      init: function() {
        this.setupLazyLoading();
        this.optimizeExistingImages();
      },
      
      // æ—¢å­˜ã®ç”»åƒã‚’æœ€é©åŒ–
      optimizeExistingImages: function() {
        const images = document.querySelectorAll('.slot-image');
        images.forEach(img => {
          // loading="lazy"å±æ€§ã‚’è¿½åŠ 
          img.setAttribute('loading', 'lazy');
          
          // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          img.addEventListener('load', () => {
            img.classList.add('loaded');
            img.classList.remove('image-loading');
          });
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
          img.addEventListener('error', () => {
            img.style.display = 'none';
            console.warn('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', img.src);
          });
          
          // åˆæœŸçŠ¶æ…‹ã§ã¯é€æ˜
          if (!img.complete) {
            img.classList.add('image-loading');
          } else {
            img.classList.add('loaded');
          }
        });
      },
      
      // æ–°ã—ãè¿½åŠ ã•ã‚Œã‚‹ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿è¨­å®š
      setupLazyLoading: function() {
        // MutationObserverã§æ–°ã—ã„ç”»åƒã‚’ç›£è¦–
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === 1) { // Element node
                const images = node.querySelectorAll ? node.querySelectorAll('img') : [];
                images.forEach(img => {
                  img.setAttribute('loading', 'lazy');
                  img.addEventListener('load', () => {
                    img.classList.add('loaded');
                  });
                });
              }
            });
          });
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
    };
    
    // DOMContentLoadedæ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      window.RephraseImageOptimizer.init();
      console.log('âš¡ ç”»åƒæœ€é©åŒ–ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
    });
  </script>
  
  <script src="js/subslot_toggle.js">
  </script>
  <script src="js/randomizer_individual.js">
  </script>
  <script src="js/control_panel_manager.js">
  </script>
  <script src="js/visibility_control.js">
  </script>
  <script src="js/subslot_visibility_control.js">
  </script>
  <script src="js/image_auto_hide.js">
  </script>
  <script src="js/universal_image_system.js">
  </script>
  <script src="js/question_word_visibility.js">
  </script>
  <script src="js/voice_system.js">
  </script>
  <script src="js/voice_progress_tracker.js">
  </script>
  <script src="js/voice_progress_ui.js">
  </script>
  <script src="js/explanation_system.js">
  </script>
  <script src="js/zoom_controller.js">
  </script>
 </head>
 <body>

<!-- ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
<script>
// ğŸš§ é–‹ç™ºæ™‚ã®èªè¨¼ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ï¼ˆæœ¬ç•ªæ™‚ã¯falseã«ã™ã‚‹ï¼‰
const SKIP_AUTH_FOR_DEVELOPMENT = true;

document.addEventListener('DOMContentLoaded', function() {
    if (SKIP_AUTH_FOR_DEVELOPMENT) {
        console.log('ğŸš§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ - èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
    }
    
    console.log('ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹');
    
    // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    function waitForAuth() {
        console.log('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªä¸­...', {
            authSystem: !!window.authSystem,
            securityUtils: !!window.securityUtils
        });
        
        if (window.authSystem && window.securityUtils) {
            console.log('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            const isLoggedIn = window.authSystem.isLoggedIn();
            console.log('ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹:', isLoggedIn);
            
            if (!isLoggedIn) {
                console.log('æœªãƒ­ã‚°ã‚¤ãƒ³ - auth.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                try {
                    window.location.href = './auth.html';
                } catch (error) {
                    console.warn('ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯è­¦å‘Šã®ã¿è¡¨ç¤º
                    if (window.errorHandler) {
                        window.errorHandler.handleError(error, { action: 'auth_redirect' }, 'auth.session_expired');
                    }
                }
                return;
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const user = window.authSystem.getCurrentUser();
            console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user);
            
            if (user) {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                const nav = document.querySelector('div[style*="position: fixed; top: 10px; left: 10px"]');
                if (nav) {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿½åŠ ');
                    const userInfo = document.createElement('div');
                    userInfo.innerHTML = `
                        <span style="color: #ccc;">|</span>
                        <span style="font-size: 12px; color: #333;">ğŸ‘¤ ${user.username}</span>
                        <button onclick="handleLogout()" style="background: #dc3545; color: white; border: none; padding: 2px 6px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: 4px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    `;
                    nav.appendChild(userInfo);
                } else {
                    console.warn('ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }
        } else {
            // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯100mså¾Œã«å†è©¦è¡Œ
            setTimeout(waitForAuth, 100);
        }
    }
    
    // èªè¨¼ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
    if (!SKIP_AUTH_FOR_DEVELOPMENT) {
        waitForAuth();
    }
});

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
function handleLogout() {
    if (window.authSystem && confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ');
        window.authSystem.logout();
        window.location.href = './auth.html';
    }
}
</script>

<!-- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ -->
<div id="navigation-float-menu" style="position: fixed; top: 5px; left: 5px; z-index: 16000; background: rgba(255,255,255,0.9); padding: 4px 6px; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 6px; height: 28px; white-space: nowrap; overflow-x: auto; overflow-y: hidden; flex-wrap: nowrap; scrollbar-width: none; -ms-overflow-style: none;">
  <a href="../" style="text-decoration: none; color: #2196F3; font-size: 14px; font-weight: bold; flex-shrink: 0;">ğŸ  ãƒ›ãƒ¼ãƒ </a>
  <span style="color: #ccc; flex-shrink: 0; font-size: 12px;">|</span>
  <a href="grammar/" style="text-decoration: none; color: #2196F3; font-size: 14px; flex-shrink: 0;">ğŸ“š æ–‡æ³•</a>
  <span style="color: #ccc; flex-shrink: 0; font-size: 12px;">|</span>
  
  <!-- ğŸ” ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½ï¼ˆéš ã—æ©Ÿèƒ½ï¼‰ -->
  <div id="adminPanel" style="display: none; align-items: center; gap: 6px; flex-shrink: 0;">
    <a href="rate-limit-dashboard.html" style="text-decoration: none; color: #ff6b35; font-size: 14px; flex-shrink: 0;">ğŸ›¡ï¸ ç›£è¦–</a>
    <a href="error-dashboard.html" style="text-decoration: none; color: #ff6b35; font-size: 14px; flex-shrink: 0;">âš ï¸ ã‚¨ãƒ©ãƒ¼</a>
    <span style="color: #ccc; flex-shrink: 0; font-size: 12px;">|</span>
  </div>
  
  <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿é¸æŠ -->
  <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
    <label style="font-size: 12px; font-weight: bold; color: #333; white-space: nowrap;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿</label>
    <select id="presetSelect" style="width: 120px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; height: 20px;">
      <option value="">-- é¸æŠ --</option>
      <option value="data/slot_order_data.json">ğŸ¯ ãƒ¡ã‚¤ãƒ³</option>
      <option value="data/slot_order_data2.json">ğŸ“š ä¾‹æ–‡2</option>
    </select>
    <button id="loadPresetButton" style="background-color: #4CAF50; color: white; border: none; padding: 2px 6px; font-size: 11px; cursor: pointer; border-radius: 3px; font-weight: bold; white-space: nowrap; flex-shrink: 0; height: 20px;">èª­è¾¼</button>
  </div>
  
  <!-- ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
  <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
    <label style="font-size: 12px; font-weight: bold; color: #333; white-space: nowrap;">ğŸ” ã‚ºãƒ¼ãƒ </label>
    <input type="range" id="zoomSlider" min="0.5" max="1.5" step="0.1" value="1.0" style="width: 80px; height: 18px; cursor: pointer; flex-shrink: 0;">
    <span id="zoomValue" style="font-size: 11px; color: #666; min-width: 35px; text-align: center; white-space: nowrap; flex-shrink: 0;">100%</span>
    <button id="zoomResetButton" style="background-color: #FF9800; color: white; border: none; padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; font-weight: bold; white-space: nowrap; flex-shrink: 0; height: 18px;">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<style>
/* ãƒ•ãƒ­ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
#navigation-float-menu::-webkit-scrollbar {
  display: none;
}
</style>

<!-- ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå¼·åŒ–ç‰ˆï¼‰ -->
<div id="loading-overlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  z-index: 8000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  pointer-events: none;
  transition: opacity 0.5s ease, visibility 0.5s ease;
">
  <div class="loading-content" style="text-align: center; pointer-events: auto; max-width: 400px; padding: 20px;">
    <!-- æ”¹å–„ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="loading-spinner" style="
      width: 80px;
      height: 80px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
      margin: 0 auto 24px;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    "></div>
    
    <!-- å‹•çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <h2 id="loading-title" style="margin: 0 0 12px 0; font-size: 24px; font-weight: 400;">
      ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...
    </h2>
    <p id="loading-description" style="margin: 0 0 16px 0; font-size: 14px; opacity: 0.9; line-height: 1.4;">
      JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
    </p>
    
    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div style="
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 16px;
    ">
      <div id="loading-progress" style="
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8));
        border-radius: 2px;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
      "></div>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ãƒ’ãƒ³ãƒˆ -->
    <div id="loading-tips" style="font-size: 12px; opacity: 0.7; text-align: left;">
      ğŸ’¡ <span id="loading-tip-text">é«˜é€ŸåŒ–æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™</span>
    </div>
  </div>
    </p>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ğŸŒŸ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å…‰æ²¢åŠ¹æœ */
@keyframes progress-shine {
  0% { 
    transform: translateX(-100%); 
    opacity: 0;
  }
  50% { 
    opacity: 1; 
  }
  100% { 
    transform: translateX(400%); 
    opacity: 0;
  }
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å†…ã®å…‰æ²¢è¦ç´  */
#loading-progress::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255,255,255,0.4), 
    transparent
  );
  animation: progress-shine 2.5s ease-in-out infinite;
  border-radius: 2px;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼å¼·åŒ– */
.loading-spinner {
  position: relative;
}

.loading-spinner::before {
  content: '';
  position: absolute;
  top: -6px;
  left: -6px;
  right: -6px;
  bottom: -6px;
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: 50%;
  animation: spin 2.5s linear infinite reverse;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³åŠ¹æœ */
.loading-content > * {
  animation: fadeInUp 0.6s ease-out forwards;
  opacity: 0;
  transform: translateY(20px);
}

.loading-content > *:nth-child(1) { animation-delay: 0.1s; }
.loading-content > *:nth-child(2) { animation-delay: 0.2s; }
.loading-content > *:nth-child(3) { animation-delay: 0.3s; }
.loading-content > *:nth-child(4) { animation-delay: 0.4s; }
.loading-content > *:nth-child(5) { animation-delay: 0.5s; }

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
<div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px; margin-top: 20px; position: relative; z-index: 10000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <h1 style="margin: 0; margin-right: 30px; color: #333; font-size: 28px; font-weight: bold;">
   ğŸ”„ Rephrase ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°UI
  </h1>
</div>

<!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã¾ã§éè¡¨ç¤ºï¼‰ -->
<div id="main-content" style="display: none;">

<!-- ğŸ”¹ åˆ†é›¢ç–‘å•è©ç”¨è¡¨ç¤ºé ˜åŸŸ -->
<div id="display-top-question-word">
  <div class="question-word-label">WH</div>
  <div class="question-word-image"></div>
  <div class="question-word-spacer"></div>
  <div class="question-word-auxtext"></div>
  <div class="question-word-text"></div>
  <div class="question-word-button-placeholder"></div>
  <div class="question-word-button-placeholder"></div>
</div>

  <section>
  </section>
  
  <!-- åˆ¶å¾¡ãƒ‘ãƒãƒ«è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
  <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px;">
    <button id="toggle-control-panels" style="
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      ğŸ“ åˆ¶å¾¡ãƒ‘ãƒãƒ«
    </button>
  </div>
  
  <!-- éŸ³å£°å­¦ç¿’ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šå›ºå®šï¼‰ -->
  <button id="voice-panel-open-btn" style="
    position: fixed;
    top: 60px;
    right: 10px;
    z-index: 15500;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 18px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
    min-width: 80px;
    min-height: 44px;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform='scale(1)'">
    ğŸ¤ éŸ³å£°å­¦ç¿’
  </button>
  
  <!-- ğŸ¯ ä¸Šä½ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºåˆ¶å¾¡ãƒ‘ãƒãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤ºï¼‰ -->
  <div id="visibility-control-panel-inline" style="display: none; background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 15px;">
      <div style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
        
        <!-- ç–‘å•è© ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="question-word" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">ç–‘å•è©</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="question-word" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="question-word" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- M1 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="m1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m1" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m1" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- S ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="s" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">S</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="s" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="s" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- Aux ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="aux" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">Aux</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="aux" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="aux" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- M2 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="m2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m2" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m2" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- V ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="v" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">V</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="v" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="v" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- C1 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="c1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">C1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c1" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c1" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- O1 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="o1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">O1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o1" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o1" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- O2 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="o2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">O2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o2" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o2" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- C2 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="c2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">C2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c2" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c2" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- M3 ã‚¹ãƒ­ãƒƒãƒˆ -->
        <div class="slot-control-group" data-slot="m3" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M3</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m3" data-type="auxtext" checked> ğŸ“è£œåŠ©</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m3" data-type="text" checked> ğŸ“„è‹±æ–‡</label>
          </div>
        </div>
        
        <!-- å…¨è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
        <button id="reset-all-visibility" style="background-color: #4CAF50; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: 8px;">å…¨è¡¨ç¤º</button>
        
        <!-- å…¨è‹±æ–‡éè¡¨ç¤ºãƒœã‚¿ãƒ³ -->
        <button id="hide-all-english-visibility" style="background-color: #f44336; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: 8px;">å…¨è‹±æ–‡éè¡¨ç¤º</button>
      </div>
    </div>
  </div>
  
  <!-- ğŸ¤– Androidå°‚ç”¨éŸ³å£°ãƒ‘ãƒãƒ« -->
  <div id="voice-control-panel-android" style="
    position: fixed !important;
    bottom: 20px !important;
    right: 10px !important;
    z-index: 15000 !important;
    background: rgba(255, 255, 255, 0.9) !important; 
    padding: 12px !important; 
    border-radius: 8px !important; 
    border: 2px solid rgba(200, 200, 200, 0.8) !important; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
    min-width: 280px !important;
    max-width: 320px !important;
    transition: all 0.3s ease !important;
    display: none !important;
    visibility: visible !important;
    opacity: 1 !important;
    min-height: auto !important;
    max-height: calc(100vh - 40px) !important;
    overflow-y: auto !important;
  ">
    <!-- AndroidåŸºæœ¬ãƒ‘ãƒãƒ«ï¼ˆå›ºå®šã‚µã‚¤ã‚ºï¼‰ -->
    <div id="voice-panel-basic-android" style="position: relative;">
      <div style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
        <h3 style="margin: 0; color: #333; font-size: 16px; font-weight: bold;">ğŸ¤– AndroidéŸ³å£°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </h3>
        <button id="voice-panel-close-btn-android" style="background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: auto;">âœ•</button>
      </div>
      
      <!-- Androidå°‚ç”¨éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
        <button id="voice-record-btn-android" class="voice-btn-android" onclick="alert('éŒ²éŸ³ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼')" style="background-color: #2196F3; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ¤ éŒ²éŸ³ã®ã¿</button>
        <button id="voice-play-btn-android" class="voice-btn-android" onclick="alert('å†ç”Ÿãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼')" style="background-color: #FF9800; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ”Š å†ç”Ÿ</button>
        <button id="voice-tts-btn-android" class="voice-btn-android" style="background-color: #9C27B0; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ—£ï¸ èª­ã¿ä¸Šã’</button>
        <button id="voice-analyze-btn-android" class="voice-btn-android" style="background-color: #E91E63; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ“Š åˆ†æ</button>
      </div>
      
      <!-- Androidå°‚ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div id="voice-status-android" class="voice-status-android info" style="color: #333; font-size: 11px; background: rgba(200, 200, 200, 0.3); padding: 3px 6px; border-radius: 12px; margin: 8px 0; text-align: center;">Androidå¾…æ©Ÿä¸­...</div>
      
      <!-- Androidå°‚ç”¨éŒ²éŸ³ã‚¿ã‚¤ãƒãƒ¼ -->
      <div style="text-align: center; margin: 8px 0;">
        <span style="color: #333; font-family: monospace; font-size: 14px; font-weight: bold;" id="voice-recording-timer-android">â±ï¸ 00:00</span>
      </div>
      
      <!-- Androidå°‚ç”¨éŸ³é‡ãƒãƒ¼ -->
      <div style="margin: 8px 0;">
        <div style="width: 100%; height: 6px; background: rgba(200,200,200,0.4); border-radius: 3px; overflow: hidden;">
          <div id="voice-volume-bar-android" style="height: 100%; background: #666; width: 0%; transition: width 0.1s;"></div>
        </div>
      </div>
      
      <!-- Androidå°‚ç”¨åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="voice-analysis-results-android" style="background: rgba(240,240,240,0.8); border-radius: 6px; padding: 8px; min-height: 30px; max-height: 400px; overflow-y: auto; color: #333; font-size: 11px; margin: 8px 0;">Androidåˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      
      <!-- Androidå°‚ç”¨é€²æ—è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
        <button id="voice-progress-btn-android" class="voice-btn-android" style="background-color: #607D8B; color: white; border: none; padding: 6px 12px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ“ˆ å­¦ç¿’é€²æ—</button>
        <button id="android-debug-btn" class="voice-btn-android" style="background-color: #795548; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°</button>
      </div>
      
      <!-- Androidå°‚ç”¨éŸ³å£°èªè­˜çŠ¶æ…‹è¡¨ç¤º -->
      <div id="mobile-voice-status-android" style="
        border-left: 4px solid #fff;
        background: rgba(255,255,255,0.1);
        padding: 6px;
        margin: 8px 0;
        border-radius: 3px;
        color: #fff;
        font-size: 10px;
        display: none;
      ">AndroidéŸ³å£°èªè­˜çŠ¶æ…‹</div>
    </div>
  </div>

  <!-- ğŸ’» é€šå¸¸ç‰ˆéŸ³å£°ãƒ‘ãƒãƒ« -->
  <div id="voice-control-panel" style="
    position: fixed !important;
    top: 120px !important;
    right: 10px !important;
    z-index: 15000 !important;
    background: rgba(255, 255, 255, 0.95) !important; 
    padding: 12px !important; 
    border-radius: 8px !important; 
    border: 2px solid #667eea !important; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
    min-width: 280px !important;
    max-width: 320px !important;
    transition: all 0.3s ease !important;
    display: none !important;
    visibility: visible !important;
    opacity: 1 !important;
    min-height: auto !important;
    max-height: calc(100vh - 140px) !important;
    overflow-y: auto !important;
  ">
    <!-- åŸºæœ¬ãƒ‘ãƒãƒ«ï¼ˆå›ºå®šã‚µã‚¤ã‚ºï¼‰ -->
    <div id="voice-panel-basic" style="position: relative;">
      <div style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
        <h3 style="margin: 0; color: #333; font-size: 16px; font-weight: bold;">ğŸ¤ éŸ³å£°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </h3>
        <button id="voice-panel-close-btn" style="background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: auto;">âœ•</button>
      </div>
      
      <!-- éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
        <button id="voice-record-btn" class="voice-btn" style="background-color: #4CAF50; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ¤ éŒ²éŸ³</button>
        <button id="voice-play-btn" class="voice-btn" style="background: linear-gradient(135deg, #fffbeb, #fef3c7); color: #78716c; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ”Š å†ç”Ÿ</button>
        <button id="voice-tts-btn" class="voice-btn" style="background-color: #FF9800; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ—£ï¸ èª­ã¿ä¸Šã’</button>
        <button id="voice-analyze-btn" class="voice-btn" style="background-color: #9C27B0; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ“Š åˆ†æ</button>
        <button id="voice-stop-btn" class="voice-btn" style="display: none; background-color: #f44336; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">â¹ï¸ åœæ­¢</button>
      </div>
      
      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div id="voice-status" class="voice-status info" style="color: #333; font-size: 11px; background: rgba(76, 175, 80, 0.1); padding: 3px 6px; border-radius: 12px; margin: 8px 0; text-align: center;">å¾…æ©Ÿä¸­...</div>
      
      <!-- éŒ²éŸ³ã‚¿ã‚¤ãƒãƒ¼ -->
      <div style="text-align: center; margin: 8px 0;">
        <span style="color: #333; font-family: monospace; font-size: 14px; font-weight: bold;" id="voice-recording-timer">â±ï¸ 00:00</span>
      </div>
      
      <!-- éŸ³é‡ãƒãƒ¼ -->
      <div style="margin: 8px 0;">
        <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden;">
          <div id="voice-volume-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722); width: 0%; transition: width 0.1s ease;"></div>
        </div>
      </div>
      
      <!-- åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆåŸºæœ¬ãƒ‘ãƒãƒ«å†…ï¼‰ -->
      <div id="voice-analysis-results" style="background: rgba(0,0,0,0.05); border-radius: 6px; padding: 8px; min-height: 30px; max-height: 400px; overflow-y: auto; color: #333; font-size: 11px; margin: 8px 0;">åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      
      <!-- é€²æ—è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
        <button id="voice-progress-btn" class="voice-btn" style="background-color: #607D8B; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px;">ğŸ“Š å­¦ç¿’é€²æ—</button>
        <!-- ğŸ“± ã‚¹ãƒãƒ›ç”¨ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
        <button id="mobile-debug-btn" class="voice-btn" style="
          background-color: #17a2b8; 
          color: white; 
          border: none; 
          padding: 6px 10px; 
          font-size: 11px; 
          cursor: pointer; 
          border-radius: 3px;
          display: block;
        ">ğŸ“± ãƒ‡ãƒãƒƒã‚°</button>
      </div>
      
      <!-- ğŸ“± ã‚¹ãƒãƒ›ç”¨éŸ³å£°èªè­˜çŠ¶æ…‹è¡¨ç¤º -->
      <div id="mobile-voice-status" style="
        margin-top: 10px; 
        padding: 8px; 
        background-color: #f8f9fa; 
        border-radius: 4px; 
        font-size: 12px; 
        display: none;
        border-left: 4px solid #007bff;
      ">
        ğŸ¤ éŸ³å£°èªè­˜çŠ¶æ…‹: åˆæœŸåŒ–ä¸­...
      </div>
    </div>
  </div>
  
  <!-- ğŸš€ ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨éŸ³å£°ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1: éŸ³å£°èªè­˜ã®ã¿ï¼‰ -->
  <div id="voice-debug-panel" style="
    position: fixed !important;
    top: 10px !important;
    left: 10px !important;
    right: 10px !important;
    z-index: 25000 !important;
    background: white !important;
    border-radius: 15px !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3) !important;
    max-height: 70vh !important;
    overflow-y: auto !important;
    display: none !important;
  " class="mobile-voice-debug-panel">
    <!-- ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ãŒã“ã“ã«å†…å®¹ã‚’å‹•çš„ç”Ÿæˆ -->
  </div>
  
  <section>
   <button id="randomize-all" style="
     background: linear-gradient(135deg, #8e44ad 0%, #e74c3c 100%);
     color: white;
     border: none;
     padding: 12px 20px;
     border-radius: 5px;
     cursor: pointer;
     font-size: 16px;
     font-weight: bold;
     box-shadow: 0 4px 12px rgba(0,0,0,0.2);
     transition: all 0.2s ease;
     margin-bottom: 20px;
   " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    ğŸ² ä¾‹æ–‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«
   </button>
   <h2 style="margin-bottom: 15px; margin-top: 20px;">
    ä¾‹æ–‡
   </h2>

   <div class="slot-wrapper">
    <div class="slot-container" id="slot-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m1">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m1-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="s">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="s-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="slot-container" id="slot-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m2">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m2-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="slot-container" id="slot-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="c1">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="c1-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="o1">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="o1-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="o2">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="o2-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="c2">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="c2-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
    <div class="slot-container" id="slot-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m3">â–¼ è©³ç´°</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m3-individual-randomize-btn">ğŸ²</button>
     </div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-o1-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šO1 ã® subslot
    </div>
    <div class="subslot-container" id="slot-o1-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m1-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šM1 ã® subslot
    </div>
    <div class="subslot-container" id="slot-m1-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-o2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šO2 ã® subslot
    </div>
    <div class="subslot-container" id="slot-o2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šM2 ã® subslot
    </div>
    <div class="subslot-container" id="slot-m2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-c2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šC2 ã® subslot
    </div>
    <div class="subslot-container" id="slot-c2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m3-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     ç¾åœ¨å±•é–‹ä¸­ï¼šM3 ã® subslot
    </div>
    <div class="subslot-container" id="slot-m3-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
  </section>
  <div class="slot-wrapper" id="slot-s-sub" style="display: none;">
   <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
    ç¾åœ¨å±•é–‹ä¸­ï¼šS ã® subslot
   </div>
   <div class="subslot-container" id="slot-s-sub-m1">
    <label>M1</label>
    <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-s">
    <label>S</label>
    <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-aux">
    <label>AUX</label>
    <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-m2">
    <label>M2</label>
    <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-v">
    <label>V</label>
    <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-c1">
    <label>C1</label>
    <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-o1">
    <label>O1</label>
    <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-o2">
    <label>O2</label>
    <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-c2">
    <label>C2</label>
    <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-m3">
    <label>M3</label>
    <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
  </div>
  <div class="slot-wrapper" id="slot-c1-sub" style="display: none;">
   <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
    ç¾åœ¨å±•é–‹ä¸­ï¼šC1 ã® subslot
   </div>
   <div class="subslot-container" id="slot-c1-sub-m1">
    <label>M1</label>
    <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-s">
    <label>S</label>
    <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-aux">
    <label>AUX</label>
    <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-m2">
    <label>M2</label>
    <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-v">
    <label>V</label>
    <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-c1">
    <label>C1</label>
    <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-o1">
    <label>O1</label>
    <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-o2">
    <label>O2</label>
    <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-c2">
    <label>C2</label>
    <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-m3">
    <label>M3</label>
    <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
  </div>
  
  
<script src="js/insert_test_data_clean.js"></script>

<!-- å‹•çš„è¨˜è¼‰ã‚¨ãƒªã‚¢ç”¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ã‚’è¿½åŠ  -->
<section id="dynamic-area-container" style="margin-top: 30px;">
  <button id="toggle-dynamic-area" style="background-color: #4CAF50; color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;">
    â–¼ è§£ç­”å…¨æ–‡
  </button>
  <!-- å‹•çš„è¨˜è¼‰ã‚¨ãƒªã‚¢ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
  <div id="dynamic-slot-area-wrapper" style="display: none;"></div>
</section>

<script>
  // å‹•çš„ã‚¨ãƒªã‚¢ã®ç”Ÿæˆä½ç½®ã‚’æŒ‡å®š
  window.addEventListener("DOMContentLoaded", () => {
    const dynamicArea = document.getElementById("dynamic-slot-area");
    const wrapper = document.getElementById("dynamic-slot-area-wrapper");
    
    // æ—¢å­˜ã®dynamic-slot-areaãŒã‚ã‚Œã°ç§»å‹•
    if (dynamicArea && wrapper) {
      // å‹•çš„ã‚¨ãƒªã‚¢ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã«ç§»å‹•
      wrapper.appendChild(dynamicArea);
      
      // ã•ã‚‰ã«ã€å‹•çš„ã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’æ–‡æ›¸ã®æœ«å°¾ã«ç§»å‹•
      const container = document.getElementById("dynamic-area-container");
      if (container) {
        document.body.appendChild(container);
        console.log("âœ… å‹•çš„è¨˜è¼‰ã‚¨ãƒªã‚¢ã‚³ãƒ³ãƒ†ãƒŠã‚’æ–‡æ›¸ã®æœ€å¾Œã«ç§»å‹•ã—ã¾ã—ãŸ");
      }
      
      console.log("âœ… å‹•çš„è¨˜è¼‰ã‚¨ãƒªã‚¢ã‚’é©åˆ‡ãªä½ç½®ã«ç§»å‹•ã—ã¾ã—ãŸ");
    } else {
      console.warn("âš  å‹•çš„è¨˜è¼‰ã‚¨ãƒªã‚¢ã¾ãŸã¯ãƒ©ãƒƒãƒ‘ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }
  });

  // è§£ç­”å…¨æ–‡ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
  document.getElementById("toggle-dynamic-area").addEventListener("click", () => {
    const wrapper = document.getElementById("dynamic-slot-area-wrapper");
    const button = document.getElementById("toggle-dynamic-area");
    
    if (wrapper.style.display === "none") {
      wrapper.style.display = "block";
      button.textContent = "â–² è§£ç­”å…¨æ–‡";
      button.style.backgroundColor = "#f44336"; // èµ¤è‰²ï¼ˆé–‰ã˜ã‚‹çŠ¶æ…‹ï¼‰
      console.log("âœ… è§£ç­”å…¨æ–‡ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
    } else {
      wrapper.style.display = "none";
      button.textContent = "â–¼ è§£ç­”å…¨æ–‡";
      button.style.backgroundColor = "#4CAF50"; // ç·‘è‰²ï¼ˆé–‹ãçŠ¶æ…‹ï¼‰
      console.log("âœ… è§£ç­”å…¨æ–‡ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ");
    }
  });

  // syncDynamicToStatic() ã‚’DOMæç”»å®Œäº†å¾Œã«é…å»¶å®Ÿè¡Œ
  window.addEventListener("load", () => {
    // ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’æ˜ç¤ºçš„ã«åˆæœŸåŒ–ï¼ˆå†åº¦å®Ÿè¡Œã—ã¦ç¢ºå®Ÿã«é–‰ã˜ã‚‹ï¼‰
    if (typeof initializeSubslots === 'function') {
      console.log("ğŸ”’ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆæœŸåŒ–");
      initializeSubslots();
    }
    
    setTimeout(() => {
      console.log("ğŸš€ syncDynamicToStatic() é…å»¶å‘¼ã³å‡ºã—");
      if (typeof syncDynamicToStatic === "function") {
        syncDynamicToStatic();
      } else {
        console.warn("âš  syncDynamicToStatic é–¢æ•°ãŒæœªå®šç¾©ã§ã™");
      }
    }, 200);
  });
</script>

<script>
        function loadScript(src) {
          const script = document.createElement('script');
          script.src = src;
          document.head.appendChild(script);
        }
      </script>
</div> <!-- main-content ã®çµ‚äº† -->

    <!-- æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script type="module">
import { randomizeAll, randomizeAllWithStateManagement } from './js/randomizer_all.js';
import { buildStructure } from './js/structure_builder.js';

let loadedJsonData = null;

// ğŸ¯ **ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ©Ÿèƒ½**
document.getElementById("loadPresetButton").addEventListener("click", () => {
  const presetSelect = document.getElementById("presetSelect");
  const selectedPreset = presetSelect.value;
  
  if (!selectedPreset) {
    alert("ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  
  // ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º
  console.log("ğŸ­ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰é–‹å§‹ - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º");
  showLoadingOverlay();
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
  const loadingText = document.querySelector('#loading-overlay p');
  if (loadingText) {
    loadingText.textContent = `${selectedPreset} ã‚’èª­ã¿è¾¼ã¿ä¸­...`;
  }
  
  // ğŸ¯ **ä¿®æ­£ï¼šJSONãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼ˆCORSã‚¨ãƒ©ãƒ¼å›é¿ï¼‰**
  let presetData = null;
  
  if (selectedPreset.startsWith('data/') && selectedPreset.endsWith('.json')) {
    // ğŸ¯ **ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼šfetchã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿**
    fetch(selectedPreset)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’ç›´æ¥å®Ÿè¡Œ
        try {
          // ğŸ”„ JSONãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
          localStorage.removeItem('rephrase_subslot_visibility_state');
          console.log('ğŸ“ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
          
          loadedJsonData = data;
          window.loadedJsonData = loadedJsonData;  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªç”¨
          console.log("ğŸŸ¢ window.loadedJsonData ã‚»ãƒƒãƒˆå®Œäº†:", window.loadedJsonData);
          
          // ğŸ” ãƒ‡ãƒãƒƒã‚°ï¼šãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
          console.log("ğŸ” ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå‰ã®loadedJsonDataã®æœ€åˆã®5ä»¶:", loadedJsonData.slice(0, 5));
          
          // ğŸ¯ **é‡è¤‡å›é¿æ©Ÿèƒ½ä»˜ããƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã‚’å®Ÿè¡Œ**
          const processedData = randomizeAllWithStateManagement(loadedJsonData);
          console.log("ğŸ¯ é‡è¤‡å›é¿ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºçµæœè©³ç´°:", JSON.stringify(processedData, null, 2));
          
          // ğŸ” ãƒ‡ãƒãƒƒã‚°ï¼šãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã®processedDataã‚’ç¢ºèª
          console.log("ğŸ” ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã®processedDataã®æœ€åˆã®5ä»¶:", processedData.slice(0, 5));
          console.log("ğŸ” processedDataã®ä¸Šä½ã‚¹ãƒ­ãƒƒãƒˆï¼ˆM1ï¼‰:", processedData.filter(item => item.Slot === 'M1' && !item.SubslotID));
          
          validateSlotsModified(processedData);
          
          // ğŸ¯ ä¿®æ­£ï¼šãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´
          window.loadedJsonData = processedData;
          
          // ğŸ¤ éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ç”¨: processedDataã‚’window.lastSelectedSlotsã«ã‚‚ä¿å­˜
          // ï¼ˆrandomizeAllå†…ã§è¨­å®šã•ã‚ŒãŸwindow.lastSelectedSlotsã‚’ä¿æŒï¼‰
          console.log("ğŸ¤ éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ç”¨ lastSelectedSlotsç¢ºèª:", window.lastSelectedSlots ? `${window.lastSelectedSlots.length}ä»¶` : 'æœªè¨­å®š');
          
          // æ§‹é€ ã‚’æ§‹ç¯‰ï¼ˆprocessedDataã¯è¡¨ç¤ºç”¨ã€lastSelectedSlotsã¯éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ç”¨ã¨ã—ã¦åˆ†é›¢ï¼‰
          buildStructure(processedData);
          syncDynamicToStatic();
          
          // ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®åˆæœŸåŒ–ã‚‚å®Ÿè¡Œ
          if (typeof initializeSubslots === 'function') {
            console.log("ğŸ”’ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰å¾Œã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆæœŸåŒ–");
            initializeSubslots();
          }
          
          // æ˜ç¤ºçš„ã«ä¸Šä½ã‚¹ãƒ­ãƒƒãƒˆã¨ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®åŒæœŸã‚’å‘¼ã³å‡ºã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜å‡¦ç†ï¼‰
          if (typeof syncUpperSlotsFromJson === 'function') {
            console.log("ğŸ”„ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰å¾Œã®æ˜ç¤ºçš„åŒæœŸå‘¼ã³å‡ºã—");
            syncUpperSlotsFromJson(processedData);
            if (typeof syncSubslotsFromJson === 'function') {
              syncSubslotsFromJson(processedData);
            }
            
            // è¡¨ç¤ºé †åˆ¶å¾¡æ©Ÿèƒ½ã®å‘¼ã³å‡ºã—
            if (typeof applyOrderToAllSlots === 'function') {
              console.log("ğŸ”¢ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰å¾Œã«ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºé †é©ç”¨");
              applyOrderToAllSlots(processedData);
            }
            
            if (typeof debugM1Slot === 'function') {
              console.log("ğŸ” M1ã‚¹ãƒ­ãƒƒãƒˆã®ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ");
              debugM1Slot();
            }
          }
          
          // ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
          console.log("ğŸ­ ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ­ãƒ¼ãƒ‰å®Œäº† - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º");
          hideLoadingOverlay();
        } catch (error) {
          console.error("ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—:", error);
          if (window.errorHandler) {
            window.errorHandler.handleError(error, { action: 'preset_json_processing' }, 'data.load_failed');
          } else {
            alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆJSONãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
          }
          hideLoadingOverlay();
        }
      })
      .catch(error => {
        console.error(`${selectedPreset}ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:`, error);
        if (window.errorHandler) {
          window.errorHandler.handleError(error, { action: 'preset_json_loading', preset: selectedPreset }, 'network.connection_failed');
        } else {
          alert(`ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‹ã‚‰å¯¾å¿œã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`);
        }
        hideLoadingOverlay();
      });
    return; // æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
  } else {
    if (window.errorHandler) {
      window.errorHandler.handleError(new Error('Unknown preset selected'), { preset: selectedPreset }, 'data.validation_failed');
    } else {
      alert("ä¸æ˜ãªãƒ—ãƒªã‚»ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¾ã—ãŸ");
    }
    hideLoadingOverlay();
    return;
  }
});

document.getElementById("randomize-all").addEventListener("click", () => {
  if (!loadedJsonData || !Array.isArray(loadedJsonData)) {
    alert("å…ˆã«æ­£ã—ã„JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");
    console.error("âŒ å…¨ä½“ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºï¼šãƒ­ãƒ¼ãƒ‰æ¸ˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã¾ãŸã¯æœªãƒ­ãƒ¼ãƒ‰");
    return;
  }
  
  // ğŸ¯ **é‡è¤‡å›é¿æ©Ÿèƒ½ä»˜ããƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã‚’å®Ÿè¡Œ**
  const data = randomizeAllWithStateManagement(loadedJsonData);
  console.log("ğŸ¯ é‡è¤‡å›é¿ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºçµæœè©³ç´°ï¼ˆå…¨ä½“ãƒœã‚¿ãƒ³ï¼‰:", JSON.stringify(data, null, 2));
  validateSlotsModified(data);
  window.loadedJsonData = data;
  buildStructure(data);
  syncDynamicToStatic();
  
  // ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã®åˆæœŸåŒ–ã‚‚å®Ÿè¡Œ
  if (typeof initializeSubslots === 'function') {
    console.log("ğŸ”’ ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã«ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆæœŸåŒ–");
    initializeSubslots();
  }
  
  // ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã‚‚è¡¨ç¤ºé †åˆ¶å¾¡ã‚’é©ç”¨
  if (typeof applyOrderToAllSlots === 'function') {
    console.log("ğŸ”¢ ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã®ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºé †é©ç”¨");
    applyOrderToAllSlots(data);
  }
});

// Sã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const sIndividualBtn = document.querySelector(".s-individual-randomize-btn");
  if (sIndividualBtn) {
    sIndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² Sã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotSIndividual === "function") {
        window.randomizeSlotSIndividual();
      } else {
        console.error("âŒ randomizeSlotSIndividualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: Sã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… Sã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ Sã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// M1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const m1IndividualBtn = document.querySelector(".m1-individual-randomize-btn");
  if (m1IndividualBtn) {
    m1IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² M1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotM1Individual === "function") {
        window.randomizeSlotM1Individual();
      } else {
        console.error("âŒ randomizeSlotM1Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: M1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… M1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ M1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// M2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const m2IndividualBtn = document.querySelector(".m2-individual-randomize-btn");
  if (m2IndividualBtn) {
    m2IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² M2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotM2Individual === "function") {
        window.randomizeSlotM2Individual();
      } else {
        console.error("âŒ randomizeSlotM2Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: M2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… M2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ M2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// C1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const c1IndividualBtn = document.querySelector(".c1-individual-randomize-btn");
  if (c1IndividualBtn) {
    c1IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² C1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotC1Individual === "function") {
        window.randomizeSlotC1Individual();
      } else {
        console.error("âŒ randomizeSlotC1Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: C1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… C1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ C1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// O1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const o1IndividualBtn = document.querySelector(".o1-individual-randomize-btn");
  if (o1IndividualBtn) {
    o1IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² O1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotO1Individual === "function") {
        window.randomizeSlotO1Individual();
      } else {
        console.error("âŒ randomizeSlotO1Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: O1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… O1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ O1ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// O2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const o2IndividualBtn = document.querySelector(".o2-individual-randomize-btn");
  if (o2IndividualBtn) {
    o2IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² O2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotO2Individual === "function") {
        window.randomizeSlotO2Individual();
      } else {
        console.error("âŒ randomizeSlotO2Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: O2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… O2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ O2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// C2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const c2IndividualBtn = document.querySelector(".c2-individual-randomize-btn");
  if (c2IndividualBtn) {
    c2IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² C2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotC2Individual === "function") {
        window.randomizeSlotC2Individual();
      } else {
        console.error("âŒ randomizeSlotC2Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: C2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… C2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ C2ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// M3ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
document.addEventListener("DOMContentLoaded", () => {
  const m3IndividualBtn = document.querySelector(".m3-individual-randomize-btn");
  if (m3IndividualBtn) {
    m3IndividualBtn.addEventListener("click", () => {
      console.log("ğŸ² M3ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
      if (typeof window.randomizeSlotM3Individual === "function") {
        window.randomizeSlotM3Individual();
      } else {
        console.error("âŒ randomizeSlotM3Individualé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        alert("ã‚¨ãƒ©ãƒ¼: M3ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      }
    });
    console.log("âœ… M3ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ M3ã‚¹ãƒ­ãƒƒãƒˆå€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
});

// ğŸ¯ **å…¨ä½“ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã®é‡è¤‡å›é¿ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†**
window.currentRandomizedState = {
  vGroupKey: null,           // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹V_group_key
  exampleId: null,           // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ä¾‹æ–‡ID
  lastRandomizedTime: null,  // æœ€å¾Œã«ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºã•ã‚ŒãŸæ™‚åˆ»
  selectedSlots: []          // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±
};

// ğŸ¯ **é‡è¤‡å›é¿ç”¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†**
window.randomizeHistory = {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
  load: function() {
    try {
      const saved = localStorage.getItem('rephrase_randomize_history');
      if (saved) {
        const parsed = JSON.parse(saved);
        return {
          vGroupKeys: parsed.vGroupKeys || [],
          exampleIds: parsed.exampleIds || [],
          maxHistorySize: 3 // æœ€è¿‘3å›ã®å±¥æ­´ã‚’ä¿æŒ
        };
      }
    } catch (error) {
      console.log('é‡è¤‡å›é¿å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
    }
    return {
      vGroupKeys: [],
      exampleIds: [],
      maxHistorySize: 3
    };
  },
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å±¥æ­´ã‚’ä¿å­˜
  save: function(vGroupKey, exampleId) {
    try {
      console.log('ğŸ¯ [ãƒ‡ãƒãƒƒã‚°] å±¥æ­´ä¿å­˜è©¦è¡Œ:', { vGroupKey, exampleId });
      const history = this.load();
      
      // æ–°ã—ã„é¸æŠã‚’å±¥æ­´ã«è¿½åŠ 
      if (vGroupKey) {
        history.vGroupKeys.push(vGroupKey);
        if (history.vGroupKeys.length > history.maxHistorySize) {
          history.vGroupKeys.shift(); // å¤ã„å±¥æ­´ã‚’å‰Šé™¤
        }
        console.log('ğŸ¯ [ãƒ‡ãƒãƒƒã‚°] vGroupKeyå±¥æ­´æ›´æ–°:', history.vGroupKeys);
      } else {
        console.log('ğŸ¯ [ãƒ‡ãƒãƒƒã‚°] vGroupKeyãŒç©ºã®ãŸã‚å±¥æ­´ä¿å­˜ã—ã¾ã›ã‚“');
      }
      
      if (exampleId) {
        history.exampleIds.push(exampleId);
        if (history.exampleIds.length > history.maxHistorySize) {
          history.exampleIds.shift(); // å¤ã„å±¥æ­´ã‚’å‰Šé™¤
        }
        console.log('ğŸ¯ [ãƒ‡ãƒãƒƒã‚°] exampleIdå±¥æ­´æ›´æ–°:', history.exampleIds);
      } else {
        console.log('ğŸ¯ [ãƒ‡ãƒãƒƒã‚°] exampleIdãŒç©ºã®ãŸã‚å±¥æ­´ä¿å­˜ã—ã¾ã›ã‚“');
      }
      
      localStorage.setItem('rephrase_randomize_history', JSON.stringify(history));
      console.log('ğŸ¯ é‡è¤‡å›é¿å±¥æ­´ã‚’ä¿å­˜:', { vGroupKey, exampleId, history });
    } catch (error) {
      console.log('é‡è¤‡å›é¿å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', error);
    }
  },
  
  // é‡è¤‡å›é¿ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  filterAvoidDuplicates: function(candidates, currentValue, historyKey) {
    const history = this.load();
    const recentValues = history[historyKey] || [];
    
    // ç¾åœ¨ã®å€¤ã¨å±¥æ­´ã®å€¤ã‚’é™¤å¤–
    const valuesToAvoid = currentValue ? [currentValue, ...recentValues] : recentValues;
    const filtered = candidates.filter(candidate => !valuesToAvoid.includes(candidate));
    
    console.log(`ğŸ¯ é‡è¤‡å›é¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: ${candidates.length} â†’ ${filtered.length}ä»¶`);
    console.log(`ğŸ¯ å›é¿å¯¾è±¡: ${valuesToAvoid.join(', ')}`);
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«å€™è£œãŒãªã„å ´åˆã¯å…¨å€™è£œã‚’è¿”ã™
    return filtered.length > 0 ? filtered : candidates;
  }
};


function validateSlotsModified(data) {
  const requiredSlots = ["M1", "S", "V"];
  const presentSlots = data.map(d => d.Slot);
  requiredSlots.forEach(slot => {
    if (!presentSlots.includes(slot)) {
      console.warn(`âš  å¿…é ˆã‚¹ãƒ­ãƒƒãƒˆ ${slot} ãŒãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºçµæœã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“`);
    }
  });
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç–‘å•è©ã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log("ğŸ”„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ç–‘å•è©ã‚¨ãƒªã‚¢åˆæœŸåŒ–");
  if (window.initializeQuestionWordArea) {
    window.initializeQuestionWordArea();
  }
  
  // åˆ¶å¾¡ãƒ‘ãƒãƒ«è¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ã‚’è¿½åŠ 
  const toggleControlPanelsBtn = document.getElementById('toggle-control-panels');
  
  if (toggleControlPanelsBtn) {
    // åˆ¶å¾¡ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°ã‚’å®šç¾©
    window.toggleAllControlPanels = function() {
      const controlPanel = document.getElementById('visibility-control-panel-inline');
      const voicePanel = document.getElementById('voice-control-panel');
      
      if (controlPanel) {
        const isCurrentlyVisible = controlPanel.style.display === 'block';
        
        if (isCurrentlyVisible) {
          // ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          controlPanel.style.display = 'none';
          if (voicePanel && voicePanel.style.display === 'block') {
            voicePanel.style.display = 'none';
          }
          // ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚‚éè¡¨ç¤º
          if (window.updateSubslotControlPanelsVisibility) {
            window.updateSubslotControlPanelsVisibility(false);
          }
          // åˆ¶å¾¡ãƒ‘ãƒãƒ«éè¡¨ç¤ºçŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
          try {
            let state = {};
            const saved = localStorage.getItem('rephrase_subslot_visibility_state');
            if (saved) {
              state = JSON.parse(saved);
            }
            state['global_control_panels_visible'] = false;
            localStorage.setItem('rephrase_subslot_visibility_state', JSON.stringify(state));
            console.log('ğŸ’¾ åˆ¶å¾¡ãƒ‘ãƒãƒ«éè¡¨ç¤ºçŠ¶æ…‹ã‚’localStorageã«ä¿å­˜');
          } catch (error) {
            console.warn('âš ï¸ localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          }
          toggleControlPanelsBtn.innerHTML = 'ğŸ“ åˆ¶å¾¡ãƒ‘ãƒãƒ«';
          console.log('ğŸ”’ åˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        } else {
          // ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã™ã‚‹  
          controlPanel.style.display = 'block';
          // ã‚µãƒ–ã‚¹ãƒ­ãƒƒãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚‚è¡¨ç¤º
          if (window.updateSubslotControlPanelsVisibility) {
            window.updateSubslotControlPanelsVisibility(true);
          }
          // åˆ¶å¾¡ãƒ‘ãƒãƒ«è¡¨ç¤ºçŠ¶æ…‹ã‚’localStorageã«ä¿å­˜
          try {
            let state = {};
            const saved = localStorage.getItem('rephrase_subslot_visibility_state');
            if (saved) {
              state = JSON.parse(saved);
            }
            state['global_control_panels_visible'] = true;
            localStorage.setItem('rephrase_subslot_visibility_state', JSON.stringify(state));
            console.log('ğŸ’¾ åˆ¶å¾¡ãƒ‘ãƒãƒ«è¡¨ç¤ºçŠ¶æ…‹ã‚’localStorageã«ä¿å­˜');
          } catch (error) {
            console.warn('âš ï¸ localStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          }
          toggleControlPanelsBtn.innerHTML = 'ğŸ“ ãƒ‘ãƒãƒ«é–‰ã˜ã‚‹';
          console.log('ğŸ”“ åˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
      }
    };
    
    toggleControlPanelsBtn.addEventListener('click', function() {
      if (window.toggleAllControlPanels) {
        window.toggleAllControlPanels();
      } else {
        console.error("âŒ toggleAllControlPanelsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    });
    
    console.log("âœ… åˆ¶å¾¡ãƒ‘ãƒãƒ«è¡¨ç¤º/éè¡¨ç¤ºæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
  } else {
    console.warn("âš  åˆ¶å¾¡ãƒ‘ãƒãƒ«ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
  
  // ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚‚ç–‘å•è©ã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
  const randomizeAllButton = document.getElementById('randomize-all');
  if (randomizeAllButton) {
    randomizeAllButton.addEventListener('click', function() {
      // ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå‡¦ç†ã®å‰ã«ç–‘å•è©ã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
      setTimeout(() => {
        if (window.initializeQuestionWordArea) {
          window.initializeQuestionWordArea();
          console.log("ğŸ”„ ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå¾Œã®ç–‘å•è©ã‚¨ãƒªã‚¢åˆæœŸåŒ–");
        }
      }, 100); // ãƒ©ãƒ³ãƒ€ãƒã‚¤ã‚ºå‡¦ç†å®Œäº†å¾Œã«å®Ÿè¡Œ
    });
  }
});

// ğŸ”§ **ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€æ©Ÿèƒ½**
async function loadPresetConfig() {
  try {
    const response = await fetch('data/preset_config.json');
    if (!response.ok) {
      console.log('preset_config.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
      return;
    }
    
    const config = await response.json();
    const presetSelect = document.getElementById('presetSelect');
    
    if (presetSelect && config.presets) {
      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒ)
      const defaultOption = presetSelect.querySelector('option[value=""]');
      presetSelect.innerHTML = '';
      if (defaultOption) {
        presetSelect.appendChild(defaultOption);
      } else {
        presetSelect.innerHTML = '<option value="">-- ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ --</option>';
      }
      
      // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ 
      config.presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.file;
        option.textContent = preset.name;
        option.title = preset.description;
        presetSelect.appendChild(option);
      });
      
      console.log(`ğŸ”§ ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿å®Œäº†: ${config.presets.length}ä»¶`);
    }
  } catch (error) {
    console.log('ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', error);
  }
}

// DOMContentLoadedã§ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
document.addEventListener('DOMContentLoaded', loadPresetConfig);



// ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åˆ¶å¾¡é–¢æ•°
function hideLoadingOverlay() {
  console.log("ğŸ­ hideLoadingOverlay() é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ");
  const overlay = document.getElementById('loading-overlay');
  const mainContent = document.getElementById('main-content');
  
  console.log("ğŸ­ overlayè¦ç´ :", overlay);
  console.log("ğŸ­ mainContentè¦ç´ :", mainContent);
  
  if (overlay && mainContent) {
    console.log("ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº† - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºæº–å‚™ä¸­...");
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªé…å»¶ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã™
    setTimeout(() => {
      console.log("ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã—ã¾ã™");
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å³åº§ã«éš ã™
      overlay.style.display = 'none';
      console.log("ğŸ­ overlay.style.display = 'none' å®Ÿè¡Œå®Œäº†");
      
      // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      mainContent.style.display = 'block';
      mainContent.style.opacity = '1';
      console.log("ğŸ­ mainContentè¡¨ç¤ºè¨­å®šå®Œäº†");
      
      console.log("ğŸ­ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºå®Œäº†");
    }, 500); // ã‚·ãƒ³ãƒ—ãƒ«ãª500msé…å»¶
  } else {
    console.error("ğŸ­ ã‚¨ãƒ©ãƒ¼: overlay ã¾ãŸã¯ mainContent è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
}

function showLoadingOverlay() {
  console.log("ğŸ­ showLoadingOverlay() é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ");
  const overlay = document.getElementById('loading-overlay');
  const mainContent = document.getElementById('main-content');
  
  console.log("ğŸ­ overlayè¦ç´ :", overlay);
  console.log("ğŸ­ mainContentè¦ç´ :", mainContent);
  
  if (overlay && mainContent) {
    console.log("ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™");
    
    // ç¢ºå®Ÿã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™
    overlay.style.display = 'flex';
    overlay.style.opacity = '1';
    overlay.style.transition = 'none'; // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    console.log("ğŸ­ overlayè¡¨ç¤ºè¨­å®šå®Œäº†");
    
    mainContent.style.display = 'none';
    mainContent.style.opacity = '0';
    mainContent.style.transition = 'none'; // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    console.log("ğŸ­ mainContentéè¡¨ç¤ºè¨­å®šå®Œäº†");
  } else {
    console.error("ğŸ­ ã‚¨ãƒ©ãƒ¼: overlay ã¾ãŸã¯ mainContent è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  }
}

// JSONãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç®¡ç†
document.addEventListener('DOMContentLoaded', function() {
  const loadingTitle = document.getElementById('loading-title');
  const loadingDescription = document.getElementById('loading-description');
  const loadingProgress = document.getElementById('loading-progress');
  const loadingTips = document.getElementById('loading-tip-text');
  
  // ğŸ“ˆ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é€²æ—ç®¡ç†
  let loadingStage = 0;
  const loadingStages = [
    { progress: 0, title: "ğŸš€ Rephrase æº–å‚™ä¸­...", desc: "ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­", tip: "é«˜é€ŸåŒ–æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™" },
    { progress: 20, title: "ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†", desc: "JSONæ§‹é€ ã‚’ç¢ºèªä¸­", tip: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¼·åŒ–ã•ã‚Œã¦ã„ã¾ã™" },
    { progress: 60, title: "âš¡ ãƒ‡ãƒ¼ã‚¿æœ€é©åŒ–ä¸­", desc: "é«˜é€Ÿè¡¨ç¤ºã®ãŸã‚ã®å‰å‡¦ç†ä¸­", tip: "ç”»åƒé…å»¶èª­ã¿è¾¼ã¿ã§ãƒ¡ãƒ¢ãƒªç¯€ç´„" },
    { progress: 90, title: "ğŸ¯ æœ€çµ‚èª¿æ•´ä¸­", desc: "ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½æº–å‚™å®Œäº†", tip: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æ¸ˆã¿" },
    { progress: 100, title: "âœ… æº–å‚™å®Œäº†ï¼", desc: "å¿«é©ãªå­¦ç¿’ç’°å¢ƒã‚’ãŠæ¥½ã—ã¿ãã ã•ã„", tip: "ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™" }
  ];
  
  // ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é€²æ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  function updateLoadingStage(stage) {
    if (stage < loadingStages.length) {
      const stageData = loadingStages[stage];
      
      if (loadingTitle) loadingTitle.textContent = stageData.title;
      if (loadingDescription) loadingDescription.textContent = stageData.desc;
      if (loadingTips) loadingTips.textContent = stageData.tip;
      if (loadingProgress) {
        loadingProgress.style.width = stageData.progress + '%';
      }
      
      console.log(`ğŸ­ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¸ ${stage + 1}/5: ${stageData.title}`);
    }
  }
  
  // ğŸš€ è‡ªå‹•é€²æ—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  function simulateLoadingProgress() {
    loadingStage = 0;
    updateLoadingStage(loadingStage);
    
    const progressInterval = setInterval(() => {
      loadingStage++;
      if (loadingStage < loadingStages.length) {
        updateLoadingStage(loadingStage);
      } else {
        clearInterval(progressInterval);
      }
    }, 800); // å„ã‚¹ãƒ†ãƒ¼ã‚¸800ms
    
    return progressInterval;
  }
  
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const fileName = this.files[0].name;
        if (loadingTitle) loadingTitle.textContent = "ğŸ“ " + fileName;
        if (loadingDescription) loadingDescription.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æº–å‚™å®Œäº† - é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯";
        if (loadingProgress) loadingProgress.style.width = '15%';
        if (loadingTips) loadingTips.textContent = "æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã§é«˜é€Ÿèª­ã¿è¾¼ã¿";
      } else {
        updateLoadingStage(0); // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
      }
    });
  }
  
  // ğŸ¬ åˆæœŸçŠ¶æ…‹ã§é€²æ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
  simulateLoadingProgress();
});

// ğŸ¯ **é‡è¤‡å›é¿ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°**
window.debugRandomizeAvoidance = function() {
  console.log('ğŸ¯ === é‡è¤‡å›é¿æ©Ÿèƒ½ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
  
  if (window.currentRandomizedState) {
    console.log('ğŸ¯ ç¾åœ¨ã®çŠ¶æ…‹:', window.currentRandomizedState);
  } else {
    console.log('ğŸ¯ ç¾åœ¨ã®çŠ¶æ…‹: æœªåˆæœŸåŒ–');
  }
  
  if (window.randomizeHistory) {
    const history = window.randomizeHistory.load();
    console.log('ğŸ¯ å±¥æ­´:', history);
  } else {
    console.log('ğŸ¯ å±¥æ­´: å±¥æ­´ç®¡ç†æ©Ÿèƒ½ãªã—');
  }
  
  // å…ƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥V_group_keyã‚’å–å¾—
  let groups = [];
  if (window.loadedJsonData && Array.isArray(window.loadedJsonData)) {
    // å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
    groups = [...new Set(window.loadedJsonData.map(entry => entry.V_group_key).filter(v => v))];
    
    // å…ƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒ•ãƒ«ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—
    if (groups.length === 0 && window.fullSlotPool) {
      groups = [...new Set(window.fullSlotPool.map(entry => entry.V_group_key).filter(v => v))];
    }
  }
  
  console.log('ğŸ¯ åˆ©ç”¨å¯èƒ½ãªV_group_key:', groups);
  console.log('ğŸ¯ åˆ©ç”¨å¯èƒ½ãªV_group_keyæ•°:', groups.length);
  
  // è¿½åŠ ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
  if (window.fullSlotPool) {
    console.log('ğŸ¯ fullSlotPool ã‚µã‚¤ã‚º:', window.fullSlotPool.length);
    const fullPoolGroups = [...new Set(window.fullSlotPool.map(entry => entry.V_group_key).filter(v => v))];
    console.log('ğŸ¯ fullSlotPoolå†…ã®V_group_key:', fullPoolGroups);
  }
};

// ğŸ¯ **é‡è¤‡å›é¿å±¥æ­´ã‚¯ãƒªã‚¢é–¢æ•°**
window.clearRandomizeHistory = function() {
  try {
    localStorage.removeItem('rephrase_randomize_history');
    if (window.currentRandomizedState) {
      window.currentRandomizedState.vGroupKey = null;
      window.currentRandomizedState.exampleId = null;
      window.currentRandomizedState.lastRandomizedTime = null;
      window.currentRandomizedState.selectedSlots = [];
    }
    console.log('ğŸ¯ é‡è¤‡å›é¿å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  } catch (error) {
    console.error('ğŸ¯ é‡è¤‡å›é¿å±¥æ­´ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);
  }
};


</script>

<!-- éŸ³å£°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<!-- éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ‡ãƒã‚¤ã‚¹åˆ¥èª­ã¿è¾¼ã¿ï¼‰ -->
<script>
// ğŸ”§ ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿åˆ¶å¾¡
(function() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                    'ontouchstart' in window ||
                    window.innerWidth <= 768;
    
    console.log('ğŸ”§ ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ:', {
        isMobile: isMobile,
        userAgent: navigator.userAgent,
        screenWidth: window.innerWidth
    });
    
    if (isMobile) {
        console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: ã‚·ãƒ³ãƒ—ãƒ«éŒ²éŸ³ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨');
        
        // ğŸ“± Androidå°‚ç”¨ï¼šã‚·ãƒ³ãƒ—ãƒ«éŒ²éŸ³ãƒ»å†ç”Ÿã‚·ã‚¹ãƒ†ãƒ 
        const simpleRecorderScript = document.createElement('script');
        simpleRecorderScript.src = 'js/simple_recorder.js';
        simpleRecorderScript.onload = function() {
            console.log('âœ… SimpleRecorderã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
        };
        simpleRecorderScript.onerror = function() {
            console.error('âŒ SimpleRecorderã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—');
        };
        document.head.appendChild(simpleRecorderScript);
        console.log('âœ… ã‚·ãƒ³ãƒ—ãƒ«éŒ²éŸ³ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
        
    } else {
        console.log('ğŸ’» ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿');
        
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿
        const desktopScript = document.createElement('script');
        desktopScript.src = 'js/voice_system.js';
        desktopScript.onload = function() {
            console.log('ğŸ¤ VoiceSystemã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº† - DOMæº–å‚™å¾…æ©Ÿä¸­...');
            
            // DOMèª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºå®Ÿã«å¾…ã¤
            function initVoiceSystem() {
                console.log(`ğŸ“„ DOMçŠ¶æ…‹: ${document.readyState}`);
                window.voiceSystem = new VoiceSystem();
                console.log('âœ… VoiceSystemã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº† - åˆæœŸåŒ–é–‹å§‹...');
                window.voiceSystem.init().then(() => {
                    console.log('âœ… VoiceSystemåˆæœŸåŒ–å®Œäº†');
                }).catch(error => {
                    console.error('âŒ VoiceSystemåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initVoiceSystem);
            } else {
                // DOMæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿
                setTimeout(initVoiceSystem, 100); // å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰å®Ÿè¡Œ
            }
        };
        document.head.appendChild(desktopScript);
    }
})();
</script>
<script src="js/voice_progress_tracker.js"></script>
<script src="js/voice_progress_ui.js"></script>

<!-- ğŸ“š è§£èª¬ã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="explanationModal" class="explanation-modal">
  <div class="explanation-modal-content">
    <div class="explanation-modal-header">
      <h3 id="explanationTitle">è§£èª¬</h3>
      <span class="explanation-close">&times;</span>
    </div>
    <div class="explanation-modal-body">
      <div id="explanationContent"></div>
    </div>
  </div>
</div>

</body>
</html>
