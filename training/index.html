<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <title>
   Rephrase トレーニングUI
  </title>
  <link href="style.css" rel="stylesheet"/>
  <link href="css/voice_progress.css" rel="stylesheet"/>
  <script src="js/subslot_toggle.js">
  </script>
  <script src="js/randomizer_individual.js">
  </script>
  <script src="js/control_panel_manager.js">
  </script>
  <script src="js/visibility_control.js">
  </script>
  <script src="js/subslot_visibility_control.js">
  </script>
  <script src="js/image_auto_hide.js">
  </script>
  <script src="js/universal_image_system.js">
  </script>
  <script src="js/question_word_visibility.js">
  </script>
  <script src="js/voice_system.js">
  </script>
  <script src="js/voice_progress_tracker.js">
  </script>
  <script src="js/voice_progress_ui.js">
  </script>
 </head>
 <body>

<!-- シンプルなナビゲーションリンク -->
<div style="position: fixed; top: 10px; left: 10px; z-index: 16000; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;">
  <a href="../" style="text-decoration: none; color: #2196F3; font-size: 14px; font-weight: bold;">🏠 ホーム</a>
  <span style="color: #ccc;">|</span>
  <a href="grammar/" style="text-decoration: none; color: #2196F3; font-size: 14px;">📚 文法</a>
  <span style="color: #ccc;">|</span>
  
  <!-- サンプルデータ選択 -->
  <div style="display: flex; align-items: center; gap: 4px;">
    <label style="font-size: 12px; font-weight: bold; color: #333;">📋 サンプルデータ</label>
    <select id="presetSelect" style="width: 150px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
      <option value="">-- データを選択 --</option>
      <option value="data/slot_order_data.json">🎯 メインデータセット</option>
      <option value="data/slot_order_data2.json">📚 例文データセット2</option>
    </select>
    <button id="loadPresetButton" style="background-color: #4CAF50; color: white; border: none; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: bold;">読込</button>
  </div>
  
  <span style="color: #ccc;">|</span>
  
  <!-- ファイル選択 -->
  <div style="display: flex; align-items: center; gap: 4px;">
    <label style="font-size: 12px; font-weight: bold; color: #333;">📁 ファイル選択</label>
    <input type="file" id="jsonFileInput" accept=".json" style="font-size: 11px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
    <button id="loadJsonButton" style="background-color: #2196F3; color: white; border: none; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: bold;">ロード</button>
  </div>
</div>

<!-- 🎭 ローディングオーバーレイ -->
<div id="loading-overlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  z-index: 8000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  font-family: Arial, sans-serif;
  pointer-events: none;
">
  <div style="text-align: center; pointer-events: auto;">
    <div style="
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    "></div>
    <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 300;">
      データを準備しています...
    </h2>
    <p style="margin: 0; font-size: 14px; opacity: 0.8;">
      JSONファイルをロードしてください
    </p>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<!-- タイトル（常に表示） -->
<div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px; margin-top: 20px; position: relative; z-index: 10000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <h1 style="margin: 0; margin-right: 30px; color: #333; font-size: 28px; font-weight: bold;">
   🔄 Rephrase トレーニングUI
  </h1>
</div>

<!-- 🎯 メインコンテンツエリア（ローディング完了まで非表示） -->
<div id="main-content" style="display: none;">

<!-- 🔹 分離疑問詞用表示領域 -->
<div id="display-top-question-word">
  <div class="question-word-label">WH</div>
  <div class="question-word-image"></div>
  <div class="question-word-spacer"></div>
  <div class="question-word-auxtext"></div>
  <div class="question-word-text"></div>
  <div class="question-word-button-placeholder"></div>
  <div class="question-word-button-placeholder"></div>
</div>

  <section>
  </section>
  
  <!-- 制御パネル表示ボタンと制御パネル -->
  <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px;">
    <!-- 制御パネル表示ボタン -->
    <button id="toggle-control-panels" style="
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
      margin-right: 20px;
    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      📝 制御パネル
    </button>
  </div>
  
  <!-- 🎯 上位スロット表示制御パネル（デフォルト非表示） -->
  <div id="visibility-control-panel-inline" style="display: none; background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 15px;">
      <div style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
        
        <!-- 疑問詞 スロット -->
        <div class="slot-control-group" data-slot="question-word" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">疑問詞</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="question-word" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="question-word" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- M1 スロット -->
        <div class="slot-control-group" data-slot="m1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m1" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m1" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m1" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- S スロット -->
        <div class="slot-control-group" data-slot="s" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">S</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="s" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="s" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="s" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- Aux スロット -->
        <div class="slot-control-group" data-slot="aux" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">Aux</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="aux" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="aux" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="aux" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- M2 スロット -->
        <div class="slot-control-group" data-slot="m2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m2" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m2" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m2" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- V スロット -->
        <div class="slot-control-group" data-slot="v" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">V</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="v" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="v" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="v" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- C1 スロット -->
        <div class="slot-control-group" data-slot="c1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">C1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c1" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c1" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c1" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- O1 スロット -->
        <div class="slot-control-group" data-slot="o1" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">O1</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o1" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o1" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o1" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- O2 スロット -->
        <div class="slot-control-group" data-slot="o2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">O2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o2" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o2" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="o2" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- C2 スロット -->
        <div class="slot-control-group" data-slot="c2" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">C2</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c2" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c2" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="c2" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- M3 スロット -->
        <div class="slot-control-group" data-slot="m3" style="padding: 4px; border: 1px solid #f0f0f0; border-radius: 3px;">
          <div style="font-weight: bold; font-size: 11px; margin-bottom: 2px; color: #444; text-align: center;">M3</div>
          <div style="display: flex; flex-direction: column; gap: 2px; font-size: 10px;">
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m3" data-type="image" checked> 🖼️</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m3" data-type="auxtext" checked> 📝</label>
            <label style="display: flex; align-items: center; gap: 2px;"><input type="checkbox" class="visibility-checkbox" data-slot="m3" data-type="text" checked> 📄</label>
          </div>
        </div>
        
        <!-- 全表示ボタン -->
        <button id="reset-all-visibility" style="background-color: #4CAF50; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: 8px;">全表示</button>
        
        <!-- 全英文非表示ボタン -->
        <button id="hide-all-english-visibility" style="background-color: #f44336; color: white; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: 8px;">全英文非表示</button>
      </div>
    </div>
  </div>
  
  <!-- 🎤 右上フロート音声学習パネル -->
  <div id="voice-control-panel" style="
    position: fixed !important;
    top: 60px !important;
    right: 10px !important;
    z-index: 15000 !important;
    background: rgba(255, 255, 255, 0.95) !important;
    padding: 12px !important;
    border-radius: 8px !important;
    border: 2px solid #667eea !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
    min-width: 200px !important;
    max-width: 300px !important;
    transition: all 0.3s ease !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  ">
    <!-- 基本パネル部分 -->
    <div id="voice-panel-basic" style="display: block; position: relative;">
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <h3 style="margin: 0; color: #333; font-size: 14px; font-weight: bold;">🎤 音声学習</h3>
        <button id="voice-panel-minimize-btn" style="background-color: #ccc; color: white; border: none; padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; margin-left: auto;">−</button>
      </div>
      
      <!-- 音声コントロールボタン -->
      <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px;">
        <button id="voice-record-btn" class="voice-btn" style="background-color: #4CAF50; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px;">🎤 録音</button>
        <button id="voice-play-btn" class="voice-btn" style="background-color: #2196F3; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px;">🔊 再生</button>
        <button id="voice-tts-btn" class="voice-btn" style="background-color: #FF9800; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px;">🗣️ 読み上げ</button>
        <button id="voice-analyze-btn" class="voice-btn" style="background-color: #9C27B0; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px;">📊 分析</button>
        <button id="voice-stop-btn" class="voice-btn" style="display: none; background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px;">⏹️ 停止</button>
      </div>
      
      <!-- ステータス表示 -->
      <div id="voice-status" class="voice-status info" style="color: #333; font-size: 10px; background: rgba(76, 175, 80, 0.1); padding: 2px 4px; border-radius: 10px; text-align: center;">待機中...</div>
      
      <!-- 録音タイマー -->
      <div id="voice-timer" style="display: none; font-size: 10px; color: #666; text-align: center; margin-top: 4px;">録音時間: <span id="voice-timer-text">0:00</span></div>
      
      <!-- 音量バー -->
      <div id="voice-volume-container" style="margin-top: 8px; display: none;">
        <div style="width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden;">
          <div id="voice-volume-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722); width: 0%; transition: width 0.1s ease;"></div>
        </div>
      </div>
    </div>
    
    <!-- 拡張パネル部分（分析結果表示） - 下方向に拡張 -->
    <div id="voice-panel-expanded" style="
      display: none; 
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border: 2px solid #667eea;
      border-top: none;
      border-radius: 0 0 8px 8px;
      padding: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 16000;
      min-height: 250px;
      max-height: 400px;
      overflow-y: auto;
    ">
      <div style="display: flex; align-items: center; margin-bottom: 12px;">
        <h4 style="margin: 0; color: #333; font-size: 14px; font-weight: bold;">📊 分析結果</h4>
        <button id="voice-panel-close-expanded-btn" style="background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 3px; margin-left: auto;">✕ 閉じる</button>
      </div>
      
      <!-- 分析結果表示エリア -->
      <div id="voice-analysis-results" style="font-size: 12px; color: #555;">
        <div id="voice-evaluation-result" style="margin-bottom: 12px; padding: 8px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0;"></div>
        <div id="voice-waveform-container" style="margin-bottom: 12px; display: none;">
          <canvas id="voice-waveform-canvas" width="280" height="60" style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; background: white;"></canvas>
        </div>
        <div id="voice-progress-display" style="margin-bottom: 12px; padding: 8px; background: #e8f5e8; border-radius: 6px; border: 1px solid #d0d0d0;"></div>
        
        <!-- 学習進捗ボタンを拡張パネル内に配置 -->
        <div style="text-align: center; margin-top: 16px;">
          <button id="voice-progress-btn" style="
            background: linear-gradient(135deg, #607D8B 0%, #455A64 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            📈 詳細学習進捗を表示
          </button>
        </div>
      </div>
    </div>
    
    <!-- 最小化表示 -->
    <div id="voice-panel-minimized" style="display: none;">
      <div style="display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 18px; cursor: pointer;" id="voice-panel-restore-btn">🎤</span>
      </div>
    </div>
  </div>
  
  <section>
   <button id="randomize-all" style="
     background: linear-gradient(135deg, #8e44ad 0%, #e74c3c 100%);
     color: white;
     border: none;
     padding: 12px 20px;
     border-radius: 5px;
     cursor: pointer;
     font-size: 16px;
     font-weight: bold;
     box-shadow: 0 4px 12px rgba(0,0,0,0.2);
     transition: all 0.2s ease;
     margin-bottom: 20px;
   " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    🎲 例文シャッフル
   </button>
   <h2 style="margin-bottom: 15px; margin-top: 20px;">
    例文
   </h2>

   <div class="slot-wrapper">
    <div class="slot-container" id="slot-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m1">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m1-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="s">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="s-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="slot-container" id="slot-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m2">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m2-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="slot-container" id="slot-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="c1">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="c1-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="o1">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="o1-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="o2">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="o2-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="c2">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="c2-individual-randomize-btn">🎲</button>
     </div>
    </div>
    <div class="slot-container" id="slot-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
     <div class="subslot-toggle-button">
      <button data-subslot-toggle="m3">▼ 詳細</button>
     </div>
     <div class="individual-randomize-button">
      <button class="m3-individual-randomize-btn">🎲</button>
     </div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-o1-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：O1 の subslot
    </div>
    <div class="subslot-container" id="slot-o1-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o1-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m1-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：M1 の subslot
    </div>
    <div class="subslot-container" id="slot-m1-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m1-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-o2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：O2 の subslot
    </div>
    <div class="subslot-container" id="slot-o2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-o2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：M2 の subslot
    </div>
    <div class="subslot-container" id="slot-m2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-c2-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：C2 の subslot
    </div>
    <div class="subslot-container" id="slot-c2-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-c2-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
   <div class="slot-wrapper" id="slot-m3-sub" style="display: none;">
    <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
     現在展開中：M3 の subslot
    </div>
    <div class="subslot-container" id="slot-m3-sub-m1">
     <label>M1</label>
     <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-s">
     <label>S</label>
     <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-aux">
     <label>AUX</label>
     <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-m2">
     <label>M2</label>
     <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-v">
     <label>V</label>
     <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-c1">
     <label>C1</label>
     <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-o1">
     <label>O1</label>
     <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-o2">
     <label>O2</label>
     <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-c2">
     <label>C2</label>
     <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
    <div class="subslot-container" id="slot-m3-sub-m3">
     <label>M3</label>
     <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
     <div class="slot-text"></div>
     <div class="slot-phrase"></div>
    </div>
   </div>
  </section>
  <div class="slot-wrapper" id="slot-s-sub" style="display: none;">
   <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
    現在展開中：S の subslot
   </div>
   <div class="subslot-container" id="slot-s-sub-m1">
    <label>M1</label>
    <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-s">
    <label>S</label>
    <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-aux">
    <label>AUX</label>
    <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-m2">
    <label>M2</label>
    <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-v">
    <label>V</label>
    <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-c1">
    <label>C1</label>
    <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-o1">
    <label>O1</label>
    <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-o2">
    <label>O2</label>
    <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-c2">
    <label>C2</label>
    <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-s-sub-m3">
    <label>M3</label>
    <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
  </div>
  <div class="slot-wrapper" id="slot-c1-sub" style="display: none;">
   <div class="subslot-label" style="font-weight: bold; margin-bottom: 0.5rem;">
    現在展開中：C1 の subslot
   </div>
   <div class="subslot-container" id="slot-c1-sub-m1">
    <label>M1</label>
    <img alt="image for M1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-s">
    <label>S</label>
    <img alt="image for S" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-aux">
    <label>AUX</label>
    <img alt="image for AUX" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-m2">
    <label>M2</label>
    <img alt="image for M2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-v">
    <label>V</label>
    <img alt="image for V" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-c1">
    <label>C1</label>
    <img alt="image for C1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-o1">
    <label>O1</label>
    <img alt="image for O1" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-o2">
    <label>O2</label>
    <img alt="image for O2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-c2">
    <label>C2</label>
    <img alt="image for C2" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
   <div class="subslot-container" id="slot-c1-sub-m3">
    <label>M3</label>
    <img alt="image for M3" class="slot-image" src="slot_images/common/placeholder.png"/>
    <div class="slot-text"></div>
    <div class="slot-phrase"></div>
   </div>
  </div>
  
  
<script src="js/insert_test_data_clean.js"></script>

<!-- 動的記載エリア用のセクション要素を追加 -->
<section id="dynamic-area-container" style="margin-top: 30px;">
  <button id="toggle-dynamic-area" style="background-color: #4CAF50; color: white; border: none; padding: 8px 16px; font-size: 16px; cursor: pointer; border-radius: 4px; margin-bottom: 5px;">
    ▼ 解答全文
  </button>
  <!-- 動的記載エリアがここに生成されます -->
  <div id="dynamic-slot-area-wrapper" style="display: none;"></div>
</section>

<script>
  // 動的エリアの生成位置を指定
  window.addEventListener("DOMContentLoaded", () => {
    const dynamicArea = document.getElementById("dynamic-slot-area");
    const wrapper = document.getElementById("dynamic-slot-area-wrapper");
    
    // 既存のdynamic-slot-areaがあれば移動
    if (dynamicArea && wrapper) {
      // 動的エリアをラッパーに移動
      wrapper.appendChild(dynamicArea);
      
      // さらに、動的エリアのコンテナを文書の末尾に移動
      const container = document.getElementById("dynamic-area-container");
      if (container) {
        document.body.appendChild(container);
        console.log("✅ 動的記載エリアコンテナを文書の最後に移動しました");
      }
      
      console.log("✅ 動的記載エリアを適切な位置に移動しました");
    } else {
      console.warn("⚠ 動的記載エリアまたはラッパーが見つかりません");
    }
  });

  // 解答全文の表示・非表示切り替え機能
  document.getElementById("toggle-dynamic-area").addEventListener("click", () => {
    const wrapper = document.getElementById("dynamic-slot-area-wrapper");
    const button = document.getElementById("toggle-dynamic-area");
    
    if (wrapper.style.display === "none") {
      wrapper.style.display = "block";
      button.textContent = "▲ 解答全文";
      button.style.backgroundColor = "#f44336"; // 赤色（閉じる状態）
      console.log("✅ 解答全文エリアを表示しました");
    } else {
      wrapper.style.display = "none";
      button.textContent = "▼ 解答全文";
      button.style.backgroundColor = "#4CAF50"; // 緑色（開く状態）
      console.log("✅ 解答全文エリアを非表示にしました");
    }
  });

  // syncDynamicToStatic() をDOM描画完了後に遅延実行
  window.addEventListener("load", () => {
    // サブスロットを明示的に初期化（再度実行して確実に閉じる）
    if (typeof initializeSubslots === 'function') {
      console.log("🔒 ページ読み込み完了時にサブスロットを初期化");
      initializeSubslots();
    }
    
    setTimeout(() => {
      console.log("🚀 syncDynamicToStatic() 遅延呼び出し");
      if (typeof syncDynamicToStatic === "function") {
        syncDynamicToStatic();
      } else {
        console.warn("⚠ syncDynamicToStatic 関数が未定義です");
      }
    }, 200);
  });
</script>

<script>
        function loadScript(src) {
          const script = document.createElement('script');
          script.src = src;
          document.head.appendChild(script);
        }
      </script>
</div> <!-- main-content の終了 -->

    <!-- 既存のスクリプト -->
<script type="module">
import { randomizeAll, randomizeAllWithStateManagement } from './js/randomizer_all.js';
import { buildStructure } from './js/structure_builder.js';

let loadedJsonData = null;

// 🎯 **プリセットJSONファイルをロードする機能**
document.getElementById("loadPresetButton").addEventListener("click", () => {
  const presetSelect = document.getElementById("presetSelect");
  const selectedPreset = presetSelect.value;
  
  if (!selectedPreset) {
    alert("サンプルデータを選択してください");
    return;
  }
  
  // 🎭 ローディング画面を表示
  console.log("🎭 プリセットJSONロード開始 - ローディング画面を表示");
  showLoadingOverlay();
  
  // ローディングメッセージを更新
  const loadingText = document.querySelector('#loading-overlay p');
  if (loadingText) {
    loadingText.textContent = `${selectedPreset} を読み込み中...`;
  }
  
  // 🎯 **修正：JSONデータを直接埋め込み（CORSエラー回避）**
  let presetData = null;
  
  if (selectedPreset === 'data/slot_order_data.json' || selectedPreset === 'data/slot_order_data2.json') {
    // 🎯 **データセット：fetchでJSONファイルを読み込み**
    fetch(selectedPreset)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        // データ処理を直接実行
        try {
          // 🔄 JSONロード時にサブスロット表示設定をリセット
          localStorage.removeItem('rephrase_subslot_visibility_state');
          console.log('📁 プリセットJSONロード時にサブスロット表示設定をリセットしました');
          
          loadedJsonData = data;
          window.loadedJsonData = loadedJsonData;  // コンソール確認用
          console.log("🟢 window.loadedJsonData セット完了:", window.loadedJsonData);
          
          // 🔍 デバッグ：ランダマイズ前のデータを確認
          console.log("🔍 ランダマイズ前のloadedJsonDataの最初の5件:", loadedJsonData.slice(0, 5));
          
          // 🎯 **重複回避機能付きランダマイズを実行**
          const processedData = randomizeAllWithStateManagement(loadedJsonData);
          console.log("🎯 重複回避ランダマイズ結果詳細:", JSON.stringify(processedData, null, 2));
          
          // 🔍 デバッグ：ランダマイズ後のprocessedDataを確認
          console.log("🔍 ランダマイズ後のprocessedDataの最初の5件:", processedData.slice(0, 5));
          console.log("🔍 processedDataの上位スロット（M1）:", processedData.filter(item => item.Slot === 'M1' && !item.SubslotID));
          
          validateSlotsModified(processedData);
          
          // 🎯 修正：ローカルファイル読み込みと同じパターンに変更
          window.loadedJsonData = processedData;
          
          // 🎤 音声システム用: processedDataをwindow.lastSelectedSlotsにも保存
          // （randomizeAll内で設定されたwindow.lastSelectedSlotsを保持）
          console.log("🎤 音声システム用 lastSelectedSlots確認:", window.lastSelectedSlots ? `${window.lastSelectedSlots.length}件` : '未設定');
          
          // 構造を構築（processedDataは表示用、lastSelectedSlotsは音声システム用として分離）
          buildStructure(processedData);
          syncDynamicToStatic();
          
          // サブスロットの初期化も実行
          if (typeof initializeSubslots === 'function') {
            console.log("🔒 プリセットJSONロード後にサブスロットを初期化");
            initializeSubslots();
          }
          
          // 明示的に上位スロットとサブスロットの同期を呼び出す（ローカルファイルと同じ処理）
          if (typeof syncUpperSlotsFromJson === 'function') {
            console.log("🔄 プリセットJSONロード後の明示的同期呼び出し");
            syncUpperSlotsFromJson(processedData);
            if (typeof syncSubslotsFromJson === 'function') {
              syncSubslotsFromJson(processedData);
            }
            
            // 表示順制御機能の呼び出し
            if (typeof applyOrderToAllSlots === 'function') {
              console.log("🔢 プリセットJSONロード後にスロット表示順適用");
              applyOrderToAllSlots(processedData);
            }
            
            if (typeof debugM1Slot === 'function') {
              console.log("🔍 M1スロットのデバッグ実行");
              debugM1Slot();
            }
          }
          
          // 🎭 ローディング画面を非表示
          console.log("🎭 プリセットJSONロード完了 - ローディング画面を非表示");
          hideLoadingOverlay();
        } catch (error) {
          console.error("プリセットJSONデータの処理に失敗:", error);
          alert(`プリセットJSONデータの処理に失敗しました: ${error.message}`);
          hideLoadingOverlay();
        }
      })
      .catch(error => {
        console.error(`${selectedPreset}の読み込みに失敗:`, error);
        alert(`データセットの読み込みに失敗しました。\nローカルファイルの場合は、ファイル選択から対応するJSONファイルを選択してください。\n\nエラー詳細: ${error.message}`);
        hideLoadingOverlay();
      });
    return; // 早期リターン
  } else {
    alert("不明なプリセットが選択されました");
    hideLoadingOverlay();
    return;
  }
});

// 既存のファイル選択からのロード機能
document.getElementById("loadJsonButton").addEventListener("click", () => {
  const fileInput = document.getElementById("jsonFileInput");
  if (fileInput.files.length === 0) {
    alert("ファイルを選択してください");
    return;
  }
  
  const file = fileInput.files[0];
  
  // 🎭 ローディング画面を表示
  console.log("🎭 JSONロード開始 - ローディング画面を表示");
  showLoadingOverlay();
  
  // ローディングメッセージを更新
  const loadingText = document.querySelector('#loading-overlay p');
  if (loadingText) {
    loadingText.textContent = `${file.name} を処理中...`;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      // 🔄 JSONロード時にサブスロット表示設定をリセット
      localStorage.removeItem('rephrase_subslot_visibility_state');
      console.log('📁 JSONロード時にサブスロット表示設定をリセットしました');
      
      loadedJsonData = JSON.parse(e.target.result);
      window.loadedJsonData = loadedJsonData;  // コンソール確認用
      console.log("🟢 window.loadedJsonData セット完了:", window.loadedJsonData);
      
      // 🎯 **重複回避機能付きランダマイズを実行**
      const data = randomizeAllWithStateManagement(loadedJsonData);
      console.log("🎯 重複回避ランダマイズ結果詳細:", JSON.stringify(data, null, 2));
      validateSlotsModified(data);
      window.loadedJsonData = data;
      buildStructure(data);
      syncDynamicToStatic();
      
      // サブスロットの初期化も実行
      if (typeof initializeSubslots === 'function') {
        console.log("🔒 JSONロード後にサブスロットを初期化");
        initializeSubslots();
      }
      
      // 明示的に上位スロットとサブスロットの同期を呼び出す
      if (typeof syncUpperSlotsFromJson === 'function') {
        console.log("🔄 JSONロード後の明示的同期呼び出し");
        syncUpperSlotsFromJson(data);
        if (typeof syncSubslotsFromJson === 'function') {
          syncSubslotsFromJson(data);
        }
        
        // 表示順制御機能の呼び出し
        if (typeof applyOrderToAllSlots === 'function') {
          console.log("🔢 JSONロード後にスロット表示順適用");
          applyOrderToAllSlots(data);
        }
        
        if (typeof debugM1Slot === 'function') {
          console.log("🔍 M1スロットのデバッグ実行");
          debugM1Slot();
        }
      }
      
      // 🎭 ローディング完了処理
      setTimeout(() => {
        console.log("🎭 JSONデータ処理完了 - ローディングを隠します");
        hideLoadingOverlay();
      }, 300); // シンプルな300ms遅延
      
    } catch (err) {
      console.error("❌ JSON パースエラーまたは処理例外", err);
      alert("無効な JSON ファイルです");
      console.log("🎭 エラー発生 - ローディング画面を隠します");
      hideLoadingOverlay(); // エラー時もローディングを隠す
    }
  };
  reader.readAsText(file);
});

document.getElementById("randomize-all").addEventListener("click", () => {
  if (!loadedJsonData || !Array.isArray(loadedJsonData)) {
    alert("先に正しいJSONデータをロードしてください");
    console.error("❌ 全体ランダマイズ：ロード済データが不正または未ロード");
    return;
  }
  
  // 🎯 **重複回避機能付きランダマイズを実行**
  const data = randomizeAllWithStateManagement(loadedJsonData);
  console.log("🎯 重複回避ランダマイズ結果詳細（全体ボタン）:", JSON.stringify(data, null, 2));
  validateSlotsModified(data);
  window.loadedJsonData = data;
  buildStructure(data);
  syncDynamicToStatic();
  
  // サブスロットの初期化も実行
  if (typeof initializeSubslots === 'function') {
    console.log("🔒 ランダマイズ後にサブスロットを初期化");
    initializeSubslots();
  }
  
  // ランダマイズ後も表示順制御を適用
  if (typeof applyOrderToAllSlots === 'function') {
    console.log("🔢 ランダマイズ後のスロット表示順適用");
    applyOrderToAllSlots(data);
  }
});

// Sスロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const sIndividualBtn = document.querySelector(".s-individual-randomize-btn");
  if (sIndividualBtn) {
    sIndividualBtn.addEventListener("click", () => {
      console.log("🎲 Sスロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotSIndividual === "function") {
        window.randomizeSlotSIndividual();
      } else {
        console.error("❌ randomizeSlotSIndividual関数が見つかりません");
        alert("エラー: Sスロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ Sスロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ Sスロット個別ランダマイズボタンが見つかりません");
  }
});

// M1スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const m1IndividualBtn = document.querySelector(".m1-individual-randomize-btn");
  if (m1IndividualBtn) {
    m1IndividualBtn.addEventListener("click", () => {
      console.log("🎲 M1スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotM1Individual === "function") {
        window.randomizeSlotM1Individual();
      } else {
        console.error("❌ randomizeSlotM1Individual関数が見つかりません");
        alert("エラー: M1スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ M1スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ M1スロット個別ランダマイズボタンが見つかりません");
  }
});

// M2スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const m2IndividualBtn = document.querySelector(".m2-individual-randomize-btn");
  if (m2IndividualBtn) {
    m2IndividualBtn.addEventListener("click", () => {
      console.log("🎲 M2スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotM2Individual === "function") {
        window.randomizeSlotM2Individual();
      } else {
        console.error("❌ randomizeSlotM2Individual関数が見つかりません");
        alert("エラー: M2スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ M2スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ M2スロット個別ランダマイズボタンが見つかりません");
  }
});

// C1スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const c1IndividualBtn = document.querySelector(".c1-individual-randomize-btn");
  if (c1IndividualBtn) {
    c1IndividualBtn.addEventListener("click", () => {
      console.log("🎲 C1スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotC1Individual === "function") {
        window.randomizeSlotC1Individual();
      } else {
        console.error("❌ randomizeSlotC1Individual関数が見つかりません");
        alert("エラー: C1スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ C1スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ C1スロット個別ランダマイズボタンが見つかりません");
  }
});

// O1スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const o1IndividualBtn = document.querySelector(".o1-individual-randomize-btn");
  if (o1IndividualBtn) {
    o1IndividualBtn.addEventListener("click", () => {
      console.log("🎲 O1スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotO1Individual === "function") {
        window.randomizeSlotO1Individual();
      } else {
        console.error("❌ randomizeSlotO1Individual関数が見つかりません");
        alert("エラー: O1スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ O1スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ O1スロット個別ランダマイズボタンが見つかりません");
  }
});

// O2スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const o2IndividualBtn = document.querySelector(".o2-individual-randomize-btn");
  if (o2IndividualBtn) {
    o2IndividualBtn.addEventListener("click", () => {
      console.log("🎲 O2スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotO2Individual === "function") {
        window.randomizeSlotO2Individual();
      } else {
        console.error("❌ randomizeSlotO2Individual関数が見つかりません");
        alert("エラー: O2スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ O2スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ O2スロット個別ランダマイズボタンが見つかりません");
  }
});

// C2スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const c2IndividualBtn = document.querySelector(".c2-individual-randomize-btn");
  if (c2IndividualBtn) {
    c2IndividualBtn.addEventListener("click", () => {
      console.log("🎲 C2スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotC2Individual === "function") {
        window.randomizeSlotC2Individual();
      } else {
        console.error("❌ randomizeSlotC2Individual関数が見つかりません");
        alert("エラー: C2スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ C2スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ C2スロット個別ランダマイズボタンが見つかりません");
  }
});

// M3スロット個別ランダマイズボタンのイベントハンドラー
document.addEventListener("DOMContentLoaded", () => {
  const m3IndividualBtn = document.querySelector(".m3-individual-randomize-btn");
  if (m3IndividualBtn) {
    m3IndividualBtn.addEventListener("click", () => {
      console.log("🎲 M3スロット個別ランダマイズボタンがクリックされました");
      if (typeof window.randomizeSlotM3Individual === "function") {
        window.randomizeSlotM3Individual();
      } else {
        console.error("❌ randomizeSlotM3Individual関数が見つかりません");
        alert("エラー: M3スロット個別ランダマイズ機能が読み込まれていません。");
      }
    });
    console.log("✅ M3スロット個別ランダマイズボタンのイベントハンドラーを設定しました");
  } else {
    console.error("❌ M3スロット個別ランダマイズボタンが見つかりません");
  }
});

// 🎯 **全体ランダマイズの重複回避用グローバル状態管理**
window.currentRandomizedState = {
  vGroupKey: null,           // 現在選択されているV_group_key
  exampleId: null,           // 現在選択されている例文ID
  lastRandomizedTime: null,  // 最後にランダマイズされた時刻
  selectedSlots: []          // 現在選択されているスロット情報
};

// 🎯 **重複回避用ローカルストレージ管理**
window.randomizeHistory = {
  // ローカルストレージから履歴を読み込み
  load: function() {
    try {
      const saved = localStorage.getItem('rephrase_randomize_history');
      if (saved) {
        const parsed = JSON.parse(saved);
        return {
          vGroupKeys: parsed.vGroupKeys || [],
          exampleIds: parsed.exampleIds || [],
          maxHistorySize: 3 // 最近3回の履歴を保持
        };
      }
    } catch (error) {
      console.log('重複回避履歴の読み込みに失敗:', error);
    }
    return {
      vGroupKeys: [],
      exampleIds: [],
      maxHistorySize: 3
    };
  },
  
  // ローカルストレージに履歴を保存
  save: function(vGroupKey, exampleId) {
    try {
      console.log('🎯 [デバッグ] 履歴保存試行:', { vGroupKey, exampleId });
      const history = this.load();
      
      // 新しい選択を履歴に追加
      if (vGroupKey) {
        history.vGroupKeys.push(vGroupKey);
        if (history.vGroupKeys.length > history.maxHistorySize) {
          history.vGroupKeys.shift(); // 古い履歴を削除
        }
        console.log('🎯 [デバッグ] vGroupKey履歴更新:', history.vGroupKeys);
      } else {
        console.log('🎯 [デバッグ] vGroupKeyが空のため履歴保存しません');
      }
      
      if (exampleId) {
        history.exampleIds.push(exampleId);
        if (history.exampleIds.length > history.maxHistorySize) {
          history.exampleIds.shift(); // 古い履歴を削除
        }
        console.log('🎯 [デバッグ] exampleId履歴更新:', history.exampleIds);
      } else {
        console.log('🎯 [デバッグ] exampleIdが空のため履歴保存しません');
      }
      
      localStorage.setItem('rephrase_randomize_history', JSON.stringify(history));
      console.log('🎯 重複回避履歴を保存:', { vGroupKey, exampleId, history });
    } catch (error) {
      console.log('重複回避履歴の保存に失敗:', error);
    }
  },
  
  // 重複回避用フィルタリング
  filterAvoidDuplicates: function(candidates, currentValue, historyKey) {
    const history = this.load();
    const recentValues = history[historyKey] || [];
    
    // 現在の値と履歴の値を除外
    const valuesToAvoid = currentValue ? [currentValue, ...recentValues] : recentValues;
    const filtered = candidates.filter(candidate => !valuesToAvoid.includes(candidate));
    
    console.log(`🎯 重複回避フィルタリング: ${candidates.length} → ${filtered.length}件`);
    console.log(`🎯 回避対象: ${valuesToAvoid.join(', ')}`);
    
    // フィルタリング後に候補がない場合は全候補を返す
    return filtered.length > 0 ? filtered : candidates;
  }
};


function validateSlotsModified(data) {
  const requiredSlots = ["M1", "S", "V"];
  const presentSlots = data.map(d => d.Slot);
  requiredSlots.forEach(slot => {
    if (!presentSlots.includes(slot)) {
      console.warn(`⚠ 必須スロット ${slot} がランダマイズ結果に含まれていません`);
    }
  });
}

// ページ読み込み時に疑問詞エリアを初期化
document.addEventListener('DOMContentLoaded', function() {
  console.log("🔄 ページ読み込み時の疑問詞エリア初期化");
  if (window.initializeQuestionWordArea) {
    window.initializeQuestionWordArea();
  }
  
  // 制御パネル表示/非表示ボタンの機能を追加
  const toggleControlPanelsBtn = document.getElementById('toggle-control-panels');
  
  if (toggleControlPanelsBtn) {
    // 制御パネルの表示・非表示を制御する関数を定義
    window.toggleAllControlPanels = function() {
      const controlPanel = document.getElementById('visibility-control-panel-inline');
      const voicePanel = document.getElementById('voice-control-panel');
      
      if (controlPanel) {
        const isCurrentlyVisible = controlPanel.style.display === 'block';
        
        if (isCurrentlyVisible) {
          // パネルを非表示にする
          controlPanel.style.display = 'none';
          if (voicePanel && voicePanel.style.display === 'block') {
            voicePanel.style.display = 'none';
          }
          // サブスロット制御パネルも非表示
          if (window.updateSubslotControlPanelsVisibility) {
            window.updateSubslotControlPanelsVisibility(false);
          }
          // 制御パネル非表示状態をlocalStorageに保存
          try {
            let state = {};
            const saved = localStorage.getItem('rephrase_subslot_visibility_state');
            if (saved) {
              state = JSON.parse(saved);
            }
            state['global_control_panels_visible'] = false;
            localStorage.setItem('rephrase_subslot_visibility_state', JSON.stringify(state));
            console.log('💾 制御パネル非表示状態をlocalStorageに保存');
          } catch (error) {
            console.warn('⚠️ localStorage保存エラー:', error);
          }
          toggleControlPanelsBtn.innerHTML = '📝 制御パネル';
          console.log('🔒 制御パネルを非表示にしました');
        } else {
          // パネルを表示する  
          controlPanel.style.display = 'block';
          // サブスロット制御パネルも表示
          if (window.updateSubslotControlPanelsVisibility) {
            window.updateSubslotControlPanelsVisibility(true);
          }
          // 制御パネル表示状態をlocalStorageに保存
          try {
            let state = {};
            const saved = localStorage.getItem('rephrase_subslot_visibility_state');
            if (saved) {
              state = JSON.parse(saved);
            }
            state['global_control_panels_visible'] = true;
            localStorage.setItem('rephrase_subslot_visibility_state', JSON.stringify(state));
            console.log('💾 制御パネル表示状態をlocalStorageに保存');
          } catch (error) {
            console.warn('⚠️ localStorage保存エラー:', error);
          }
          toggleControlPanelsBtn.innerHTML = '📝 パネル閉じる';
          console.log('🔓 制御パネルを表示しました');
        }
      }
    };
    
    toggleControlPanelsBtn.addEventListener('click', function() {
      if (window.toggleAllControlPanels) {
        window.toggleAllControlPanels();
      } else {
        console.error("❌ toggleAllControlPanels関数が見つかりません");
      }
    });
    
    console.log("✅ 制御パネル表示/非表示機能を初期化しました");
  } else {
    console.warn("⚠ 制御パネルボタンが見つかりません");
  }
  
  // ランダマイズボタンクリック時も疑問詞エリアを初期化
  const randomizeAllButton = document.getElementById('randomize-all');
  if (randomizeAllButton) {
    randomizeAllButton.addEventListener('click', function() {
      // ランダマイズ処理の前に疑問詞エリアを初期化
      setTimeout(() => {
        if (window.initializeQuestionWordArea) {
          window.initializeQuestionWordArea();
          console.log("🔄 ランダマイズ後の疑問詞エリア初期化");
        }
      }, 100); // ランダマイズ処理完了後に実行
    });
  }
});

// 🔧 **プリセット設定を動的に読み込む機能**
async function loadPresetConfig() {
  try {
    const response = await fetch('data/preset_config.json');
    if (!response.ok) {
      console.log('preset_config.jsonが見つかりません。デフォルトのプリセットを使用します。');
      return;
    }
    
    const config = await response.json();
    const presetSelect = document.getElementById('presetSelect');
    
    if (presetSelect && config.presets) {
      // 既存のオプションをクリア（最初のデフォルトオプションは保持)
      const defaultOption = presetSelect.querySelector('option[value=""]');
      presetSelect.innerHTML = '';
      if (defaultOption) {
        presetSelect.appendChild(defaultOption);
      } else {
        presetSelect.innerHTML = '<option value="">-- データを選択 --</option>';
      }
      
      // 設定ファイルからプリセットを追加
      config.presets.forEach(preset => {
        const option = document.createElement('option');
        option.value = preset.file;
        option.textContent = preset.name;
        option.title = preset.description;
        presetSelect.appendChild(option);
      });
      
      console.log(`🔧 プリセット設定を動的に読み込み完了: ${config.presets.length}件`);
    }
  } catch (error) {
    console.log('プリセット設定の読み込みに失敗しました。デフォルトのプリセットを使用します。', error);
  }
}

// DOMContentLoadedでプリセット設定を読み込み
document.addEventListener('DOMContentLoaded', loadPresetConfig);



// 🎭 ローディング制御関数
function hideLoadingOverlay() {
  console.log("🎭 hideLoadingOverlay() 関数が呼ばれました");
  const overlay = document.getElementById('loading-overlay');
  const mainContent = document.getElementById('main-content');
  
  console.log("🎭 overlay要素:", overlay);
  console.log("🎭 mainContent要素:", mainContent);
  
  if (overlay && mainContent) {
    console.log("🎭 ローディング完了 - メインコンテンツを表示準備中...");
    
    // シンプルな遅延でローディングを隠す
    setTimeout(() => {
      console.log("🎭 ローディングオーバーレイを隠します");
      
      // ローディングオーバーレイを即座に隠す
      overlay.style.display = 'none';
      console.log("🎭 overlay.style.display = 'none' 実行完了");
      
      // メインコンテンツを表示
      mainContent.style.display = 'block';
      mainContent.style.opacity = '1';
      console.log("🎭 mainContent表示設定完了");
      
      console.log("🎭 メインコンテンツ表示完了");
    }, 500); // シンプルな500ms遅延
  } else {
    console.error("🎭 エラー: overlay または mainContent 要素が見つかりません");
  }
}

function showLoadingOverlay() {
  console.log("🎭 showLoadingOverlay() 関数が呼ばれました");
  const overlay = document.getElementById('loading-overlay');
  const mainContent = document.getElementById('main-content');
  
  console.log("🎭 overlay要素:", overlay);
  console.log("🎭 mainContent要素:", mainContent);
  
  if (overlay && mainContent) {
    console.log("🎭 ローディング開始 - メインコンテンツを隠す");
    
    // 確実にローディングを表示し、メインコンテンツを隠す
    overlay.style.display = 'flex';
    overlay.style.opacity = '1';
    overlay.style.transition = 'none'; // トランジションをリセット
    console.log("🎭 overlay表示設定完了");
    
    mainContent.style.display = 'none';
    mainContent.style.opacity = '0';
    mainContent.style.transition = 'none'; // トランジションをリセット
    console.log("🎭 mainContent非表示設定完了");
  } else {
    console.error("🎭 エラー: overlay または mainContent 要素が見つかりません");
  }
}

// JSONファイルが選択された時のローディング表示更新
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.getElementById('jsonFileInput');
  const loadingText = document.querySelector('#loading-overlay p');
  
  if (fileInput && loadingText) {
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        loadingText.textContent = `${this.files[0].name} を読み込み準備完了`;
      } else {
        loadingText.textContent = 'JSONファイルをロードしてください';
      }
    });
  }
});

// 🎯 **重複回避デバッグ用関数**
window.debugRandomizeAvoidance = function() {
  console.log('🎯 === 重複回避機能デバッグ情報 ===');
  
  if (window.currentRandomizedState) {
    console.log('🎯 現在の状態:', window.currentRandomizedState);
  } else {
    console.log('🎯 現在の状態: 未初期化');
  }
  
  if (window.randomizeHistory) {
    const history = window.randomizeHistory.load();
    console.log('🎯 履歴:', history);
  } else {
    console.log('🎯 履歴: 履歴管理機能なし');
  }
  
  // 元データから直接V_group_keyを取得
  let groups = [];
  if (window.loadedJsonData && Array.isArray(window.loadedJsonData)) {
    // 処理済みデータの場合、元データを検索
    groups = [...new Set(window.loadedJsonData.map(entry => entry.V_group_key).filter(v => v))];
    
    // 元データが見つからない場合は、フルプールから取得
    if (groups.length === 0 && window.fullSlotPool) {
      groups = [...new Set(window.fullSlotPool.map(entry => entry.V_group_key).filter(v => v))];
    }
  }
  
  console.log('🎯 利用可能なV_group_key:', groups);
  console.log('🎯 利用可能なV_group_key数:', groups.length);
  
  // 追加のデバッグ情報
  if (window.fullSlotPool) {
    console.log('🎯 fullSlotPool サイズ:', window.fullSlotPool.length);
    const fullPoolGroups = [...new Set(window.fullSlotPool.map(entry => entry.V_group_key).filter(v => v))];
    console.log('🎯 fullSlotPool内のV_group_key:', fullPoolGroups);
  }
};

// 🎯 **重複回避履歴クリア関数**
window.clearRandomizeHistory = function() {
  try {
    localStorage.removeItem('rephrase_randomize_history');
    if (window.currentRandomizedState) {
      window.currentRandomizedState.vGroupKey = null;
      window.currentRandomizedState.exampleId = null;
      window.currentRandomizedState.lastRandomizedTime = null;
      window.currentRandomizedState.selectedSlots = [];
    }
    console.log('🎯 重複回避履歴をクリアしました');
  } catch (error) {
    console.error('🎯 重複回避履歴のクリアに失敗:', error);
  }
};


</script>

<!-- 🎤 音声パネル強制表示 - 最優先実行 -->
<script>
// 即座に音声パネルを強制表示
(function() {
  const forceShowVoicePanel = () => {
    const panel = document.getElementById('voice-control-panel');
    if (panel) {
      panel.style.display = 'block !important';
      panel.style.visibility = 'visible !important';
      panel.style.opacity = '1 !important';
      console.log('🎤 音声パネル強制表示実行');
      return true;
    }
    return false;
  };
  
  // DOM読み込み完了後に実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceShowVoicePanel);
  } else {
    forceShowVoicePanel();
  }
  
  // 継続的に監視（他のスクリプトが非表示にした場合の対策）
  setInterval(() => {
    const panel = document.getElementById('voice-control-panel');
    if (panel && (panel.style.display === 'none' || panel.style.visibility === 'hidden')) {
      forceShowVoicePanel();
    }
  }, 1000);
})();
</script>

<!-- 右上フロート音声学習パネル制御JavaScript -->
<script>
// 🎤 音声パネル強制表示スクリプト
document.addEventListener('DOMContentLoaded', function() {
  console.log('🎤 音声パネル初期化開始...');
  
  // パネルを強制表示
  const voicePanel = document.getElementById('voice-control-panel');
  if (voicePanel) {
    voicePanel.style.display = 'block';
    voicePanel.style.visibility = 'visible';
    voicePanel.style.opacity = '1';
    console.log('✅ 音声パネル表示完了');
  } else {
    console.error('❌ 音声パネルが見つかりません');
  }
  
  const voicePanelBasic = document.getElementById('voice-panel-basic');
  const voicePanelExpanded = document.getElementById('voice-panel-expanded');
  const voicePanelMinimized = document.getElementById('voice-panel-minimized');
  const minimizeBtn = document.getElementById('voice-panel-minimize-btn');
  const restoreBtn = document.getElementById('voice-panel-restore-btn');
  const closeExpandedBtn = document.getElementById('voice-panel-close-expanded-btn');
  const analyzeBtn = document.getElementById('voice-analyze-btn');
  
  // 最小化ボタンクリック
  if (minimizeBtn) {
    minimizeBtn.addEventListener('click', function() {
      if (voicePanelBasic) voicePanelBasic.style.display = 'none';
      if (voicePanelExpanded) voicePanelExpanded.style.display = 'none';
      if (voicePanelMinimized) voicePanelMinimized.style.display = 'block';
      if (voicePanel) {
        voicePanel.style.minWidth = '40px';
        voicePanel.style.maxWidth = '40px';
        voicePanel.style.padding = '8px';
      }
    });
  }
  
  // 復元ボタンクリック
  if (restoreBtn) {
    restoreBtn.addEventListener('click', function() {
      if (voicePanelMinimized) voicePanelMinimized.style.display = 'none';
      if (voicePanelBasic) voicePanelBasic.style.display = 'block';
      if (voicePanel) {
        voicePanel.style.minWidth = '200px';
        voicePanel.style.maxWidth = '300px';
        voicePanel.style.padding = '12px';
      }
    });
  }
  
  // 分析ボタンクリック（拡張パネル表示）
  if (analyzeBtn) {
    analyzeBtn.addEventListener('click', function() {
      console.log('🔍 分析ボタンクリック');
      
      // 分析実行処理
      performVoiceAnalysis();
      
      // 拡張パネルを表示
      if (voicePanelExpanded) {
        voicePanelExpanded.style.display = 'block';
      }
      
      // 分析結果を表示
      const analysisResults = document.getElementById('voice-analysis-results');
      if (analysisResults) {
        analysisResults.innerHTML = `
          <div id="voice-evaluation-result" style="margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 4px;">
            <strong>📊 評価結果:</strong><br>
            発音精度: 85%<br>
            流暢さ: 良好<br>
            音量レベル: 適切
          </div>
          <div id="voice-progress-display" style="margin-bottom: 8px; padding: 4px; background: #e8f5e8; border-radius: 4px;">
            <strong>📈 学習進捗:</strong><br>
            今日の練習回数: 3回<br>
            累計練習時間: 15分
          </div>
        `;
      }
    });
  }
  
  // 拡張パネル閉じるボタンクリック
  if (closeExpandedBtn) {
    closeExpandedBtn.addEventListener('click', function() {
      if (voicePanelExpanded) {
        voicePanelExpanded.style.display = 'none';
      }
    });
  }
  
  // 分析実行処理
  function performVoiceAnalysis() {
    const statusElement = document.getElementById('voice-status');
    if (statusElement) {
      statusElement.textContent = '分析中...';
      statusElement.className = 'voice-status warning';
      
      // 模擬分析処理
      setTimeout(() => {
        statusElement.textContent = '分析完了';
        statusElement.className = 'voice-status success';
      }, 2000);
    }
  }
  
  // 音声コントロールボタンのイベントリスナー設定
  const recordBtn = document.getElementById('voice-record-btn');
  const stopBtn = document.getElementById('voice-stop-btn');
  const playBtn = document.getElementById('voice-play-btn');
  const ttsBtn = document.getElementById('voice-tts-btn');
  
  // 録音状態管理
  let isRecording = false;
  let recordingStartTime = null;
  let recordingTimer = null;
  let mediaRecorder = null;
  let audioChunks = [];
  
  if (recordBtn) {
    recordBtn.addEventListener('click', async function() {
      console.log('🎤 録音ボタンクリック');
      
      try {
        // マイクアクセス許可を取得
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // MediaRecorderを初期化
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });
        
        mediaRecorder.addEventListener('stop', () => {
          // 録音完了時の処理
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          console.log('🎤 録音完了、音声データ取得');
          
          // 自動で分析結果を表示
          setTimeout(() => {
            showAnalysisResults(audioBlob);
          }, 500);
        });
        
        // 録音開始
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        const statusElement = document.getElementById('voice-status');
        if (statusElement) {
          statusElement.textContent = '録音中...';
          statusElement.className = 'voice-status warning';
        }
        
        // 録音タイマー開始
        startRecordingTimer();
        
        // 録音タイマー表示
        const timerElement = document.getElementById('voice-timer');
        if (timerElement) {
          timerElement.style.display = 'block';
        }
        
        // 音量バー表示
        const volumeContainer = document.getElementById('voice-volume-container');
        if (volumeContainer) {
          volumeContainer.style.display = 'block';
        }
        
        // 停止ボタン表示
        if (stopBtn) {
          stopBtn.style.display = 'inline-block';
        }
        this.style.display = 'none';
        
      } catch (error) {
        console.error('🎤 マイクアクセスエラー:', error);
        const statusElement = document.getElementById('voice-status');
        if (statusElement) {
          statusElement.textContent = 'マイクアクセス拒否';
          statusElement.className = 'voice-status error';
        }
      }
    });
  }
  
  if (stopBtn) {
    stopBtn.addEventListener('click', function() {
      console.log('⏹️ 停止ボタンクリック');
      
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        
        // ストリームを停止
        const stream = mediaRecorder.stream;
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        
        isRecording = false;
        
        // 録音タイマー停止
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
      }
      
      const statusElement = document.getElementById('voice-status');
      if (statusElement) {
        statusElement.textContent = '録音停止 - 分析中...';
        statusElement.className = 'voice-status info';
      }
      
      // 録音タイマー非表示
      const timerElement = document.getElementById('voice-timer');
      if (timerElement) {
        timerElement.style.display = 'none';
      }
      
      // 音量バー非表示
      const volumeContainer = document.getElementById('voice-volume-container');
      if (volumeContainer) {
        volumeContainer.style.display = 'none';
      }
      
      // 録音ボタン復元
      if (recordBtn) {
        recordBtn.style.display = 'inline-block';
      }
      this.style.display = 'none';
    });
  }
  
  // 録音タイマー開始関数
  function startRecordingTimer() {
    const timerTextElement = document.getElementById('voice-timer-text');
    if (!timerTextElement) return;
    
    recordingTimer = setInterval(() => {
      if (recordingStartTime) {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerTextElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
    }, 1000);
  }
  
  // 分析結果表示関数
  function showAnalysisResults(audioBlob) {
    console.log('📊 分析結果表示開始');
    
    const statusElement = document.getElementById('voice-status');
    if (statusElement) {
      statusElement.textContent = '分析完了';
      statusElement.className = 'voice-status success';
    }
    
    // 拡張パネルを自動表示
    const voicePanelExpanded = document.getElementById('voice-panel-expanded');
    if (voicePanelExpanded) {
      voicePanelExpanded.style.display = 'block';
    }
    
    // 音声の長さを計算
    const recordingDuration = recordingStartTime ? 
      Math.floor((Date.now() - recordingStartTime) / 1000) : 0;
    
    // 分析結果を表示
    const analysisResults = document.getElementById('voice-analysis-results');
    if (analysisResults) {
      analysisResults.innerHTML = `
        <div id="voice-evaluation-result" style="margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 4px;">
          <strong>📊 録音分析結果:</strong><br>
          録音時間: ${recordingDuration}秒<br>
          音声品質: ${getAudioQuality(audioBlob)}<br>
          推定発音精度: ${Math.floor(Math.random() * 20) + 75}%<br>
          音量レベル: ${getVolumeLevel(audioBlob)}
        </div>
        <div id="voice-waveform-container" style="margin-bottom: 8px; display: block;">
          <div style="font-size: 10px; color: #666; margin-bottom: 4px;">🌊 音声波形</div>
          <canvas id="voice-waveform-canvas" width="250" height="40" style="width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 3px; background: white;"></canvas>
        </div>
        <div id="voice-progress-display" style="margin-bottom: 8px; padding: 4px; background: #e8f5e8; border-radius: 4px;">
          <strong>📈 学習進捗:</strong><br>
          今日の録音回数: ${getRecordingCount()}回<br>
          累計録音時間: ${getTotalRecordingTime()}分
        </div>
      `;
      
      // 簡単な波形を描画
      setTimeout(() => drawSimpleWaveform(audioBlob), 100);
      
      // 学習進捗ボタンのイベントリスナーを設定
      setTimeout(() => setupProgressButton(), 200);
    }
  }
  
  // 学習進捗ボタン設定
  function setupProgressButton() {
    const progressBtn = document.getElementById('voice-progress-btn');
    if (progressBtn && !progressBtn.hasAttribute('data-listener-added')) {
      progressBtn.addEventListener('click', function() {
        console.log('📈 学習進捗ボタンクリック');
        showDetailedProgress();
      });
      progressBtn.setAttribute('data-listener-added', 'true');
      console.log('✅ 学習進捗ボタンのイベントリスナーを設定');
    }
  }
  
  // 詳細学習進捗表示
  function showDetailedProgress() {
    const progressDisplay = document.getElementById('voice-progress-display');
    if (progressDisplay) {
      const today = new Date().toDateString();
      const todayCount = localStorage.getItem(`recording_count_${today}`) || '0';
      const totalTime = localStorage.getItem('total_recording_time') || '0';
      
      // 週間進捗を計算
      const weeklyProgress = calculateWeeklyProgress();
      
      progressDisplay.innerHTML = `
        <strong>📈 詳細学習進捗:</strong><br>
        <div style="margin: 8px 0; padding: 6px; background: #f0f8ff; border-radius: 4px; border: 1px solid #b3d9ff;">
          <strong>📅 本日の実績:</strong><br>
          録音回数: ${todayCount}回<br>
          録音時間: ${Math.floor(parseInt(totalTime) / 60)}分
        </div>
        <div style="margin: 8px 0; padding: 6px; background: #f0fff0; border-radius: 4px; border: 1px solid #b3ffb3;">
          <strong>📊 週間進捗:</strong><br>
          ${weeklyProgress}
        </div>
        <div style="margin: 8px 0; padding: 6px; background: #fff8f0; border-radius: 4px; border: 1px solid #ffcc99;">
          <strong>🎯 目標達成度:</strong><br>
          ${getAchievementStatus(parseInt(todayCount))}
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button onclick="clearProgress()" style="
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
          ">🗑️ 進捗リセット</button>
        </div>
      `;
    }
  }
  
  // 週間進捗計算
  function calculateWeeklyProgress() {
    const today = new Date();
    let weeklyCount = 0;
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() - i);
      const dateStr = date.toDateString();
      const dayCount = parseInt(localStorage.getItem(`recording_count_${dateStr}`) || '0');
      weeklyCount += dayCount;
    }
    
    return `今週の録音回数: ${weeklyCount}回<br>平均: ${(weeklyCount / 7).toFixed(1)}回/日`;
  }
  
  // 目標達成状況
  function getAchievementStatus(todayCount) {
    if (todayCount >= 10) return '🏆 優秀！目標大幅達成';
    if (todayCount >= 5) return '🎉 良好！目標達成';
    if (todayCount >= 3) return '👍 順調！もう少し';
    if (todayCount >= 1) return '🌱 開始！継続が大切';
    return '💪 頑張ろう！';
  }
  
  // 進捗リセット
  function clearProgress() {
    if (confirm('学習進捗データをリセットしますか？')) {
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('recording_count_') || key === 'total_recording_time') {
          localStorage.removeItem(key);
        }
      });
      alert('進捗データがリセットされました。');
      showDetailedProgress(); // 表示を更新
    }
  }
  
  // 音声品質評価
  function getAudioQuality(audioBlob) {
    const size = audioBlob.size;
    if (size > 50000) return '良好';
    if (size > 20000) return '普通';
    return '要改善';
  }
  
  // 音量レベル評価
  function getVolumeLevel(audioBlob) {
    const size = audioBlob.size;
    if (size > 80000) return '適切';
    if (size > 30000) return '少し小さい';
    return '小さい';
  }
  
  // 録音回数取得（localStorage使用）
  function getRecordingCount() {
    const today = new Date().toDateString();
    const key = `recording_count_${today}`;
    let count = parseInt(localStorage.getItem(key) || '0');
    count++;
    localStorage.setItem(key, count.toString());
    return count;
  }
  
  // 累計録音時間取得
  function getTotalRecordingTime() {
    const duration = recordingStartTime ? 
      Math.floor((Date.now() - recordingStartTime) / 1000) : 0;
    const totalKey = 'total_recording_time';
    let total = parseInt(localStorage.getItem(totalKey) || '0');
    total += duration;
    localStorage.setItem(totalKey, total.toString());
    return Math.floor(total / 60);
  }
  
  // 簡単な波形描画
  function drawSimpleWaveform(audioBlob) {
    const canvas = document.getElementById('voice-waveform-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // キャンバスをクリア
    ctx.clearRect(0, 0, width, height);
    
    // 背景グラデーション
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#e3f2fd');
    gradient.addColorStop(1, '#f9f9f9');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // 波形パターンを描画
    ctx.strokeStyle = '#4CAF50';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    const amplitude = (height / 2) * 0.7;
    const frequency = 0.02;
    
    for (let x = 0; x < width; x++) {
      const y = height / 2 + Math.sin(x * frequency) * amplitude * (0.3 + Math.random() * 0.7);
      if (x === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    
    ctx.stroke();
    
    // 音声の特徴を示すピーク
    ctx.strokeStyle = '#FF9800';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    for (let i = 0; i < 5; i++) {
      const x = (width / 6) * (i + 1);
      const peakHeight = amplitude * (0.5 + Math.random() * 0.5);
      ctx.moveTo(x, height / 2 - peakHeight);
      ctx.lineTo(x, height / 2 + peakHeight);
    }
    
    ctx.stroke();
  }
  
  if (playBtn) {
    playBtn.addEventListener('click', function() {
      console.log('🔊 再生ボタンクリック');
      const statusElement = document.getElementById('voice-status');
      if (statusElement) {
        statusElement.textContent = '再生中...';
        statusElement.className = 'voice-status info';
        
        // 模擬再生処理
        setTimeout(() => {
          statusElement.textContent = '再生完了';
          statusElement.className = 'voice-status success';
        }, 3000);
      }
    });
  }
  
  if (ttsBtn) {
    ttsBtn.addEventListener('click', function() {
      console.log('🗣️ 読み上げボタンクリック');
      const statusElement = document.getElementById('voice-status');
      if (statusElement) {
        statusElement.textContent = '読み上げ中...';
        statusElement.className = 'voice-status info';
        
        // 模擬読み上げ処理
        setTimeout(() => {
          statusElement.textContent = '読み上げ完了';
          statusElement.className = 'voice-status success';
        }, 2000);
      }
    });
  }
  
  console.log('✅ 音声パネル制御JavaScript初期化完了');
});
</script>

<!-- 音声学習パネル用CSS -->
<style>
.voice-status {
  transition: all 0.3s ease;
}

.voice-status.info {
  background: rgba(33, 150, 243, 0.1) !important;
  color: #1976D2 !important;
}

.voice-status.warning {
  background: rgba(255, 152, 0, 0.1) !important;
  color: #F57C00 !important;
}

.voice-status.success {
  background: rgba(76, 175, 80, 0.1) !important;
  color: #388E3C !important;
}

.voice-status.error {
  background: rgba(244, 67, 54, 0.1) !important;
  color: #D32F2F !important;
}

.voice-btn:hover {
  opacity: 0.8;
  transform: translateY(-1px);
}

#voice-control-panel {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

#voice-panel-expanded {
  animation: slideDownExpand 0.4s ease-out;
  transform-origin: top;
}

@keyframes slideDownExpand {
  from { 
    opacity: 0; 
    transform: translateY(-20px) scaleY(0.8);
    max-height: 0;
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scaleY(1);
    max-height: 400px;
  }
}
</style>

<!-- 音声学習システムのスクリプト -->
<script src="js/voice_system.js"></script>
<script src="js/voice_progress_tracker.js"></script>
<script src="js/voice_progress_ui.js"></script>

</body>
</html>
