<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RephraseStateManager ãƒ†ã‚¹ãƒˆ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .test-section h3 { margin-top: 0; color: #333; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    button { margin: 5px; padding: 8px 15px; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ”§ RephraseStateManager å˜ä½“ãƒ†ã‚¹ãƒˆ</h1>
  
  <div class="test-section">
    <h3>1. åŸºæœ¬çŠ¶æ…‹ç®¡ç†ãƒ†ã‚¹ãƒˆ</h3>
    <button onclick="testBasicState()">åŸºæœ¬çŠ¶æ…‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="basic-test-result"></div>
  </div>
  
  <div class="test-section">
    <h3>2. æ·±ã„ãƒ‘ã‚¹æ“ä½œãƒ†ã‚¹ãƒˆ</h3>
    <button onclick="testDeepPath()">æ·±ã„ãƒ‘ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="deep-path-result"></div>
  </div>
  
  <div class="test-section">
    <h3>3. ãƒªã‚¹ãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h3>
    <button onclick="testListeners()">ãƒªã‚¹ãƒŠãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="listener-result"></div>
  </div>
  
  <div class="test-section">
    <h3>4. localStorageåŒæœŸãƒ†ã‚¹ãƒˆ</h3>
    <button onclick="testLocalStorage()">localStorage ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="localstorage-result"></div>
  </div>
  
  <div class="test-section">
    <h3>5. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</h3>
    <button onclick="testCompatibility()">äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    <div id="compatibility-result"></div>
  </div>
  
  <div class="test-section">
    <h3>6. ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª</h3>
    <button onclick="dumpCurrentState()">çŠ¶æ…‹ãƒ€ãƒ³ãƒ—</button>
    <div id="state-dump"></div>
  </div>

  <!-- RephraseStateManagerèª­ã¿è¾¼ã¿ -->
  <script src="js/core/state-manager.js"></script>
  
  <script>
    let testResults = [];
    
    function logResult(testName, success, message, details = null) {
      const result = { testName, success, message, details, timestamp: new Date() };
      testResults.push(result);
      console.log(`[TEST ${success ? 'PASS' : 'FAIL'}] ${testName}: ${message}`, details);
      return result;
    }
    
    function displayResult(elementId, result) {
      const element = document.getElementById(elementId);
      const className = result.success ? 'success' : 'error';
      element.innerHTML = `
        <div class="${className}">${result.success ? 'âœ…' : 'âŒ'} ${result.message}</div>
        ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
      `;
    }
    
    // 1. åŸºæœ¬çŠ¶æ…‹ç®¡ç†ãƒ†ã‚¹ãƒˆ
    function testBasicState() {
      try {
        // çŠ¶æ…‹ç¢ºèª
        if (!window.RephraseState) {
          throw new Error('RephraseStateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
        // åˆæœŸçŠ¶æ…‹ç¢ºèª
        const initialState = window.RephraseState.getState();
        if (!initialState.visibility || !initialState.audio || !initialState.ui) {
          throw new Error('åˆæœŸçŠ¶æ…‹æ§‹é€ ãŒä¸æ­£ã§ã™');
        }
        
        // å˜ç´”ãªçŠ¶æ…‹æ›´æ–°ãƒ†ã‚¹ãƒˆ
        window.RephraseState.setState('ui.zoom', 1.5);
        const zoom = window.RephraseState.getState('ui.zoom');
        
        if (zoom !== 1.5) {
          throw new Error(`çŠ¶æ…‹æ›´æ–°ãŒå¤±æ•—: æœŸå¾…å€¤ 1.5, å®Ÿéš›ã®å€¤ ${zoom}`);
        }
        
        const result = logResult('åŸºæœ¬çŠ¶æ…‹ç®¡ç†', true, 'åŸºæœ¬çš„ãªçŠ¶æ…‹ã®å–å¾—ãƒ»æ›´æ–°ãŒæ­£å¸¸ã«å‹•ä½œ', {
          zoom,
          stateKeys: Object.keys(initialState)
        });
        displayResult('basic-test-result', result);
        
      } catch (error) {
        const result = logResult('åŸºæœ¬çŠ¶æ…‹ç®¡ç†', false, error.message);
        displayResult('basic-test-result', result);
      }
    }
    
    // 2. æ·±ã„ãƒ‘ã‚¹æ“ä½œãƒ†ã‚¹ãƒˆ
    function testDeepPath() {
      try {
        // æ·±ã„ãƒ‘ã‚¹ã§ã®çŠ¶æ…‹è¨­å®š
        window.RephraseState.setState('visibility.slots.s.text', false);
        window.RephraseState.setState('visibility.slots.s.auxtext', true);
        
        // æ·±ã„ãƒ‘ã‚¹ã§ã®çŠ¶æ…‹å–å¾—
        const sText = window.RephraseState.getState('visibility.slots.s.text');
        const sAuxtext = window.RephraseState.getState('visibility.slots.s.auxtext');
        
        if (sText !== false || sAuxtext !== true) {
          throw new Error('æ·±ã„ãƒ‘ã‚¹ã®çŠ¶æ…‹æ›´æ–°ãŒå¤±æ•—');
        }
        
        // å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã®ãƒ†ã‚¹ãƒˆ
        const nonExistent = window.RephraseState.getState('non.existent.path');
        if (nonExistent !== undefined) {
          throw new Error('å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã§ undefined ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
        }
        
        const result = logResult('æ·±ã„ãƒ‘ã‚¹æ“ä½œ', true, 'æ·±ã„ãƒ‘ã‚¹ã§ã®çŠ¶æ…‹æ“ä½œãŒæ­£å¸¸ã«å‹•ä½œ', {
          sText,
          sAuxtext,
          nonExistent
        });
        displayResult('deep-path-result', result);
        
      } catch (error) {
        const result = logResult('æ·±ã„ãƒ‘ã‚¹æ“ä½œ', false, error.message);
        displayResult('deep-path-result', result);
      }
    }
    
    // 3. ãƒªã‚¹ãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
    function testListeners() {
      try {
        let listenerCalled = false;
        let receivedValue = null;
        
        // ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
        const listenerId = window.RephraseState.addListener('ui.zoom', (newValue, oldValue, path) => {
          listenerCalled = true;
          receivedValue = newValue;
        });
        
        // çŠ¶æ…‹å¤‰æ›´
        window.RephraseState.setState('ui.zoom', 2.0);
        
        // ãƒªã‚¹ãƒŠãƒ¼ãŒå‘¼ã°ã‚ŒãŸã‹ç¢ºèª
        if (!listenerCalled || receivedValue !== 2.0) {
          throw new Error('ãƒªã‚¹ãƒŠãƒ¼ãŒæ­£å¸¸ã«å‘¼ã°ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
        }
        
        // ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
        window.RephraseState.removeListener('ui.zoom', listenerId);
        
        // å‰Šé™¤å¾Œã¯å‘¼ã°ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
        listenerCalled = false;
        window.RephraseState.setState('ui.zoom', 3.0);
        
        if (listenerCalled) {
          throw new Error('å‰Šé™¤ã•ã‚ŒãŸãƒªã‚¹ãƒŠãƒ¼ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
        }
        
        const result = logResult('ãƒªã‚¹ãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ ', true, 'ãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²ãƒ»å‰Šé™¤ãƒ»é€šçŸ¥ãŒæ­£å¸¸ã«å‹•ä½œ', {
          receivedValue,
          finalZoom: window.RephraseState.getState('ui.zoom')
        });
        displayResult('listener-result', result);
        
      } catch (error) {
        const result = logResult('ãƒªã‚¹ãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ ', false, error.message);
        displayResult('listener-result', result);
      }
    }
    
    // 4. localStorageåŒæœŸãƒ†ã‚¹ãƒˆ
    function testLocalStorage() {
      try {
        // localStorageåˆæœŸåŒ–
        localStorage.removeItem('rephrase_visibility_state');
        console.log('localStorageåˆæœŸåŒ–å®Œäº†');
        
        // åŒæœŸå¯¾è±¡ã®çŠ¶æ…‹æ›´æ–°ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
        console.log('=== localStorageåŒæœŸãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        console.log('çŠ¶æ…‹æ›´æ–°å‰ã®localStorage:', localStorage.getItem('rephrase_visibility_state'));
        
        window.RephraseState.setState('visibility.slots.v.text', false);
        console.log('v.text = false è¨­å®šå®Œäº†');
        console.log('è¨­å®šå¾Œã®localStorage:', localStorage.getItem('rephrase_visibility_state'));
        
        window.RephraseState.setState('visibility.slots.v.auxtext', true);
        console.log('v.auxtext = true è¨­å®šå®Œäº†');
        console.log('æœ€çµ‚çš„ãªlocalStorage:', localStorage.getItem('rephrase_visibility_state'));
        
        // åŒæœŸç¢ºèªã®ãŸã‚ã€RephraseStateã®å†…éƒ¨çŠ¶æ…‹ã‚‚ç¢ºèª
        const internalState = window.RephraseState.getState('visibility.slots.v');
        console.log('RephraseStateå†…éƒ¨çŠ¶æ…‹:', internalState);
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰localStorageç¢ºèª
        setTimeout(() => {
          try {
            const savedData = localStorage.getItem('rephrase_visibility_state');
            console.log('æœ€çµ‚ãƒã‚§ãƒƒã‚¯ - localStorage raw:', savedData);
            
            if (!savedData) {
              throw new Error('localStorageã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            const parsedData = JSON.parse(savedData);
            console.log('localStorageä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ï¼‰:', parsedData);
            console.log('ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ä¸€è¦§:', Object.keys(parsedData));
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®‰å…¨ã«ãƒã‚§ãƒƒã‚¯
            if (!parsedData.v) {
              throw new Error(`vã‚¹ãƒ­ãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼: ${Object.keys(parsedData).join(', ')}`);
            }
            
            if (parsedData.v.text !== false || parsedData.v.auxtext !== true) {
              throw new Error(`localStorageä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™: text=${parsedData.v.text}, auxtext=${parsedData.v.auxtext}`);
            }
            
            const result = logResult('localStorageåŒæœŸ', true, 'localStorageåŒæœŸãŒæ­£å¸¸ã«å‹•ä½œ', {
              savedData: parsedData,
              internalState: internalState
            });
            displayResult('localstorage-result', result);
            
          } catch (parseError) {
            console.error('localStorageåŒæœŸãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', parseError);
            const result = logResult('localStorageåŒæœŸ', false, parseError.message);
            displayResult('localstorage-result', result);
          }
        }, 500); // ã•ã‚‰ã«é•·ã‚ã«å¾…ã¤
        
      } catch (error) {
        console.error('localStorageåŒæœŸãƒ†ã‚¹ãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        const result = logResult('localStorageåŒæœŸ', false, error.message);
        displayResult('localstorage-result', result);
      }
    }
    
    // 5. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
    function testCompatibility() {
      try {
        // äº’æ›æ€§ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ãƒ†ã‚¹ãƒˆ
        window.RephraseState.setVisibilityState('m1', 'text', false);
        window.RephraseState.setVisibilityState('m1', 'auxtext', true);
        
        const m1Text = window.RephraseState.getVisibilityState('m1', 'text');
        const m1Auxtext = window.RephraseState.getVisibilityState('m1', 'auxtext');
        
        if (m1Text !== false || m1Auxtext !== true) {
          throw new Error('visibilityäº’æ›æ€§ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒå‹•ä½œã—ã¾ã›ã‚“');
        }
        
        // ç–‘å•è©è¡¨ç¤ºäº’æ›æ€§ãƒ†ã‚¹ãƒˆ
        window.RephraseState.setQuestionWordVisibility('text', false);
        const questionText = window.RephraseState.getQuestionWordVisibility('text');
        
        if (questionText !== false) {
          throw new Error('ç–‘å•è©è¡¨ç¤ºäº’æ›æ€§ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒå‹•ä½œã—ã¾ã›ã‚“');
        }
        
        const result = logResult('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›æ€§', true, 'æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ãƒ˜ãƒ«ãƒ‘ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œ', {
          m1Text,
          m1Auxtext,
          questionText
        });
        displayResult('compatibility-result', result);
        
      } catch (error) {
        const result = logResult('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›æ€§', false, error.message);
        displayResult('compatibility-result', result);
      }
    }
    
    // 6. ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª
    function dumpCurrentState() {
      try {
        const state = window.RephraseState.dumpState();
        document.getElementById('state-dump').innerHTML = `
          <div class="success">âœ… ç¾åœ¨ã®çŠ¶æ…‹</div>
          <pre>${JSON.stringify(state, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('state-dump').innerHTML = `
          <div class="error">âŒ çŠ¶æ…‹ãƒ€ãƒ³ãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>
        `;
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
    window.addEventListener('load', () => {
      console.log('RephraseStateManager ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
      console.log('åˆ©ç”¨å¯èƒ½ãªãƒ†ã‚¹ãƒˆé–¢æ•°:', {
        testBasicState,
        testDeepPath,
        testListeners,
        testLocalStorage,
        testCompatibility,
        dumpCurrentState
      });
    });
  </script>
</body>
</html>
