<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂãïÁöÑÁîüÊàê„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜ„Éë„Éç„É´ - Rephrase</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* ÁÆ°ÁêÜ„Éë„Éç„É´Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 2em;
        }

        .admin-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        /* „Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ */
        .control-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .warning-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 0.95em;
        }

        .control-section h2 {
            color: #1976D2;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 140px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #00BCD4;
            color: white;
        }

        .btn-info:hover {
            background: #0097A7;
            transform: translateY(-2px);
        }

        .output-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-ready {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .status-working {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .preview-frame {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 20px 0;
        }

        .metadata-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 1.1em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .log-success {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .log-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .log-info {
            background: #E3F2FD;
            color: #1565C0;
        }

        .grammar-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }

        .grammar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .grammar-item:hover {
            background: #f8f9fa;
        }

        .grammar-item:last-child {
            border-bottom: none;
        }

        .grammar-name {
            font-weight: 500;
            color: #333;
        }

        .grammar-key {
            font-size: 0.85em;
            color: #666;
            font-family: monospace;
        }

        /* „Ç®„Éá„Ç£„ÇøÈñ¢ÈÄ£„Çπ„Çø„Ç§„É´ */
        .editor-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .editor-section h3 {
            margin: 0 0 20px 0;
            color: #1976D2;
            font-size: 1.2em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .form-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .content-editor {
            margin-bottom: 15px;
        }

        .content-editor textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95em;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .content-editor textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn-small {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .preview-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .preview-content h2 {
            color: #2196F3;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .preview-content h3 {
            color: #FF9800;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .preview-content p {
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .preview-content ul, .preview-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }

        .preview-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="admin-header">
            <h1>üöÄ Rephrase ÂãïÁöÑÁîüÊàê„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜ„Éë„Éç„É´</h1>
            <p>ÊñáÊ≥ïË™¨Êòé„Éö„Éº„Ç∏„ÅÆ‰∏ÄÊã¨ÁîüÊàê„ÉªÁÆ°ÁêÜ„Éª„Éó„É¨„Éì„É•„Éº„ÉÑ„Éº„É´</p>
        </div>

        <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥Å -->
        <div class="control-section">
            <h2>üìä „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥Å</h2>
            <p id="systemStatus">„Ç∑„Çπ„ÉÜ„É†„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...<span class="status-indicator status-working">Á¢∫Ë™ç‰∏≠</span></p>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>üìÑ ÁôªÈå≤Ê∏à„ÅøÊñáÊ≥ïÈ†ÖÁõÆ</h3>
                    <p id="grammarCount">-</p>
                </div>
                <div class="info-card">
                    <h3>üóÇÔ∏è ÁîüÊàêÂèØËÉΩ„Éö„Éº„Ç∏</h3>
                    <p id="pageCount">-</p>
                </div>
                <div class="info-card">
                    <h3>üîó „Éû„ÉÉ„Éî„É≥„Ç∞Áä∂Ê≥Å</h3>
                    <p id="mappingStatus">-</p>
                </div>
                <div class="info-card">
                    <h3>‚è∞ ÊúÄÁµÇÊõ¥Êñ∞</h3>
                    <p id="lastUpdate">-</p>
                </div>
            </div>
        </div>

        <!-- ÁîüÊàêÊìç‰Ωú -->
        <div class="control-section">
            <h2>‚ö° ÁîüÊàêÊìç‰Ωú</h2>
            <p class="warning-note">‚ö†Ô∏è <strong>ÈÅãÁî®ÊñπÈáù:</strong> „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÊÆµÈöéÁöÑÂÖ¨Èñã„ÅÆ„Åü„ÇÅ„ÄÅÂÆåÊàê„Åó„Åü„Éö„Éº„Ç∏„ÅÆ„ÅøÂÄãÂà•ÁîüÊàê„ÇíÊé®Â•®</p>
            <div class="button-group">
                <button class="action-button btn-primary" onclick="generateSinglePage()" disabled>
                    üìÑ ÈÅ∏Êäû„Éö„Éº„Ç∏ÁîüÊàê („Éó„É¨„Éì„É•„Éº„Åã„ÇâÈÅ∏Êäû)
                </button>
                <button class="action-button btn-success" onclick="generateMapping()">
                    üîó „Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàê
                </button>
                <button class="action-button btn-warning" onclick="validateSystem()">
                    ‚úÖ „Ç∑„Çπ„ÉÜ„É†Ê§úË®º
                </button>
                <button class="action-button btn-info" onclick="runFullTest()">
                    üß™ ÂÆåÂÖ®„ÉÜ„Çπ„Éà
                </button>
            </div>
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; color: #666; font-size: 0.9em;">‚ö†Ô∏è ‰∏ÄÊã¨ÁîüÊàêÊ©üËÉΩÔºàÈùûÊé®Â•®Ôºâ</summary>
                <div style="padding: 15px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">
                    <p><strong>Ê≥®ÊÑè:</strong> ÂÖ®„Éö„Éº„Ç∏‰∏ÄÊã¨ÁîüÊàê„ÅØÈñãÁô∫„Éª„ÉÜ„Çπ„ÉàÁî®ÈÄî„ÅÆ„Åø</p>
                    <button class="action-button btn-warning" onclick="generateAllPages()" style="margin-top: 10px;">
                        ‚ö†Ô∏è ÂÖ®„Éö„Éº„Ç∏ÁîüÊàêÔºàÈñãÁô∫Áî®Ôºâ
                    </button>
                </div>
            </details></div>
            <div class="output-container">
                <pre id="outputLog">Êìç‰Ωú„É≠„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...</pre>
            </div>
        </div>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„Éá„Ç£„Çø -->
        <div class="control-section">
            <h2>‚úçÔ∏è „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„Éá„Ç£„Çø</h2>
            <p>„ÅÇ„Å™„Åü„ÅÆÊñáÁ´†„Åß„Ç™„É™„Ç∏„Éä„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
            
            <!-- Âü∫Êú¨ÊÉÖÂ†±ÂÖ•Âäõ -->
            <div class="editor-section">
                <h3>üìã Âü∫Êú¨ÊÉÖÂ†±</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="grammarDisplayName">Ë°®Á§∫Âêç *</label>
                        <input type="text" id="grammarDisplayName" placeholder="‰æã: Ëá™ÂãïË©ûÁ¨¨1ÊñáÂûã" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="grammarKey">ÊñáÊ≥ï„Ç≠„Éº *</label>
                        <input type="text" id="grammarKey" placeholder="‰æã: Ëá™ÂãïË©ûÁ¨¨1ÊñáÂûã" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="grammarFilename">„Éï„Ç°„Ç§„É´Âêç *</label>
                        <input type="text" id="grammarFilename" placeholder="‰æã: v-intransitive-type1" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="grammarJsonFile">ÂØæÂøúJSON„Éï„Ç°„Ç§„É´ *</label>
                        <input type="text" id="grammarJsonFile" placeholder="‰æã: VËá™ÂãïË©ûÁ¨¨1ÊñáÂûã.json" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label for="grammarDescription">Ë™¨ÊòéÊñá</label>
                    <input type="text" id="grammarDescription" placeholder="‰æã: ‰∏ªË™ûÔºãÂãïË©û„ÅÆÂü∫Êú¨ÊñáÂûã„ÇíÂ≠¶Áøí„Åó„Åæ„Åô" class="form-input">
                </div>
            </div>

            <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑÂÖ•Âäõ -->
            <div class="editor-section">
                <h3>üìù Êú¨Êñá„Ç≥„É≥„ÉÜ„É≥„ÉÑ</h3>
                <div class="content-editor">
                    <textarea id="contentEditor" placeholder="„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆÊñáÁ´†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...

‰æã:
## Ëá™ÂãïË©ûÁ¨¨1ÊñáÂûã„Å®„ÅØ

Ëá™ÂãïË©ûÁ¨¨1ÊñáÂûã„ÅØ„ÄÅËã±Ë™û„ÅÆÊúÄ„ÇÇÂü∫Êú¨ÁöÑ„Å™ÊñáÂûã„Åß„Åô„ÄÇ

### Âü∫Êú¨ÊßãÈÄ†
‰∏ªË™ûÔºàSÔºâÔºã ÂãïË©ûÔºàVÔºâ

### ‰æãÊñá
- I run. (ÁßÅ„ÅØËµ∞„Çã)
- She sleeps. (ÂΩºÂ•≥„ÅØÁú†„Çã)
- The sun rises. (Â§™ÈôΩ„ÅåÊòá„Çã)

„Åì„ÅÆÊñáÂûã„Åß„ÅØ„ÄÅÂãïË©û„ÅØÁõÆÁöÑË™û„ÇíÂøÖË¶Å„Å®„Åó„Åæ„Åõ„Çì„ÄÇ"></textarea>
                </div>
                <div class="editor-toolbar">
                    <button class="btn-small" onclick="insertMarkdown('## ', '')" title="Ë¶ãÂá∫„Åó2">H2</button>
                    <button class="btn-small" onclick="insertMarkdown('### ', '')" title="Ë¶ãÂá∫„Åó3">H3</button>
                    <button class="btn-small" onclick="insertMarkdown('**', '**')" title="Â§™Â≠ó">B</button>
                    <button class="btn-small" onclick="insertMarkdown('*', '*')" title="Êñú‰Ωì">I</button>
                    <button class="btn-small" onclick="insertMarkdown('- ', '')" title="„É™„Çπ„Éà">‚Ä¢</button>
                    <button class="btn-small" onclick="insertExample()" title="‰æãÊñá„Éú„ÉÉ„ÇØ„Çπ">‰æã</button>
                    <button class="btn-small" onclick="insertKeyPoint()" title="ÈáçË¶Å„Éù„Ç§„É≥„Éà">‚≠ê</button>
                </div>
            </div>

            <!-- „Éó„É¨„Éì„É•„Éº„ÉªÁîüÊàê„Éú„Çø„É≥ -->
            <div class="button-group">
                <button class="action-button btn-info" onclick="livePreview()">
                    üëÄ „É©„Ç§„Éñ„Éó„É¨„Éì„É•„Éº
                </button>
                <button class="action-button btn-primary" onclick="generateFromEditor()">
                    ‚ú® „Éö„Éº„Ç∏ÁîüÊàê
                </button>
                <button class="action-button btn-success" onclick="saveToMetadata()">
                    üíæ „É°„Çø„Éá„Éº„Çø‰øùÂ≠ò
                </button>
                <button class="action-button btn-warning" onclick="clearEditor()">
                    üóëÔ∏è „Ç®„Éá„Ç£„Çø„ÇØ„É™„Ç¢
                </button>
            </div>

            <!-- „É©„Ç§„Éñ„Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ -->
            <div id="livePreviewContainer" style="display: none;">
                <h4>üìñ „É©„Ç§„Éñ„Éó„É¨„Éì„É•„Éº</h4>
                <div id="livePreviewContent" class="preview-content"></div>
            </div>
        </div>

        <!-- Êó¢Â≠òÈ†ÖÁõÆÁÆ°ÁêÜ -->
        <div class="control-section">
            <h2>üìö Êó¢Â≠òÈ†ÖÁõÆÁÆ°ÁêÜ</h2>
            <p>‰øùÂ≠òÊ∏à„Åø„ÅÆÊñáÊ≥ïÈ†ÖÁõÆ„ÇíÁ∑®ÈõÜ„Éª„Éó„É¨„Éì„É•„Éº„ÉªÁîüÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div class="grammar-list" id="grammarList">
                <p>ÊñáÊ≥ïÈ†ÖÁõÆ„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
            <div class="button-group">
                <button class="action-button btn-info" onclick="refreshGrammarList()">
                    üîÑ „É™„Çπ„ÉàÊõ¥Êñ∞
                </button>
                <button class="action-button btn-primary" id="generateSelectedBtn" onclick="generateSelectedPage()" disabled>
                    ‚ú® ÈÅ∏Êäû„Éö„Éº„Ç∏ÁîüÊàê
                </button>
                <button class="action-button btn-warning" onclick="closePreview()">
                    ‚ùå „Éó„É¨„Éì„É•„ÉºÈñâ„Åò„Çã
                </button>
            </div>
            <div id="selectedPageInfo" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p><strong>ÈÅ∏Êäû‰∏≠:</strong> <span id="selectedPageName">-</span></p>
            </div>
            <iframe class="preview-frame" id="previewFrame" style="display: none;"></iframe>
        </div>

        <!-- „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†± -->
        <div class="control-section">
            <h2>‚ÑπÔ∏è „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±</h2>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>üìã „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´</h3>
                    <p><code>template.html</code></p>
                    <p>Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥„ÉÜ„É≥„Éó„É¨„Éº„Éà</p>
                </div>
                <div class="info-card">
                    <h3>üìä „É°„Çø„Éá„Éº„Çø„Éï„Ç°„Ç§„É´</h3>
                    <p><code>grammar-metadata.json</code></p>
                    <p>ÊñáÊ≥ïÈ†ÖÁõÆÂÆöÁæ©„Éá„Éº„Çø</p>
                </div>
                <div class="info-card">
                    <h3>‚öôÔ∏è ÁîüÊàê„Ç®„É≥„Ç∏„É≥</h3>
                    <p><code>generator.js</code></p>
                    <p>ÂãïÁöÑÁîüÊàê„Ç∑„Çπ„ÉÜ„É†Êú¨‰Ωì</p>
                </div>
                <div class="info-card">
                    <h3>üîß ÁÆ°ÁêÜ„Éë„Éç„É´</h3>
                    <p><code>admin-panel.html</code></p>
                    <p>„Åì„ÅÆ„Éö„Éº„Ç∏</p>
                </div>
            </div>
        </div>
    </div>

    <script src="./generator.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let generator = null;
        let tester = null;
        let currentMetadata = null;
        let selectedGrammarKey = null;
        let editorData = null;

        // Markdown„Ç≥„É≥„ÉÜ„É≥„ÉÑÂá¶ÁêÜ„ÇØ„É©„Çπ
        class MarkdownProcessor {
            static process(content) {
                let html = content;
                
                // Ë¶ãÂá∫„ÅóÂá¶ÁêÜ
                html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
                
                // Â§™Â≠ó„ÉªÊñú‰Ωì
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                
                // „É™„Çπ„ÉàÂá¶ÁêÜ
                html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                
                // ÊÆµËêΩÂá¶ÁêÜ
                html = html.replace(/\n\n/g, '</p><p>');
                html = '<p>' + html + '</p>';
                
                // Á©∫„ÅÆÊÆµËêΩÈô§Âéª
                html = html.replace(/<p><\/p>/g, '');
                html = html.replace(/<p>\s*<h/g, '<h');
                html = html.replace(/h>\s*<\/p>/g, 'h>');
                html = html.replace(/<p>\s*<ul>/g, '<ul>');
                html = html.replace(/<\/ul>\s*<\/p>/g, '</ul>');
                
                return html;
            }

            static addSpecialBoxes(content) {
                // ‰æãÊñá„Éú„ÉÉ„ÇØ„Çπ [[‰æãÊñá: ]] Ë®òÊ≥ï
                content = content.replace(/\[\[‰æãÊñá: (.+?)\]\]/g, 
                    '<div class="example-box"><h4>‰æãÊñá</h4><div class="example-sentence">$1</div></div>');
                
                // ÈáçË¶Å„Éù„Ç§„É≥„Éà [[ÈáçË¶Å: ]] Ë®òÊ≥ï
                content = content.replace(/\[\[ÈáçË¶Å: (.+?)\]\]/g, 
                    '<div class="key-point"><h4>ÈáçË¶Å„Éù„Ç§„É≥„Éà</h4><p>$1</p></div>');
                
                // Ê≥®ÊÑè [[Ê≥®ÊÑè: ]] Ë®òÊ≥ï
                content = content.replace(/\[\[Ê≥®ÊÑè: (.+?)\]\]/g, 
                    '<div class="warning-box"><h4>Ê≥®ÊÑè</h4><p>$1</p></div>');
                
                return content;
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        async function initializeSystem() {
            try {
                generator = new GrammarPageGenerator();
                tester = new GrammarSystemTester();
                
                logMessage('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
                updateSystemStatus('ready');
                await loadSystemInfo();
                await refreshGrammarList();
                
            } catch (error) {
                logMessage(`„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥ÅÊõ¥Êñ∞
        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            const now = new Date().toLocaleString('ja-JP');
            
            switch (status) {
                case 'ready':
                    statusElement.innerHTML = `„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü <span class="status-indicator status-ready">Á®ºÂÉç‰∏≠</span>`;
                    break;
                case 'working':
                    statusElement.innerHTML = `Âá¶ÁêÜÂÆüË°å‰∏≠... <span class="status-indicator status-working">ÂÆüË°å‰∏≠</span>`;
                    break;
                case 'error':
                    statusElement.innerHTML = `„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº <span class="status-indicator status-error">„Ç®„É©„Éº</span>`;
                    break;
            }
            
            document.getElementById('lastUpdate').textContent = now;
        }

        // „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        async function loadSystemInfo() {
            try {
                currentMetadata = await generator.loadMetadata();
                if (currentMetadata) {
                    const grammarCount = Object.keys(currentMetadata).length;
                    document.getElementById('grammarCount').textContent = `${grammarCount} È†ÖÁõÆ`;
                    document.getElementById('pageCount').textContent = `${grammarCount} „Éö„Éº„Ç∏`;
                    document.getElementById('mappingStatus').textContent = 'Ê≠£Â∏∏';
                } else {
                    document.getElementById('grammarCount').textContent = 'Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº';
                    document.getElementById('pageCount').textContent = 'Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº';
                    document.getElementById('mappingStatus').textContent = '„Ç®„É©„Éº';
                }
            } catch (error) {
                logMessage(`„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
        function logMessage(message, type = 'info') {
            const outputLog = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = `[${timestamp}] ${message}`;
            
            // Êó¢Â≠ò„ÅÆ„É≠„Ç∞„Å´ËøΩÂä†
            const currentLog = outputLog.textContent;
            if (currentLog === 'Êìç‰Ωú„É≠„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...') {
                outputLog.textContent = logEntry;
            } else {
                outputLog.textContent = currentLog + '\n' + logEntry;
            }
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            outputLog.parentElement.scrollTop = outputLog.parentElement.scrollHeight;
        }

        // ÂÖ®„Éö„Éº„Ç∏ÁîüÊàê
        async function generateAllPages() {
            updateSystemStatus('working');
            logMessage('ÂÖ®„Éö„Éº„Ç∏ÁîüÊàêÈñãÂßã...', 'info');
            
            try {
                const results = await generator.generateAllPages();
                
                let successCount = 0;
                let errorCount = 0;
                
                results.forEach(result => {
                    if (result.success) {
                        successCount++;
                        logMessage(`‚úÖ ${result.displayName} ÁîüÊàêÂÆå‰∫Ü`, 'success');
                    } else {
                        errorCount++;
                        logMessage(`‚ùå ${result.displayName} ÁîüÊàêÂ§±Êïó: ${result.error}`, 'error');
                    }
                });
                
                logMessage(`ÁîüÊàêÂÆå‰∫Ü: ÊàêÂäü ${successCount}‰ª∂, Â§±Êïó ${errorCount}‰ª∂`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ÂÖ®„Éö„Éº„Ç∏ÁîüÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // „Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàê
        async function generateMapping() {
            updateSystemStatus('working');
            logMessage('„Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàêÈñãÂßã...', 'info');
            
            try {
                const mapping = await generator.generateGrammarMapping();
                const links = await generator.generateMatrixLinks();
                
                if (mapping && links) {
                    logMessage(`‚úÖ „Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàêÂÆå‰∫Ü: ${Object.keys(mapping).length} È†ÖÁõÆ`, 'success');
                    logMessage(`‚úÖ „Éû„Éà„É™„ÇØ„Çπ„É™„É≥„ÇØÁîüÊàêÂÆå‰∫Ü: ${links.length} „É™„É≥„ÇØ`, 'success');
                    
                    // „Éû„ÉÉ„Éî„É≥„Ç∞ÊÉÖÂ†±„Çí„É≠„Ç∞„Å´Âá∫Âäõ
                    logMessage('--- ÁîüÊàê„Åï„Çå„Åü„Éû„ÉÉ„Éî„É≥„Ç∞ÊÉÖÂ†± ---', 'info');
                    Object.entries(mapping).forEach(([key, value]) => {
                        logMessage(`  ${key} ‚Üí ${value}`, 'info');
                    });
                } else {
                    logMessage('‚ùå „Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`„Éû„ÉÉ„Éî„É≥„Ç∞ÁîüÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Ê§úË®º
        async function validateSystem() {
            updateSystemStatus('working');
            logMessage('„Ç∑„Çπ„ÉÜ„É†Ê§úË®ºÈñãÂßã...', 'info');
            
            try {
                // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊ§úË®º
                const template = await generator.loadTemplate();
                if (template) {
                    logMessage('‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´: Ê≠£Â∏∏', 'success');
                } else {
                    logMessage('‚ùå „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´: Ë™≠„ÅøËæº„ÅøÂ§±Êïó', 'error');
                }
                
                // „É°„Çø„Éá„Éº„ÇøÊ§úË®º
                const metadata = await generator.loadMetadata();
                if (metadata) {
                    logMessage(`‚úÖ „É°„Çø„Éá„Éº„Çø„Éï„Ç°„Ç§„É´: Ê≠£Â∏∏ (${Object.keys(metadata).length} È†ÖÁõÆ)`, 'success');
                    
                    // ÂêÑÈ†ÖÁõÆ„ÅÆÊ§úË®º
                    Object.entries(metadata).forEach(([key, data]) => {
                        if (data.displayName && data.grammarKey && data.filename) {
                            logMessage(`  ‚úÖ ${data.displayName}: ÂøÖÈ†à„Éï„Ç£„Éº„É´„ÉâÂÆåÂÇô`, 'success');
                        } else {
                            logMessage(`  ‚ùå ${data.displayName || key}: ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ‰∏çË∂≥`, 'error');
                        }
                    });
                } else {
                    logMessage('‚ùå „É°„Çø„Éá„Éº„Çø„Éï„Ç°„Ç§„É´: Ë™≠„ÅøËæº„ÅøÂ§±Êïó', 'error');
                }
                
                logMessage('„Ç∑„Çπ„ÉÜ„É†Ê§úË®ºÂÆå‰∫Ü', 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`„Ç∑„Çπ„ÉÜ„É†Ê§úË®º„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å
        async function runFullTest() {
            updateSystemStatus('working');
            logMessage('ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
            
            try {
                const results = await tester.runTests();
                
                logMessage('--- „ÉÜ„Çπ„ÉàÁµêÊûú ---', 'info');
                logMessage(`ÁîüÊàê„Åï„Çå„Åü„Éö„Éº„Ç∏Êï∞: ${results.pages.length}`, 'info');
                logMessage(`„Éû„ÉÉ„Éî„É≥„Ç∞È†ÖÁõÆÊï∞: ${Object.keys(results.mapping).length}`, 'info');
                logMessage(`„Éû„Éà„É™„ÇØ„Çπ„É™„É≥„ÇØÊï∞: ${results.links.length}`, 'info');
                
                logMessage('‚úÖ ÂÆåÂÖ®„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ÂÆåÂÖ®„ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ÊñáÊ≥ïÈ†ÖÁõÆ„É™„Çπ„ÉàÊõ¥Êñ∞
        async function refreshGrammarList() {
            const listContainer = document.getElementById('grammarList');
            
            try {
                if (!currentMetadata) {
                    currentMetadata = await generator.loadMetadata();
                }
                
                if (!currentMetadata) {
                    listContainer.innerHTML = '<p>„É°„Çø„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
                    return;
                }
                
                let html = '';
                Object.entries(currentMetadata).forEach(([key, data]) => {
                    html += `
                        <div class="grammar-item" onclick="previewPage('${key}')">
                            <div>
                                <div class="grammar-name">${data.displayName}</div>
                                <div class="grammar-key">${data.grammarKey}</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="event.stopPropagation(); loadToEditor('${key}')" class="btn-small" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                <div onclick="event.stopPropagation();">üëÅÔ∏è</div>
                            </div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
                logMessage(`ÊñáÊ≥ïÈ†ÖÁõÆ„É™„Çπ„ÉàÊõ¥Êñ∞ÂÆå‰∫Ü: ${Object.keys(currentMetadata).length} È†ÖÁõÆ`, 'success');
                
            } catch (error) {
                listContainer.innerHTML = '<p>ÊñáÊ≥ïÈ†ÖÁõÆ„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
                logMessage(`ÊñáÊ≥ïÈ†ÖÁõÆ„É™„Çπ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „Éö„Éº„Ç∏„Éó„É¨„Éì„É•„Éº
        async function previewPage(grammarKey) {
            const previewFrame = document.getElementById('previewFrame');
            
            try {
                updateSystemStatus('working');
                logMessage(`„Éó„É¨„Éì„É•„ÉºÁîüÊàê‰∏≠: ${grammarKey}`, 'info');
                
                const result = await tester.previewPage(grammarKey);
                
                if (result) {
                    previewFrame.src = result.url;
                    previewFrame.style.display = 'block';
                    
                    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                    selectedGrammarKey = grammarKey;
                    document.getElementById('selectedPageInfo').style.display = 'block';
                    document.getElementById('selectedPageName').textContent = result.displayName;
                    document.getElementById('generateSelectedBtn').disabled = false;
                    
                    logMessage(`‚úÖ „Éó„É¨„Éì„É•„ÉºÁîüÊàêÂÆå‰∫Ü: ${result.displayName}`, 'success');
                } else {
                    logMessage('‚ùå „Éó„É¨„Éì„É•„ÉºÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`„Éó„É¨„Éì„É•„Éº„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ÈÅ∏Êäû„Åï„Çå„Åü„Éö„Éº„Ç∏„ÅÆÂÄãÂà•ÁîüÊàê
        async function generateSelectedPage() {
            if (!selectedGrammarKey) {
                logMessage('‚ùå ÁîüÊàêÂØæË±°„Éö„Éº„Ç∏„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            updateSystemStatus('working');
            const pageData = currentMetadata[selectedGrammarKey];
            logMessage(`ÂÄãÂà•„Éö„Éº„Ç∏ÁîüÊàêÈñãÂßã: ${pageData.displayName}`, 'info');
            
            try {
                const template = await generator.loadTemplate();
                const html = generator.generatePage(template, pageData);
                
                // ÁîüÊàê„Åï„Çå„ÅüHTML„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ„Å´„Åô„Çã
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${pageData.filename}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logMessage(`‚úÖ ${pageData.displayName} ÁîüÊàêÂÆå‰∫Ü„Éª„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈñãÂßã`, 'success');
                logMessage(`üìÅ „Éï„Ç°„Ç§„É´Âêç: ${pageData.filename}.html`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ÂÄãÂà•ÁîüÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // „Éó„É¨„Éì„É•„ÉºÈñâ„Åò„Çã
        function closePreview() {
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.style.display = 'none';
            previewFrame.src = '';
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            selectedGrammarKey = null;
            document.getElementById('selectedPageInfo').style.display = 'none';
            document.getElementById('generateSelectedBtn').disabled = true;
            
            logMessage('„Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Åæ„Åó„Åü', 'info');
        }

        // „Ç®„Éá„Ç£„ÇøÊ©üËÉΩ
        function insertMarkdown(before, after) {
            const textarea = document.getElementById('contentEditor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const newText = before + selectedText + after;
            
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
        }

        function insertExample() {
            const textarea = document.getElementById('contentEditor');
            const exampleText = '\n[[‰æãÊñá: „Åì„Åì„Å´‰æãÊñá„ÇíÂÖ•Âäõ]]\n';
            const cursorPos = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, cursorPos) + exampleText + textarea.value.substring(cursorPos);
            textarea.focus();
            textarea.setSelectionRange(cursorPos + 7, cursorPos + exampleText.length - 3);
        }

        function insertKeyPoint() {
            const textarea = document.getElementById('contentEditor');
            const pointText = '\n[[ÈáçË¶Å: ÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÂÖ•Âäõ]]\n';
            const cursorPos = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, cursorPos) + pointText + textarea.value.substring(cursorPos);
            textarea.focus();
            textarea.setSelectionRange(cursorPos + 7, cursorPos + pointText.length - 3);
        }

        // „É©„Ç§„Éñ„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ
        function livePreview() {
            const content = document.getElementById('contentEditor').value;
            const container = document.getElementById('livePreviewContainer');
            const previewContent = document.getElementById('livePreviewContent');
            
            if (!content.trim()) {
                logMessage('‚ùå „Éó„É¨„Éì„É•„Éº„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            try {
                // Markdown„ÇíÂá¶ÁêÜ
                let processedContent = MarkdownProcessor.addSpecialBoxes(content);
                processedContent = MarkdownProcessor.process(processedContent);
                
                previewContent.innerHTML = processedContent;
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
                
                logMessage('‚úÖ „É©„Ç§„Éñ„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞ÂÆå‰∫Ü', 'success');
                
            } catch (error) {
                logMessage(`„Éó„É¨„Éì„É•„Éº„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „Ç®„Éá„Ç£„Çø„Åã„Çâ„Éö„Éº„Ç∏ÁîüÊàê
        async function generateFromEditor() {
            const displayName = document.getElementById('grammarDisplayName').value.trim();
            const grammarKey = document.getElementById('grammarKey').value.trim();
            const filename = document.getElementById('grammarFilename').value.trim();
            const jsonFile = document.getElementById('grammarJsonFile').value.trim();
            const description = document.getElementById('grammarDescription').value.trim();
            const content = document.getElementById('contentEditor').value.trim();
            
            // ÂÖ•ÂäõÊ§úË®º
            if (!displayName || !grammarKey || !filename || !jsonFile || !content) {
                logMessage('‚ùå ÂøÖÈ†àÈ†ÖÁõÆ„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            updateSystemStatus('working');
            logMessage('„Ç®„Éá„Ç£„Çø„Åã„Çâ„Éö„Éº„Ç∏ÁîüÊàêÈñãÂßã...', 'info');
            
            try {
                // „Ç≥„É≥„ÉÜ„É≥„ÉÑÂá¶ÁêÜ
                let processedContent = MarkdownProcessor.addSpecialBoxes(content);
                processedContent = MarkdownProcessor.process(processedContent);
                
                // HTML„Éö„Éº„Ç∏ÁîüÊàê
                const template = await generator.loadTemplate();
                if (!template) {
                    logMessage('‚ùå „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    return;
                }
                
                const pageData = {
                    displayName: displayName,
                    grammarKey: grammarKey,
                    filename: filename,
                    description: description || `${displayName}„ÅÆÊñáÊ≥ïËß£Ë™¨`,
                    content: processedContent
                };
                
                // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞ÁΩÆÊèõ
                let html = template
                    .replace(/\{\{displayName\}\}/g, pageData.displayName)
                    .replace(/\{\{description\}\}/g, pageData.description)
                    .replace(/\{\{grammarKey\}\}/g, pageData.grammarKey)
                    .replace(/\{\{content\}\}/g, 
                        `<section class="content-section">${pageData.content}</section>`);
                
                // HTML„Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // „Ç®„Éá„Ç£„Çø„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„É°„Çø„Éá„Éº„ÇøÁî®Ôºâ
                editorData = {
                    key: filename,
                    displayName: displayName,
                    grammarKey: grammarKey,
                    filename: filename,
                    jsonFile: jsonFile,
                    description: description,
                    rawContent: content,
                    processedContent: processedContent
                };
                
                logMessage(`‚úÖ ${displayName} ÁîüÊàêÂÆå‰∫Ü„Éª„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈñãÂßã`, 'success');
                logMessage(`üìÅ „Éï„Ç°„Ç§„É´Âêç: ${filename}.html`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ÁîüÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // „É°„Çø„Éá„Éº„Çø„Å´‰øùÂ≠ò
        async function saveToMetadata() {
            if (!editorData) {
                logMessage('‚ùå ‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´„Éö„Éº„Ç∏ÁîüÊàê„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                const metadata = await generator.loadMetadata() || {};
                
                // „É°„Çø„Éá„Éº„ÇøÂΩ¢Âºè„Å´Â§âÊèõ
                metadata[editorData.key] = {
                    displayName: editorData.displayName,
                    grammarKey: editorData.grammarKey,
                    filename: editorData.filename,
                    jsonFile: editorData.jsonFile,
                    description: editorData.description,
                    category: "grammar-basics",
                    priority: Object.keys(metadata).length + 1,
                    matrixDisplay: editorData.displayName,
                    content: {
                        sections: [{
                            title: editorData.displayName,
                            content: [{
                                type: "custom-html",
                                html: editorData.processedContent
                            }]
                        }]
                    }
                };
                
                // JSONÂá∫ÂäõÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºâ
                const blob = new Blob([JSON.stringify(metadata, null, 2)], { 
                    type: 'application/json; charset=utf-8' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grammar-metadata.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logMessage(`‚úÖ „É°„Çø„Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü: ${editorData.displayName}`, 'success');
                logMessage('üìÅ „Éï„Ç°„Ç§„É´Âêç: grammar-metadata.json', 'info');
                
                // „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±Êõ¥Êñ∞
                currentMetadata = metadata;
                await loadSystemInfo();
                
            } catch (error) {
                logMessage(`„É°„Çø„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „Ç®„Éá„Ç£„Çø„ÇØ„É™„Ç¢
        function clearEditor() {
            if (confirm('„Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                document.getElementById('grammarDisplayName').value = '';
                document.getElementById('grammarKey').value = '';
                document.getElementById('grammarFilename').value = '';
                document.getElementById('grammarJsonFile').value = '';
                document.getElementById('grammarDescription').value = '';
                document.getElementById('contentEditor').value = '';
                document.getElementById('livePreviewContainer').style.display = 'none';
                
                editorData = null;
                logMessage('„Ç®„Éá„Ç£„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
            }
        }

        // Êó¢Â≠òÈ†ÖÁõÆ„ÇíÁ∑®ÈõÜ„Ç®„É™„Ç¢„Å´„É≠„Éº„Éâ
        async function loadToEditor(grammarKey) {
            try {
                if (!currentMetadata || !currentMetadata[grammarKey]) {
                    logMessage('‚ùå È†ÖÁõÆ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                    return;
                }
                
                const data = currentMetadata[grammarKey];
                
                // Âü∫Êú¨ÊÉÖÂ†±„Çí„Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö
                document.getElementById('grammarDisplayName').value = data.displayName || '';
                document.getElementById('grammarKey').value = data.grammarKey || '';
                document.getElementById('grammarFilename').value = data.filename || '';
                document.getElementById('grammarJsonFile').value = data.jsonFile || '';
                document.getElementById('grammarDescription').value = data.description || '';
                
                // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢ÔºàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÊ∫ñÂÇôÔºâ
                document.getElementById('contentEditor').value = 'Á∑®ÈõÜÁî®„ÅÆMarkdown„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...';
                
                logMessage(`‚úÖ ${data.displayName} „Çí„Ç®„Éá„Ç£„Çø„Å´„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü`, 'success');
                logMessage('üí° „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢„Å´Êñ∞„Åó„ÅÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶Á∑®ÈõÜ„Åß„Åç„Åæ„Åô', 'info');
                
                // „Ç®„Éá„Ç£„Çø„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
                const editorSection = document.querySelector('.control-section h2');
                if (editorSection && editorSection.textContent.includes('‚úçÔ∏è')) {
                    editorSection.scrollIntoView({ behavior: 'smooth' });
                }
                
            } catch (error) {
                logMessage(`Á∑®ÈõÜ„É≠„Éº„Éâ„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('ÁÆ°ÁêÜ„Éë„Éç„É´Ëµ∑Âãï‰∏≠...', 'info');
            initializeSystem();
        });
    </script>
</body>
</html>
