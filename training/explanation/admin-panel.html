<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ‘ãƒãƒ« - Rephrase</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* ç®¡ç†ãƒ‘ãƒãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 2em;
        }

        .admin-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ */
        .control-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .warning-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 0.95em;
        }

        .control-section h2 {
            color: #1976D2;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 140px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #00BCD4;
            color: white;
        }

        .btn-info:hover {
            background: #0097A7;
            transform: translateY(-2px);
        }

        .output-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-ready {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .status-working {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .preview-frame {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 20px 0;
        }

        .metadata-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 1.1em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .log-success {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .log-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .log-info {
            background: #E3F2FD;
            color: #1565C0;
        }

        .grammar-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }

        .grammar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .grammar-item:hover {
            background: #f8f9fa;
        }

        .grammar-item:last-child {
            border-bottom: none;
        }

        .grammar-name {
            font-weight: 500;
            color: #333;
        }

        .grammar-key {
            font-size: 0.85em;
            color: #666;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="admin-header">
            <h1>ğŸš€ Rephrase å‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ‘ãƒãƒ«</h1>
            <p>æ–‡æ³•èª¬æ˜ãƒšãƒ¼ã‚¸ã®ä¸€æ‹¬ç”Ÿæˆãƒ»ç®¡ç†ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</p>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
        <div class="control-section">
            <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h2>
            <p id="systemStatus">ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯ä¸­...<span class="status-indicator status-working">ç¢ºèªä¸­</span></p>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>ğŸ“„ ç™»éŒ²æ¸ˆã¿æ–‡æ³•é …ç›®</h3>
                    <p id="grammarCount">-</p>
                </div>
                <div class="info-card">
                    <h3>ğŸ—‚ï¸ ç”Ÿæˆå¯èƒ½ãƒšãƒ¼ã‚¸</h3>
                    <p id="pageCount">-</p>
                </div>
                <div class="info-card">
                    <h3>ğŸ”— ãƒãƒƒãƒ”ãƒ³ã‚°çŠ¶æ³</h3>
                    <p id="mappingStatus">-</p>
                </div>
                <div class="info-card">
                    <h3>â° æœ€çµ‚æ›´æ–°</h3>
                    <p id="lastUpdate">-</p>
                </div>
            </div>
        </div>

        <!-- ç”Ÿæˆæ“ä½œ -->
        <div class="control-section">
            <h2>âš¡ ç”Ÿæˆæ“ä½œ</h2>
            <p class="warning-note">âš ï¸ <strong>é‹ç”¨æ–¹é‡:</strong> ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æ®µéšçš„å…¬é–‹ã®ãŸã‚ã€å®Œæˆã—ãŸãƒšãƒ¼ã‚¸ã®ã¿å€‹åˆ¥ç”Ÿæˆã‚’æ¨å¥¨</p>
            <div class="button-group">
                <button class="action-button btn-primary" onclick="generateSinglePage()" disabled>
                    ğŸ“„ é¸æŠãƒšãƒ¼ã‚¸ç”Ÿæˆ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰é¸æŠ)
                </button>
                <button class="action-button btn-success" onclick="generateMapping()">
                    ğŸ”— ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆ
                </button>
                <button class="action-button btn-warning" onclick="validateSystem()">
                    âœ… ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼
                </button>
                <button class="action-button btn-info" onclick="runFullTest()">
                    ğŸ§ª å®Œå…¨ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; color: #666; font-size: 0.9em;">âš ï¸ ä¸€æ‹¬ç”Ÿæˆæ©Ÿèƒ½ï¼ˆéæ¨å¥¨ï¼‰</summary>
                <div style="padding: 15px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">
                    <p><strong>æ³¨æ„:</strong> å…¨ãƒšãƒ¼ã‚¸ä¸€æ‹¬ç”Ÿæˆã¯é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨é€”ã®ã¿</p>
                    <button class="action-button btn-warning" onclick="generateAllPages()" style="margin-top: 10px;">
                        âš ï¸ å…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆï¼ˆé–‹ç™ºç”¨ï¼‰
                    </button>
                </div>
            </details></div>
            <div class="output-container">
                <pre id="outputLog">æ“ä½œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ -->
        <div class="control-section">
            <h2>ğŸ‘€ ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†å€‹åˆ¥ç”Ÿæˆ</h2>
            <p>å®Œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèªå¾Œã€å€‹åˆ¥ã«ç”Ÿæˆã§ãã¾ã™ã€‚</p>
            <div class="grammar-list" id="grammarList">
                <p>æ–‡æ³•é …ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div class="button-group">
                <button class="action-button btn-info" onclick="refreshGrammarList()">
                    ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°
                </button>
                <button class="action-button btn-primary" id="generateSelectedBtn" onclick="generateSelectedPage()" disabled>
                    âœ¨ é¸æŠãƒšãƒ¼ã‚¸ç”Ÿæˆ
                </button>
                <button class="action-button btn-warning" onclick="closePreview()">
                    âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
                </button>
            </div>
            <div id="selectedPageInfo" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p><strong>é¸æŠä¸­:</strong> <span id="selectedPageName">-</span></p>
            </div>
            <iframe class="preview-frame" id="previewFrame" style="display: none;"></iframe>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
        <div class="control-section">
            <h2>â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h2>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«</h3>
                    <p><code>template.html</code></p>
                    <p>çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</p>
                </div>
                <div class="info-card">
                    <h3>ğŸ“Š ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                    <p><code>grammar-metadata.json</code></p>
                    <p>æ–‡æ³•é …ç›®å®šç¾©ãƒ‡ãƒ¼ã‚¿</p>
                </div>
                <div class="info-card">
                    <h3>âš™ï¸ ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³</h3>
                    <p><code>generator.js</code></p>
                    <p>å‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ æœ¬ä½“</p>
                </div>
                <div class="info-card">
                    <h3>ğŸ”§ ç®¡ç†ãƒ‘ãƒãƒ«</h3>
                    <p><code>admin-panel.html</code></p>
                    <p>ã“ã®ãƒšãƒ¼ã‚¸</p>
                </div>
            </div>
        </div>
    </div>

    <script src="./generator.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let generator = null;
        let tester = null;
        let currentMetadata = null;
        let selectedGrammarKey = null;

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeSystem() {
            try {
                generator = new GrammarPageGenerator();
                tester = new GrammarSystemTester();
                
                logMessage('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                updateSystemStatus('ready');
                await loadSystemInfo();
                await refreshGrammarList();
                
            } catch (error) {
                logMessage(`ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³æ›´æ–°
        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            const now = new Date().toLocaleString('ja-JP');
            
            switch (status) {
                case 'ready':
                    statusElement.innerHTML = `ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº† <span class="status-indicator status-ready">ç¨¼åƒä¸­</span>`;
                    break;
                case 'working':
                    statusElement.innerHTML = `å‡¦ç†å®Ÿè¡Œä¸­... <span class="status-indicator status-working">å®Ÿè¡Œä¸­</span>`;
                    break;
                case 'error':
                    statusElement.innerHTML = `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ <span class="status-indicator status-error">ã‚¨ãƒ©ãƒ¼</span>`;
                    break;
            }
            
            document.getElementById('lastUpdate').textContent = now;
        }

        // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±èª­ã¿è¾¼ã¿
        async function loadSystemInfo() {
            try {
                currentMetadata = await generator.loadMetadata();
                if (currentMetadata) {
                    const grammarCount = Object.keys(currentMetadata).length;
                    document.getElementById('grammarCount').textContent = `${grammarCount} é …ç›®`;
                    document.getElementById('pageCount').textContent = `${grammarCount} ãƒšãƒ¼ã‚¸`;
                    document.getElementById('mappingStatus').textContent = 'æ­£å¸¸';
                } else {
                    document.getElementById('grammarCount').textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    document.getElementById('pageCount').textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    document.getElementById('mappingStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
                }
            } catch (error) {
                logMessage(`ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function logMessage(message, type = 'info') {
            const outputLog = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = `[${timestamp}] ${message}`;
            
            // æ—¢å­˜ã®ãƒ­ã‚°ã«è¿½åŠ 
            const currentLog = outputLog.textContent;
            if (currentLog === 'æ“ä½œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...') {
                outputLog.textContent = logEntry;
            } else {
                outputLog.textContent = currentLog + '\n' + logEntry;
            }
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            outputLog.parentElement.scrollTop = outputLog.parentElement.scrollHeight;
        }

        // å…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        async function generateAllPages() {
            updateSystemStatus('working');
            logMessage('å…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆé–‹å§‹...', 'info');
            
            try {
                const results = await generator.generateAllPages();
                
                let successCount = 0;
                let errorCount = 0;
                
                results.forEach(result => {
                    if (result.success) {
                        successCount++;
                        logMessage(`âœ… ${result.displayName} ç”Ÿæˆå®Œäº†`, 'success');
                    } else {
                        errorCount++;
                        logMessage(`âŒ ${result.displayName} ç”Ÿæˆå¤±æ•—: ${result.error}`, 'error');
                    }
                });
                
                logMessage(`ç”Ÿæˆå®Œäº†: æˆåŠŸ ${successCount}ä»¶, å¤±æ•— ${errorCount}ä»¶`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`å…¨ãƒšãƒ¼ã‚¸ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆ
        async function generateMapping() {
            updateSystemStatus('working');
            logMessage('ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆé–‹å§‹...', 'info');
            
            try {
                const mapping = await generator.generateGrammarMapping();
                const links = await generator.generateMatrixLinks();
                
                if (mapping && links) {
                    logMessage(`âœ… ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆå®Œäº†: ${Object.keys(mapping).length} é …ç›®`, 'success');
                    logMessage(`âœ… ãƒãƒˆãƒªã‚¯ã‚¹ãƒªãƒ³ã‚¯ç”Ÿæˆå®Œäº†: ${links.length} ãƒªãƒ³ã‚¯`, 'success');
                    
                    // ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                    logMessage('--- ç”Ÿæˆã•ã‚ŒãŸãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ± ---', 'info');
                    Object.entries(mapping).forEach(([key, value]) => {
                        logMessage(`  ${key} â†’ ${value}`, 'info');
                    });
                } else {
                    logMessage('âŒ ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ãƒãƒƒãƒ”ãƒ³ã‚°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼
        async function validateSystem() {
            updateSystemStatus('working');
            logMessage('ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼é–‹å§‹...', 'info');
            
            try {
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼
                const template = await generator.loadTemplate();
                if (template) {
                    logMessage('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: æ­£å¸¸', 'success');
                } else {
                    logMessage('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                const metadata = await generator.loadMetadata();
                if (metadata) {
                    logMessage(`âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: æ­£å¸¸ (${Object.keys(metadata).length} é …ç›®)`, 'success');
                    
                    // å„é …ç›®ã®æ¤œè¨¼
                    Object.entries(metadata).forEach(([key, data]) => {
                        if (data.displayName && data.grammarKey && data.filename) {
                            logMessage(`  âœ… ${data.displayName}: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®Œå‚™`, 'success');
                        } else {
                            logMessage(`  âŒ ${data.displayName || key}: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³`, 'error');
                        }
                    });
                } else {
                    logMessage('âŒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }
                
                logMessage('ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼å®Œäº†', 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runFullTest() {
            updateSystemStatus('working');
            logMessage('å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');
            
            try {
                const results = await tester.runTests();
                
                logMessage('--- ãƒ†ã‚¹ãƒˆçµæœ ---', 'info');
                logMessage(`ç”Ÿæˆã•ã‚ŒãŸãƒšãƒ¼ã‚¸æ•°: ${results.pages.length}`, 'info');
                logMessage(`ãƒãƒƒãƒ”ãƒ³ã‚°é …ç›®æ•°: ${Object.keys(results.mapping).length}`, 'info');
                logMessage(`ãƒãƒˆãƒªã‚¯ã‚¹ãƒªãƒ³ã‚¯æ•°: ${results.links.length}`, 'info');
                
                logMessage('âœ… å®Œå…¨ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`å®Œå…¨ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // æ–‡æ³•é …ç›®ãƒªã‚¹ãƒˆæ›´æ–°
        async function refreshGrammarList() {
            const listContainer = document.getElementById('grammarList');
            
            try {
                if (!currentMetadata) {
                    currentMetadata = await generator.loadMetadata();
                }
                
                if (!currentMetadata) {
                    listContainer.innerHTML = '<p>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                    return;
                }
                
                let html = '';
                Object.entries(currentMetadata).forEach(([key, data]) => {
                    html += `
                        <div class="grammar-item" onclick="previewPage('${key}')">
                            <div>
                                <div class="grammar-name">${data.displayName}</div>
                                <div class="grammar-key">${data.grammarKey}</div>
                            </div>
                            <div>ğŸ‘ï¸</div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
                logMessage(`æ–‡æ³•é …ç›®ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†: ${Object.keys(currentMetadata).length} é …ç›®`, 'success');
                
            } catch (error) {
                listContainer.innerHTML = '<p>æ–‡æ³•é …ç›®ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                logMessage(`æ–‡æ³•é …ç›®ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        async function previewPage(grammarKey) {
            const previewFrame = document.getElementById('previewFrame');
            
            try {
                updateSystemStatus('working');
                logMessage(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­: ${grammarKey}`, 'info');
                
                const result = await tester.previewPage(grammarKey);
                
                if (result) {
                    previewFrame.src = result.url;
                    previewFrame.style.display = 'block';
                    
                    // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                    selectedGrammarKey = grammarKey;
                    document.getElementById('selectedPageInfo').style.display = 'block';
                    document.getElementById('selectedPageName').textContent = result.displayName;
                    document.getElementById('generateSelectedBtn').disabled = false;
                    
                    logMessage(`âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†: ${result.displayName}`, 'success');
                } else {
                    logMessage('âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // é¸æŠã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã®å€‹åˆ¥ç”Ÿæˆ
        async function generateSelectedPage() {
            if (!selectedGrammarKey) {
                logMessage('âŒ ç”Ÿæˆå¯¾è±¡ãƒšãƒ¼ã‚¸ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            updateSystemStatus('working');
            const pageData = currentMetadata[selectedGrammarKey];
            logMessage(`å€‹åˆ¥ãƒšãƒ¼ã‚¸ç”Ÿæˆé–‹å§‹: ${pageData.displayName}`, 'info');
            
            try {
                const template = await generator.loadTemplate();
                const html = generator.generatePage(template, pageData);
                
                // ç”Ÿæˆã•ã‚ŒãŸHTMLã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ã™ã‚‹
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${pageData.filename}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logMessage(`âœ… ${pageData.displayName} ç”Ÿæˆå®Œäº†ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹`, 'success');
                logMessage(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å: ${pageData.filename}.html`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`å€‹åˆ¥ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
        function closePreview() {
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.style.display = 'none';
            previewFrame.src = '';
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedGrammarKey = null;
            document.getElementById('selectedPageInfo').style.display = 'none';
            document.getElementById('generateSelectedBtn').disabled = true;
            
            logMessage('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¾ã—ãŸ', 'info');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('ç®¡ç†ãƒ‘ãƒãƒ«èµ·å‹•ä¸­...', 'info');
            initializeSystem();
        });
    </script>
</body>
</html>
