<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動的生成システム管理パネル - Rephrase</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* 管理パネル専用スタイル */
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 2em;
        }

        .admin-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        /* プレビュー機能 */
        .control-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .warning-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 0.95em;
        }

        .control-section h2 {
            color: #1976D2;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 140px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #00BCD4;
            color: white;
        }

        .btn-info:hover {
            background: #0097A7;
            transform: translateY(-2px);
        }

        .output-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-ready {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .status-working {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .preview-frame {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 20px 0;
        }

        .metadata-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 1.1em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .log-success {
            background: #E8F5E8;
            color: #2E7D2E;
        }

        .log-error {
            background: #FFEBEE;
            color: #C62828;
        }

        .log-info {
            background: #E3F2FD;
            color: #1565C0;
        }

        .grammar-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }

        .grammar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .grammar-item:hover {
            background: #f8f9fa;
        }

        .grammar-item:last-child {
            border-bottom: none;
        }

        .grammar-name {
            font-weight: 500;
            color: #333;
        }

        .grammar-key {
            font-size: 0.85em;
            color: #666;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ヘッダー -->
        <div class="admin-header">
            <h1>🚀 Rephrase 動的生成システム管理パネル</h1>
            <p>文法説明ページの一括生成・管理・プレビューツール</p>
        </div>

        <!-- システム状況 -->
        <div class="control-section">
            <h2>📊 システム状況</h2>
            <p id="systemStatus">システムチェック中...<span class="status-indicator status-working">確認中</span></p>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>📄 登録済み文法項目</h3>
                    <p id="grammarCount">-</p>
                </div>
                <div class="info-card">
                    <h3>🗂️ 生成可能ページ</h3>
                    <p id="pageCount">-</p>
                </div>
                <div class="info-card">
                    <h3>🔗 マッピング状況</h3>
                    <p id="mappingStatus">-</p>
                </div>
                <div class="info-card">
                    <h3>⏰ 最終更新</h3>
                    <p id="lastUpdate">-</p>
                </div>
            </div>
        </div>

        <!-- 生成操作 -->
        <div class="control-section">
            <h2>⚡ 生成操作</h2>
            <p class="warning-note">⚠️ <strong>運用方針:</strong> コンテンツは段階的公開のため、完成したページのみ個別生成を推奨</p>
            <div class="button-group">
                <button class="action-button btn-primary" onclick="generateSinglePage()" disabled>
                    📄 選択ページ生成 (プレビューから選択)
                </button>
                <button class="action-button btn-success" onclick="generateMapping()">
                    🔗 マッピング生成
                </button>
                <button class="action-button btn-warning" onclick="validateSystem()">
                    ✅ システム検証
                </button>
                <button class="action-button btn-info" onclick="runFullTest()">
                    🧪 完全テスト
                </button>
            </div>
            <details style="margin-top: 20px;">
                <summary style="cursor: pointer; color: #666; font-size: 0.9em;">⚠️ 一括生成機能（非推奨）</summary>
                <div style="padding: 15px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">
                    <p><strong>注意:</strong> 全ページ一括生成は開発・テスト用途のみ</p>
                    <button class="action-button btn-warning" onclick="generateAllPages()" style="margin-top: 10px;">
                        ⚠️ 全ページ生成（開発用）
                    </button>
                </div>
            </details></div>
            <div class="output-container">
                <pre id="outputLog">操作ログがここに表示されます...</pre>
            </div>
        </div>

        <!-- プレビュー機能 -->
        <div class="control-section">
            <h2>👀 ページプレビュー＆個別生成</h2>
            <p>完成したコンテンツを選択してプレビュー確認後、個別に生成できます。</p>
            <div class="grammar-list" id="grammarList">
                <p>文法項目を読み込み中...</p>
            </div>
            <div class="button-group">
                <button class="action-button btn-info" onclick="refreshGrammarList()">
                    🔄 リスト更新
                </button>
                <button class="action-button btn-primary" id="generateSelectedBtn" onclick="generateSelectedPage()" disabled>
                    ✨ 選択ページ生成
                </button>
                <button class="action-button btn-warning" onclick="closePreview()">
                    ❌ プレビュー閉じる
                </button>
            </div>
            <div id="selectedPageInfo" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p><strong>選択中:</strong> <span id="selectedPageName">-</span></p>
            </div>
            <iframe class="preview-frame" id="previewFrame" style="display: none;"></iframe>
        </div>

        <!-- システム情報 -->
        <div class="control-section">
            <h2>ℹ️ システム情報</h2>
            <div class="metadata-info">
                <div class="info-card">
                    <h3>📋 テンプレートファイル</h3>
                    <p><code>template.html</code></p>
                    <p>統一デザインテンプレート</p>
                </div>
                <div class="info-card">
                    <h3>📊 メタデータファイル</h3>
                    <p><code>grammar-metadata.json</code></p>
                    <p>文法項目定義データ</p>
                </div>
                <div class="info-card">
                    <h3>⚙️ 生成エンジン</h3>
                    <p><code>generator.js</code></p>
                    <p>動的生成システム本体</p>
                </div>
                <div class="info-card">
                    <h3>🔧 管理パネル</h3>
                    <p><code>admin-panel.html</code></p>
                    <p>このページ</p>
                </div>
            </div>
        </div>
    </div>

    <script src="./generator.js"></script>
    <script>
        // グローバル変数
        let generator = null;
        let tester = null;
        let currentMetadata = null;
        let selectedGrammarKey = null;

        // システム初期化
        async function initializeSystem() {
            try {
                generator = new GrammarPageGenerator();
                tester = new GrammarSystemTester();
                
                logMessage('システム初期化完了', 'success');
                updateSystemStatus('ready');
                await loadSystemInfo();
                await refreshGrammarList();
                
            } catch (error) {
                logMessage(`システム初期化エラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // システム状況更新
        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            const now = new Date().toLocaleString('ja-JP');
            
            switch (status) {
                case 'ready':
                    statusElement.innerHTML = `システム準備完了 <span class="status-indicator status-ready">稼働中</span>`;
                    break;
                case 'working':
                    statusElement.innerHTML = `処理実行中... <span class="status-indicator status-working">実行中</span>`;
                    break;
                case 'error':
                    statusElement.innerHTML = `システムエラー <span class="status-indicator status-error">エラー</span>`;
                    break;
            }
            
            document.getElementById('lastUpdate').textContent = now;
        }

        // システム情報読み込み
        async function loadSystemInfo() {
            try {
                currentMetadata = await generator.loadMetadata();
                if (currentMetadata) {
                    const grammarCount = Object.keys(currentMetadata).length;
                    document.getElementById('grammarCount').textContent = `${grammarCount} 項目`;
                    document.getElementById('pageCount').textContent = `${grammarCount} ページ`;
                    document.getElementById('mappingStatus').textContent = '正常';
                } else {
                    document.getElementById('grammarCount').textContent = '読み込みエラー';
                    document.getElementById('pageCount').textContent = '読み込みエラー';
                    document.getElementById('mappingStatus').textContent = 'エラー';
                }
            } catch (error) {
                logMessage(`システム情報読み込みエラー: ${error.message}`, 'error');
            }
        }

        // ログメッセージ追加
        function logMessage(message, type = 'info') {
            const outputLog = document.getElementById('outputLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = `[${timestamp}] ${message}`;
            
            // 既存のログに追加
            const currentLog = outputLog.textContent;
            if (currentLog === '操作ログがここに表示されます...') {
                outputLog.textContent = logEntry;
            } else {
                outputLog.textContent = currentLog + '\n' + logEntry;
            }
            
            // スクロールを最下部に
            outputLog.parentElement.scrollTop = outputLog.parentElement.scrollHeight;
        }

        // 全ページ生成
        async function generateAllPages() {
            updateSystemStatus('working');
            logMessage('全ページ生成開始...', 'info');
            
            try {
                const results = await generator.generateAllPages();
                
                let successCount = 0;
                let errorCount = 0;
                
                results.forEach(result => {
                    if (result.success) {
                        successCount++;
                        logMessage(`✅ ${result.displayName} 生成完了`, 'success');
                    } else {
                        errorCount++;
                        logMessage(`❌ ${result.displayName} 生成失敗: ${result.error}`, 'error');
                    }
                });
                
                logMessage(`生成完了: 成功 ${successCount}件, 失敗 ${errorCount}件`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`全ページ生成エラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // マッピング生成
        async function generateMapping() {
            updateSystemStatus('working');
            logMessage('マッピング生成開始...', 'info');
            
            try {
                const mapping = await generator.generateGrammarMapping();
                const links = await generator.generateMatrixLinks();
                
                if (mapping && links) {
                    logMessage(`✅ マッピング生成完了: ${Object.keys(mapping).length} 項目`, 'success');
                    logMessage(`✅ マトリクスリンク生成完了: ${links.length} リンク`, 'success');
                    
                    // マッピング情報をログに出力
                    logMessage('--- 生成されたマッピング情報 ---', 'info');
                    Object.entries(mapping).forEach(([key, value]) => {
                        logMessage(`  ${key} → ${value}`, 'info');
                    });
                } else {
                    logMessage('❌ マッピング生成に失敗しました', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`マッピング生成エラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // システム検証
        async function validateSystem() {
            updateSystemStatus('working');
            logMessage('システム検証開始...', 'info');
            
            try {
                // テンプレート検証
                const template = await generator.loadTemplate();
                if (template) {
                    logMessage('✅ テンプレートファイル: 正常', 'success');
                } else {
                    logMessage('❌ テンプレートファイル: 読み込み失敗', 'error');
                }
                
                // メタデータ検証
                const metadata = await generator.loadMetadata();
                if (metadata) {
                    logMessage(`✅ メタデータファイル: 正常 (${Object.keys(metadata).length} 項目)`, 'success');
                    
                    // 各項目の検証
                    Object.entries(metadata).forEach(([key, data]) => {
                        if (data.displayName && data.grammarKey && data.filename) {
                            logMessage(`  ✅ ${data.displayName}: 必須フィールド完備`, 'success');
                        } else {
                            logMessage(`  ❌ ${data.displayName || key}: 必須フィールド不足`, 'error');
                        }
                    });
                } else {
                    logMessage('❌ メタデータファイル: 読み込み失敗', 'error');
                }
                
                logMessage('システム検証完了', 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`システム検証エラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // 完全テスト実行
        async function runFullTest() {
            updateSystemStatus('working');
            logMessage('完全テスト開始...', 'info');
            
            try {
                const results = await tester.runTests();
                
                logMessage('--- テスト結果 ---', 'info');
                logMessage(`生成されたページ数: ${results.pages.length}`, 'info');
                logMessage(`マッピング項目数: ${Object.keys(results.mapping).length}`, 'info');
                logMessage(`マトリクスリンク数: ${results.links.length}`, 'info');
                
                logMessage('✅ 完全テスト完了', 'success');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`完全テストエラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // 文法項目リスト更新
        async function refreshGrammarList() {
            const listContainer = document.getElementById('grammarList');
            
            try {
                if (!currentMetadata) {
                    currentMetadata = await generator.loadMetadata();
                }
                
                if (!currentMetadata) {
                    listContainer.innerHTML = '<p>メタデータの読み込みに失敗しました</p>';
                    return;
                }
                
                let html = '';
                Object.entries(currentMetadata).forEach(([key, data]) => {
                    html += `
                        <div class="grammar-item" onclick="previewPage('${key}')">
                            <div>
                                <div class="grammar-name">${data.displayName}</div>
                                <div class="grammar-key">${data.grammarKey}</div>
                            </div>
                            <div>👁️</div>
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
                logMessage(`文法項目リスト更新完了: ${Object.keys(currentMetadata).length} 項目`, 'success');
                
            } catch (error) {
                listContainer.innerHTML = '<p>文法項目の読み込み中にエラーが発生しました</p>';
                logMessage(`文法項目リスト更新エラー: ${error.message}`, 'error');
            }
        }

        // ページプレビュー
        async function previewPage(grammarKey) {
            const previewFrame = document.getElementById('previewFrame');
            
            try {
                updateSystemStatus('working');
                logMessage(`プレビュー生成中: ${grammarKey}`, 'info');
                
                const result = await tester.previewPage(grammarKey);
                
                if (result) {
                    previewFrame.src = result.url;
                    previewFrame.style.display = 'block';
                    
                    // 選択状態を更新
                    selectedGrammarKey = grammarKey;
                    document.getElementById('selectedPageInfo').style.display = 'block';
                    document.getElementById('selectedPageName').textContent = result.displayName;
                    document.getElementById('generateSelectedBtn').disabled = false;
                    
                    logMessage(`✅ プレビュー生成完了: ${result.displayName}`, 'success');
                } else {
                    logMessage('❌ プレビュー生成に失敗しました', 'error');
                }
                
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`プレビューエラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // 選択されたページの個別生成
        async function generateSelectedPage() {
            if (!selectedGrammarKey) {
                logMessage('❌ 生成対象ページが選択されていません', 'error');
                return;
            }

            updateSystemStatus('working');
            const pageData = currentMetadata[selectedGrammarKey];
            logMessage(`個別ページ生成開始: ${pageData.displayName}`, 'info');
            
            try {
                const template = await generator.loadTemplate();
                const html = generator.generatePage(template, pageData);
                
                // 生成されたHTMLをダウンロード可能にする
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${pageData.filename}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logMessage(`✅ ${pageData.displayName} 生成完了・ダウンロード開始`, 'success');
                logMessage(`📁 ファイル名: ${pageData.filename}.html`, 'info');
                updateSystemStatus('ready');
                
            } catch (error) {
                logMessage(`個別生成エラー: ${error.message}`, 'error');
                updateSystemStatus('error');
            }
        }

        // プレビュー閉じる
        function closePreview() {
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.style.display = 'none';
            previewFrame.src = '';
            
            // 選択状態をリセット
            selectedGrammarKey = null;
            document.getElementById('selectedPageInfo').style.display = 'none';
            document.getElementById('generateSelectedBtn').disabled = true;
            
            logMessage('プレビューを閉じました', 'info');
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('管理パネル起動中...', 'info');
            initializeSystem();
        });
    </script>
</body>
</html>
