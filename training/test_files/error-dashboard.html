<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rephrase - エラー監視ダッシュボード</title>
    
    <!-- セキュリティヘッダー -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b35;
        }

        .severity-stats {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .severity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .severity-item:last-child {
            border-bottom: none;
        }

        .severity-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .severity-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .severity-critical { background: #d32f2f; }
        .severity-high { background: #f57c00; }
        .severity-medium { background: #1976d2; }
        .severity-low { background: #388e3c; }

        .error-log {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-filters {
            display: flex;
            gap: 10px;
        }

        .filter-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .log-entry {
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .log-entry-header {
            background: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .log-entry-header:hover {
            background: #e9ecef;
        }

        .log-entry-content {
            padding: 15px;
            display: none;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .log-entry.expanded .log-entry-content {
            display: block;
        }

        .log-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        .log-message {
            font-weight: bold;
            color: #333;
        }

        .log-details {
            margin-top: 10px;
        }

        .log-detail-item {
            margin-bottom: 8px;
        }

        .log-detail-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 100px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a2b;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        .no-errors {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 16px;
        }

        .error-chart {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .chart-container {
            height: 200px;
            display: flex;
            align-items: end;
            justify-content: space-around;
            border-bottom: 2px solid #eee;
            padding: 10px 0;
        }

        .chart-bar {
            width: 40px;
            background: linear-gradient(to top, #ff6b35, #f7931e);
            border-radius: 3px 3px 0 0;
            position: relative;
        }

        .chart-label {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .export-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚠️ エラー監視ダッシュボード</h1>
            <p>システムエラーとセキュリティインシデントの監視・分析</p>
        </div>

        <!-- 統計カード -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>📊 総エラー数</h3>
                <div class="stat-value" id="total-errors">0</div>
            </div>
            <div class="stat-card">
                <h3>🚨 重要エラー</h3>
                <div class="stat-value" id="critical-errors">0</div>
            </div>
            <div class="stat-card">
                <h3>📈 今日のエラー</h3>
                <div class="stat-value" id="today-errors">0</div>
            </div>
            <div class="stat-card">
                <h3>🛡️ システム状態</h3>
                <div class="stat-value" id="system-health" style="font-size: 18px;">良好</div>
            </div>
        </div>

        <!-- 重要度別統計 -->
        <div class="severity-stats">
            <h3>🎯 重要度別エラー</h3>
            <div id="severity-breakdown">
                <!-- 動的生成 -->
            </div>
        </div>

        <!-- エラーチャート -->
        <div class="error-chart">
            <h3>📈 時系列エラー分析</h3>
            <div class="chart-container" id="error-chart">
                <!-- 動的生成 -->
            </div>
        </div>

        <!-- 制御パネル -->
        <div class="controls">
            <h3>🎛️ 制御パネル</h3>
            <button class="btn btn-primary" onclick="refreshDashboard()">🔄 更新</button>
            <button class="btn btn-secondary" onclick="testError()">⚡ テストエラー</button>
            <button class="btn btn-danger" onclick="clearErrorLog()">🗑️ ログクリア</button>
            <button class="btn btn-secondary" onclick="exportLog()">💾 ログ出力</button>
            
            <div class="auto-refresh">
                <label>
                    <input type="checkbox" id="auto-refresh" checked> 自動更新（10秒間隔）
                </label>
            </div>
        </div>

        <!-- エラーログ -->
        <div class="error-log">
            <div class="log-header">
                <h3>📝 エラーログ</h3>
                <div class="log-filters">
                    <select class="filter-select" id="severity-filter">
                        <option value="">全重要度</option>
                        <option value="critical">重要</option>
                        <option value="high">高</option>
                        <option value="medium">中</option>
                        <option value="low">低</option>
                    </select>
                    <select class="filter-select" id="type-filter">
                        <option value="">全タイプ</option>
                        <option value="javascript">JavaScript</option>
                        <option value="promise">Promise</option>
                        <option value="application">Application</option>
                        <option value="console">Console</option>
                    </select>
                </div>
            </div>
            <div id="error-log-content">
                <!-- 動的生成 -->
            </div>
        </div>

        <!-- エクスポートセクション -->
        <div class="export-section">
            <h3>📤 データエクスポート</h3>
            <p>エラーログをJSON形式でエクスポートできます。（開発環境のみ）</p>
            <button class="btn btn-secondary" onclick="exportFullLog()">📋 完全ログ出力</button>
            <button class="btn btn-secondary" onclick="exportStats()">📊 統計データ出力</button>
        </div>

        <div class="refresh-info">
            <p>⏱️ 最終更新: <span id="last-update">--</span></p>
        </div>
    </div>

    <!-- エラー詳細モーダル -->
    <div id="error-detail-modal" class="modal">
        <div class="modal-content">
            <h3>🔍 エラー詳細</h3>
            <div id="modal-content">
                <!-- 動的生成 -->
            </div>
            <button class="btn btn-primary" onclick="closeModal()">閉じる</button>
        </div>
    </div>

    <!-- エラーハンドリングシステム読み込み -->
    <script src="./js/error-handler.js"></script>
    
    <script>
        let updateInterval;
        let filteredErrors = [];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            setupFilters();
            startAutoUpdate();
        });

        function initDashboard() {
            console.log('📊 エラー監視ダッシュボード初期化');
            refreshDashboard();
        }

        function setupFilters() {
            const severityFilter = document.getElementById('severity-filter');
            const typeFilter = document.getElementById('type-filter');

            severityFilter.addEventListener('change', filterErrors);
            typeFilter.addEventListener('change', filterErrors);
        }

        function startAutoUpdate() {
            const autoRefreshCheck = document.getElementById('auto-refresh');
            
            function updateIfEnabled() {
                if (autoRefreshCheck.checked) {
                    refreshDashboard();
                }
            }

            updateInterval = setInterval(updateIfEnabled, 10000); // 10秒ごと

            autoRefreshCheck.addEventListener('change', function() {
                if (this.checked) {
                    updateIfEnabled();
                } else {
                    console.log('⏸️ 自動更新を停止');
                }
            });
        }

        function refreshDashboard() {
            if (!window.errorHandler) {
                console.warn('⚠️ エラーハンドリングシステムが見つかりません');
                return;
            }

            try {
                updateStats();
                updateSeverityBreakdown();
                updateErrorChart();
                updateErrorLog();
                updateLastUpdateTime();
                console.log('✅ ダッシュボード更新完了');
            } catch (error) {
                console.error('❌ ダッシュボード更新エラー:', error);
            }
        }

        function updateStats() {
            const stats = window.errorHandler.getErrorStats();
            const errorLog = window.errorHandler.getErrorLog(1000);
            
            // 今日のエラー数を計算
            const today = new Date().toDateString();
            const todayErrors = errorLog.filter(entry => 
                new Date(entry.timestamp).toDateString() === today
            ).length;

            document.getElementById('total-errors').textContent = stats.total;
            document.getElementById('critical-errors').textContent = stats.bySeverity.critical || 0;
            document.getElementById('today-errors').textContent = todayErrors;

            // システム健全性の判定
            let health = '良好';
            let healthColor = '#388e3c';
            
            const criticalCount = stats.bySeverity.critical || 0;
            if (criticalCount > 5) {
                health = '警告';
                healthColor = '#f57c00';
            }
            if (criticalCount > 10) {
                health = '危険';
                healthColor = '#d32f2f';
            }

            const healthElement = document.getElementById('system-health');
            healthElement.textContent = health;
            healthElement.style.color = healthColor;
        }

        function updateSeverityBreakdown() {
            const stats = window.errorHandler.getErrorStats();
            const container = document.getElementById('severity-breakdown');
            
            const severities = [
                { key: 'critical', label: '重要', icon: 'severity-critical' },
                { key: 'high', label: '高', icon: 'severity-high' },
                { key: 'medium', label: '中', icon: 'severity-medium' },
                { key: 'low', label: '低', icon: 'severity-low' }
            ];

            let html = '';
            severities.forEach(severity => {
                const count = stats.bySeverity[severity.key] || 0;
                html += `
                    <div class="severity-item">
                        <div class="severity-label">
                            <div class="severity-icon ${severity.icon}"></div>
                            <span>${severity.label}</span>
                        </div>
                        <span>${count}件</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateErrorChart() {
            const errorLog = window.errorHandler.getErrorLog(1000);
            const container = document.getElementById('error-chart');
            
            // 過去7日間の日別エラー数を集計
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date.toDateString(),
                    label: date.getMonth() + 1 + '/' + date.getDate(),
                    count: 0
                });
            }

            errorLog.forEach(entry => {
                const entryDate = new Date(entry.timestamp).toDateString();
                const day = days.find(d => d.date === entryDate);
                if (day) day.count++;
            });

            const maxCount = Math.max(...days.map(d => d.count), 1);
            
            let html = '';
            days.forEach(day => {
                const height = (day.count / maxCount) * 180;
                html += `
                    <div>
                        <div class="chart-bar" style="height: ${height}px;" title="${day.count}件"></div>
                        <div class="chart-label">${day.label}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateErrorLog() {
            const errorLog = window.errorHandler.getErrorLog(50);
            filterErrors();
        }

        function filterErrors() {
            const errorLog = window.errorHandler.getErrorLog(50);
            const severityFilter = document.getElementById('severity-filter').value;
            const typeFilter = document.getElementById('type-filter').value;

            filteredErrors = errorLog.filter(entry => {
                const severityMatch = !severityFilter || entry.severity === severityFilter;
                const typeMatch = !typeFilter || entry.type === typeFilter;
                return severityMatch && typeMatch;
            });

            displayFilteredErrors();
        }

        function displayFilteredErrors() {
            const container = document.getElementById('error-log-content');
            
            if (filteredErrors.length === 0) {
                container.innerHTML = '<div class="no-errors">📋 エラーがありません</div>';
                return;
            }

            let html = '';
            filteredErrors.forEach(entry => {
                const timestamp = new Date(entry.timestamp).toLocaleString();
                html += `
                    <div class="log-entry" data-error-id="${entry.id}">
                        <div class="log-entry-header" onclick="toggleLogEntry('${entry.id}')">
                            <div>
                                <div class="log-message">${escapeHtml(entry.message)}</div>
                                <div class="log-meta">
                                    <span>🕒 ${timestamp}</span>
                                    <span>⚡ ${entry.type}</span>
                                    <span>🎯 ${entry.severity}</span>
                                </div>
                            </div>
                            <div>👁️</div>
                        </div>
                        <div class="log-entry-content">
                            <div class="log-details">
                                <div class="log-detail-item">
                                    <span class="log-detail-label">ID:</span>
                                    <span>${entry.id}</span>
                                </div>
                                <div class="log-detail-item">
                                    <span class="log-detail-label">タイプ:</span>
                                    <span>${entry.type}</span>
                                </div>
                                <div class="log-detail-item">
                                    <span class="log-detail-label">重要度:</span>
                                    <span>${entry.severity}</span>
                                </div>
                                <div class="log-detail-item">
                                    <span class="log-detail-label">URL:</span>
                                    <span>${escapeHtml(entry.url || 'N/A')}</span>
                                </div>
                                ${entry.context ? `
                                <div class="log-detail-item">
                                    <span class="log-detail-label">コンテキスト:</span>
                                    <pre style="background: #f5f5f5; padding: 10px; margin-top: 5px; border-radius: 3px; font-size: 12px;">${escapeHtml(JSON.stringify(entry.context, null, 2))}</pre>
                                </div>
                                ` : ''}
                                ${entry.stack ? `
                                <div class="log-detail-item">
                                    <span class="log-detail-label">スタック:</span>
                                    <pre style="background: #f5f5f5; padding: 10px; margin-top: 5px; border-radius: 3px; font-size: 12px;">${escapeHtml(entry.stack)}</pre>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleLogEntry(errorId) {
            const entry = document.querySelector(`[data-error-id="${errorId}"]`);
            if (entry) {
                entry.classList.toggle('expanded');
            }
        }

        function testError() {
            if (window.errorHandler) {
                // テスト用エラーを生成
                const testErrors = [
                    new Error('テスト用JavaScript エラー'),
                    new Error('テスト用ネットワークエラー: connection failed'),
                    new Error('テスト用認証エラー: permission denied'),
                    new Error('テスト用データエラー: validation failed')
                ];

                const randomError = testErrors[Math.floor(Math.random() * testErrors.length)];
                window.errorHandler.handleError(randomError, { source: 'test', timestamp: Date.now() });
                
                alert('テストエラーを生成しました');
                setTimeout(refreshDashboard, 100);
            }
        }

        function clearErrorLog() {
            if (confirm('エラーログを全て削除しますか？')) {
                window.errorHandler.clearErrorLog();
                refreshDashboard();
            }
        }

        function exportLog() {
            const errorLog = window.errorHandler.getErrorLog(20);
            const dataStr = JSON.stringify(errorLog, null, 2);
            downloadData(dataStr, 'error-log.json');
        }

        function exportFullLog() {
            const errorLog = window.errorHandler.getErrorLog(1000);
            const dataStr = JSON.stringify(errorLog, null, 2);
            downloadData(dataStr, 'full-error-log.json');
        }

        function exportStats() {
            const stats = window.errorHandler.getErrorStats();
            const dataStr = JSON.stringify(stats, null, 2);
            downloadData(dataStr, 'error-stats.json');
        }

        function downloadData(dataStr, filename) {
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeModal() {
            document.getElementById('error-detail-modal').style.display = 'none';
        }

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
